(function(){'use strict';function ne(a){return {0:"INVALIDATE_TILES",1:"INVALIDATE_VISIBLE_CURSOR",2:"TEXT_SELECTION",3:"TEXT_SELECTION_START",4:"TEXT_SELECTION_END",5:"CURSOR_VISIBLE",6:"GRAPHIC_SELECTION",7:"HYPERLINK_CLICKED",8:"STATE_CHANGED",9:"STATUS_INDICATOR_START",10:"STATUS_INDICATOR_SET_VALUE",11:"STATUS_INDICATOR_FINISH",12:"SEARCH_NOT_FOUND",13:"DOCUMENT_SIZE_CHANGED",14:"SET_PART",15:"SEARCH_RESULT_SELECTION",16:"UNO_COMMAND_RESULT",17:"CELL_CURSOR",18:"MOUSE_POINTER",19:"CELL_FORMULA",20:"DOCUMENT_PASSWORD",21:"DOCUMENT_PASSWORD_TO_MODIFY",22:"CONTEXT_MENU",23:"INVALIDATE_VIEW_CURSOR",24:"TEXT_VIEW_SELECTION",25:"CELL_VIEW_CURSOR",26:"GRAPHIC_VIEW_SELECTION",27:"VIEW_CURSOR_VISIBLE",28:"VIEW_LOCK",29:"REDLINE_TABLE_SIZE_CHANGED",30:"REDLINE_TABLE_ENTRY_MODIFIED",31:"COMMENT",32:"INVALIDATE_HEADER",33:"CELL_ADDRESS"}[a]||`UNKNOWN(${a})`}var G={nSize:0,destroy:4,documentLoad:8,getError:12,documentLoadWithOptions:16,freeError:20},X={nSize:0,destroy:4,saveAs:8},se=new TextEncoder,Y=new TextDecoder,B=class{module;lokPtr=0;verbose;useShims;constructor(e,t=false){this.module=e,this.verbose=t,this.useShims=typeof this.module._lok_documentLoad=="function",this.useShims?this.log("Using direct LOK shim exports"):this.log("Using vtable traversal (shims not available)");}log(...e){this.verbose&&console.log("[LOK]",...e);}get HEAPU8(){return this.module.HEAPU8}get HEAPU32(){return this.module.HEAPU32}get HEAP32(){return this.module.HEAP32}allocString(e){let t=se.encode(e+"\0"),r=this.module._malloc(t.length);return this.HEAPU8.set(t,r),r}readString(e){if(e===0)return null;let t=this.HEAPU8,r=e;for(;t[r]!==0;)r++;let n=t.slice(e,r);return Y.decode(n)}readPtr(e){return this.HEAPU32[e>>2]||0}getFunc(e){return this.module.wasmTable.get(e)}initialize(e="/instdir/program"){this.log("Initializing with path:",e);let t=this.allocString(e);try{let r=this.module._libreofficekit_hook;if(typeof r!="function")throw new Error("libreofficekit_hook export not found on module");if(this.lokPtr=r(t),this.lokPtr===0)throw new Error("Failed to initialize LibreOfficeKit");this.log("LOK initialized, ptr:",this.lokPtr);}finally{this.module._free(t);}}getError(){if(this.lokPtr===0)return null;if(this.useShims&&this.module._lok_getError){let o=this.module._lok_getError(this.lokPtr);return this.readString(o)}let e=this.readPtr(this.lokPtr),t=this.readPtr(e+G.getError);if(t===0)return null;let n=this.getFunc(t)(this.lokPtr);return this.readString(n)}getVersionInfo(){return "LibreOffice WASM"}toFileUrl(e){return e.startsWith("file://")?e:"file://"+(e.startsWith("/")?e:"/"+e)}documentLoad(e){if(this.lokPtr===0)throw new Error("LOK not initialized");let t=this.toFileUrl(e);this.log("Loading document:",e,"->",t);let r=this.allocString(t);try{let n=Date.now(),o;if(this.useShims&&this.module._lok_documentLoad)o=this.module._lok_documentLoad(this.lokPtr,r);else {let s=this.readPtr(this.lokPtr),i=this.readPtr(s+G.documentLoad);o=this.getFunc(i)(this.lokPtr,r);}if(this.log("Document loaded in",Date.now()-n,"ms, ptr:",o),o===0){let s=this.getError();throw new Error(`Failed to load document: ${s||"unknown error"}`)}return o}finally{this.module._free(r);}}documentLoadWithOptions(e,t){if(this.lokPtr===0)throw new Error("LOK not initialized");let r=this.toFileUrl(e);this.log("Loading document with options:",e,"->",r,t);let n=this.allocString(r),o=this.allocString(t);try{let s;if(this.useShims&&this.module._lok_documentLoadWithOptions)s=this.module._lok_documentLoadWithOptions(this.lokPtr,n,o);else {let i=this.readPtr(this.lokPtr),c=this.readPtr(i+G.documentLoadWithOptions);if(c===0)return this.documentLoad(e);s=this.getFunc(c)(this.lokPtr,n,o);}if(s===0){let i=this.getError();throw new Error(`Failed to load document: ${i||"unknown error"}`)}return this.log("Document loaded, ptr:",s),s}finally{this.module._free(n),this.module._free(o);}}documentSaveAs(e,t,r,n=""){if(e===0)throw new Error("Invalid document pointer");let o=this.toFileUrl(t);this.log("Saving document to:",t,"->",o,"format:",r);let s=this.allocString(o),i=this.allocString(r),c=this.allocString(n);try{let d;if(this.useShims&&this.module._lok_documentSaveAs)d=this.module._lok_documentSaveAs(e,s,i,c);else {let h=this.readPtr(e),m=this.readPtr(h+X.saveAs);d=this.getFunc(m)(e,s,i,c);}if(this.log("Save result:",d),d===0)throw new Error("Failed to save document")}finally{this.module._free(s),this.module._free(i),this.module._free(c);}}documentDestroy(e){if(e===0)return;if(this.useShims&&this.module._lok_documentDestroy){this.module._lok_documentDestroy(e),this.log("Document destroyed (via shim)");return}let t=this.readPtr(e),r=this.readPtr(t+X.destroy);r!==0&&(this.getFunc(r)(e),this.log("Document destroyed (via vtable)"));}destroy(){if(this.lokPtr!==0){try{if(this.useShims&&this.module._lok_destroy)this.module._lok_destroy(this.lokPtr),this.log("LOK destroyed (via shim)");else {let e=this.readPtr(this.lokPtr),t=this.readPtr(e+G.destroy);t!==0&&(this.getFunc(t)(this.lokPtr),this.log("LOK destroyed (via vtable)"));}}catch(e){this.log("LOK destroy error (ignored):",e);}this.lokPtr=0;}}isInitialized(){return this.lokPtr!==0}isUsingShims(){return this.useShims}documentGetParts(e){if(e===0)throw new Error("Invalid document pointer");return this.useShims&&this.module._lok_documentGetParts?this.module._lok_documentGetParts(e):(this.log("documentGetParts: shim not available"),0)}documentGetPart(e){if(e===0)throw new Error("Invalid document pointer");return this.useShims&&this.module._lok_documentGetPart?this.module._lok_documentGetPart(e):(this.log("documentGetPart: shim not available"),0)}documentSetPart(e,t){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentSetPart){this.module._lok_documentSetPart(e,t);return}this.log("documentSetPart: shim not available");}documentGetDocumentType(e){if(e===0)throw new Error("Invalid document pointer");return this.useShims&&this.module._lok_documentGetDocumentType?this.module._lok_documentGetDocumentType(e):(this.log("documentGetDocumentType: shim not available"),0)}documentGetDocumentSize(e){if(this.log(`documentGetDocumentSize called with docPtr: ${e}`),e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentGetDocumentSize){let t=this.module._malloc(8);try{this.module._lok_documentGetDocumentSize(e,t,t+4);let r=this.HEAP32[t>>2]??0,n=this.HEAP32[t+4>>2]??0;return this.log(`documentGetDocumentSize: ${r}x${n} twips`),{width:r,height:n}}finally{this.module._free(t);}}return this.log("documentGetDocumentSize: shim not available"),{width:0,height:0}}documentInitializeForRendering(e,t=""){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentInitializeForRendering){let r=this.allocString(t);try{this.module._lok_documentInitializeForRendering(e,r);}finally{this.module._free(r);}return}this.log("documentInitializeForRendering: shim not available");}documentPaintTile(e,t,r,n,o,s,i){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentPaintTile){let c=t*r*4,d=this.module._malloc(c);if(d===0)throw new Error(`Failed to allocate ${c} bytes for tile buffer`);try{this.module._lok_documentPaintTile(e,d,t,r,n,o,s,i);let h=new Uint8Array(c);return h.set(this.HEAPU8.subarray(d,d+c)),h}finally{this.module._free(d);}}return this.log("documentPaintTile: shim not available"),new Uint8Array(0)}documentGetTileMode(e){if(e===0)throw new Error("Invalid document pointer");return this.useShims&&this.module._lok_documentGetTileMode?this.module._lok_documentGetTileMode(e):(this.log("documentGetTileMode: shim not available"),0)}renderPage(e,t,r,n=0){this.documentInitializeForRendering(e);let o=this.documentGetDocumentType(e);if(o===2||o===3){console.log(`[LOK] Setting part to ${t} for presentation/drawing`),this.documentSetPart(e,t);let _=this.documentGetPart(e);console.log(`[LOK] Current part after setPart: ${_}`);}let s=this.documentGetDocumentSize(e);if(this.log("Document size (twips):",s),s.width===0||s.height===0)throw new Error("Failed to get document size");let i=0,c=0,d=s.width,h=s.height;if(o===0||o===1){let _=this.getPartPageRectangles(e);if(_){let E=this.parsePageRectangles(_)[t];E&&(i=E.x,c=E.y,d=E.width,h=E.height,this.log(`Page ${t} rectangle:`,E));}}let m=h/d,u=r,g=n>0?n:Math.round(r*m);console.log(`[LOK] Calling paintTile: ${u}x${g} from tile pos (${i}, ${c}) size (${d}x${h})`);let y=this.documentPaintTile(e,u,g,i,c,d,h);return console.log(`[LOK] paintTile returned ${y.length} bytes`),{data:y,width:u,height:g}}getTextSelection(e,t="text/plain;charset=utf-8"){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentGetTextSelection){let r=this.allocString(t),n=this.module._malloc(4);try{let o=this.module._lok_documentGetTextSelection(e,r,n);if(o===0)return null;let s=this.readString(o);return this.module._free(o),s}finally{this.module._free(r),this.module._free(n);}}return this.log("getTextSelection: shim not available"),null}setTextSelection(e,t,r,n){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentSetTextSelection){this.module._lok_documentSetTextSelection(e,t,r,n);return}this.log("setTextSelection: shim not available");}getSelectionType(e){if(e===0)throw new Error("Invalid document pointer");return this.useShims&&this.module._lok_documentGetSelectionType?this.module._lok_documentGetSelectionType(e):(this.log("getSelectionType: shim not available"),0)}resetSelection(e){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentResetSelection){this.module._lok_documentResetSelection(e);return}this.log("resetSelection: shim not available");}postMouseEvent(e,t,r,n,o=1,s=1,i=0){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentPostMouseEvent){this.module._lok_documentPostMouseEvent(e,t,r,n,o,s,i);return}this.log("postMouseEvent: shim not available");}postKeyEvent(e,t,r,n){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentPostKeyEvent){this.module._lok_documentPostKeyEvent(e,t,r,n);return}this.log("postKeyEvent: shim not available");}postUnoCommand(e,t,r="{}",n=false){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentPostUnoCommand){let o=this.allocString(t),s=this.allocString(r);try{this.module._lok_documentPostUnoCommand(e,o,s,n?1:0);}finally{this.module._free(o),this.module._free(s);}return}this.log("postUnoCommand: shim not available");}getCommandValues(e,t){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentGetCommandValues){let r=this.allocString(t);try{let n=this.module._lok_documentGetCommandValues(e,r);if(n===0)return null;let o=this.readString(n);return this.module._free(n),o}finally{this.module._free(r);}}return this.log("getCommandValues: shim not available"),null}getPartPageRectangles(e){if(this.log(`getPartPageRectangles called with docPtr: ${e}`),e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentGetPartPageRectangles){this.log("getPartPageRectangles: using shim");let t=this.module._lok_documentGetPartPageRectangles(e);if(this.log(`getPartPageRectangles: resultPtr=${t}`),t===0)return null;let r=this.readString(t);return this.log(`getPartPageRectangles: result="${r?.slice(0,100)}..."`),this.module._free(t),r}return this.log("getPartPageRectangles: shim not available"),null}getPartInfo(e,t){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentGetPartInfo){let r=this.module._lok_documentGetPartInfo(e,t);if(r===0)return null;let n=this.readString(r);return this.module._free(r),n}return this.log("getPartInfo: shim not available"),null}getPartName(e,t){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentGetPartName){let r=this.module._lok_documentGetPartName(e,t);if(r===0)return null;let n=this.readString(r);return this.module._free(r),n}return this.log("getPartName: shim not available"),null}paste(e,t,r){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentPaste){let n=this.allocString(t),o,s;if(typeof r=="string"){let i=new TextEncoder().encode(r);s=i.length,o=this.module._malloc(s),this.HEAPU8.set(i,o);}else s=r.length,o=this.module._malloc(s),this.HEAPU8.set(r,o);try{return this.module._lok_documentPaste(e,n,o,s)!==0}finally{this.module._free(n),this.module._free(o);}}return this.log("paste: shim not available"),false}setClientZoom(e,t,r,n,o){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentSetClientZoom){this.module._lok_documentSetClientZoom(e,t,r,n,o);return}this.log("setClientZoom: shim not available");}setClientVisibleArea(e,t,r,n,o){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentSetClientVisibleArea){this.module._lok_documentSetClientVisibleArea(e,t,r,n,o);return}this.log("setClientVisibleArea: shim not available");}getA11yFocusedParagraph(e){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentGetA11yFocusedParagraph){let t=this.module._lok_documentGetA11yFocusedParagraph(e);if(t===0)return null;let r=this.readString(t);return this.module._free(t),r}return this.log("getA11yFocusedParagraph: shim not available"),null}getA11yCaretPosition(e){if(e===0)throw new Error("Invalid document pointer");return this.useShims&&this.module._lok_documentGetA11yCaretPosition?this.module._lok_documentGetA11yCaretPosition(e):(this.log("getA11yCaretPosition: shim not available"),-1)}setAccessibilityState(e,t,r){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentSetAccessibilityState){this.module._lok_documentSetAccessibilityState(e,t,r?1:0);return}this.log("setAccessibilityState: shim not available");}getDataArea(e,t){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentGetDataArea){let r=this.module._malloc(8),n=this.module._malloc(8);try{this.module._lok_documentGetDataArea(e,t,r,n);let o=this.HEAP32[r>>2]??0,s=this.HEAP32[n>>2]??0;return {col:o,row:s}}finally{this.module._free(r),this.module._free(n);}}return this.log("getDataArea: shim not available"),{col:0,row:0}}getEditMode(e){if(e===0)throw new Error("Invalid document pointer");return this.useShims&&this.module._lok_documentGetEditMode?this.module._lok_documentGetEditMode(e):(this.log("getEditMode: shim not available"),0)}setEditMode(e,t){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentSetEditMode){this.log(`setEditMode: setting mode to ${t}`),this.module._lok_documentSetEditMode(e,t);return}this.log("setEditMode: shim not available");}createView(e){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentCreateView){let t=this.module._lok_documentCreateView(e);return this.log(`createView: created view ${t}`),t}return this.log("createView: shim not available"),-1}createViewWithOptions(e,t){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentCreateViewWithOptions){let r=this.allocString(t);try{let n=this.module._lok_documentCreateViewWithOptions(e,r);return this.log(`createViewWithOptions: created view ${n}`),n}finally{this.module._free(r);}}return this.log("createViewWithOptions: shim not available"),-1}destroyView(e,t){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentDestroyView){this.log(`destroyView: destroying view ${t}`),this.module._lok_documentDestroyView(e,t);return}this.log("destroyView: shim not available");}setView(e,t){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentSetView){this.log(`setView: setting active view to ${t}`),this.module._lok_documentSetView(e,t);return}this.log("setView: shim not available");}getView(e){if(e===0)throw new Error("Invalid document pointer");return this.useShims&&this.module._lok_documentGetView?this.module._lok_documentGetView(e):(this.log("getView: shim not available"),-1)}getViewsCount(e){if(e===0)throw new Error("Invalid document pointer");return this.useShims&&this.module._lok_documentGetViewsCount?this.module._lok_documentGetViewsCount(e):(this.log("getViewsCount: shim not available"),0)}enableSyncEvents(){this.useShims&&this.module._lok_enableSyncEvents?(this.module._lok_enableSyncEvents(),this.log("enableSyncEvents: Unipoll mode enabled")):this.log("enableSyncEvents: shim not available");}disableSyncEvents(){this.useShims&&this.module._lok_disableSyncEvents?(this.module._lok_disableSyncEvents(),this.log("disableSyncEvents: Unipoll mode disabled")):this.log("disableSyncEvents: shim not available");}registerCallback(e){if(e===0)throw new Error("Invalid document pointer");this.useShims&&this.module._lok_documentRegisterCallback?(this.module._lok_documentRegisterCallback(e),this.log("registerCallback: callback registered")):this.log("registerCallback: shim not available");}unregisterCallback(e){if(e===0)throw new Error("Invalid document pointer");this.useShims&&this.module._lok_documentUnregisterCallback?(this.module._lok_documentUnregisterCallback(e),this.log("unregisterCallback: callback unregistered")):this.log("unregisterCallback: shim not available");}hasCallbackEvents(){return this.useShims&&this.module._lok_hasCallbackEvents?this.module._lok_hasCallbackEvents()!==0:false}getCallbackEventCount(){return this.useShims&&this.module._lok_getCallbackEventCount?this.module._lok_getCallbackEventCount():0}pollCallback(){if(!this.useShims||!this.module._lok_pollCallback)return null;let e=4096,t=this.module._malloc(e),r=this.module._malloc(4);try{let n=this.module._lok_pollCallback(t,e,r);if(n===-1)return null;let o=this.module.HEAP32[r>>2]??0,s="";if(o>0){let i=Math.min(o,e-1),c=this.module.HEAPU8.slice(t,t+i);s=Y.decode(c);}return {type:n,typeName:ne(n),payload:s}}finally{this.module._free(t),this.module._free(r);}}pollAllCallbacks(){let e=[],t=this.pollCallback();for(;t!==null;)e.push(t),t=this.pollCallback();return e}clearCallbackQueue(){this.useShims&&this.module._lok_clearCallbackQueue&&(this.module._lok_clearCallbackQueue(),this.log("clearCallbackQueue: queue cleared"));}flushCallbacks(e){if(e===0)throw new Error("Invalid document pointer");let t=!!this.module._lok_flushCallbacks;this.log(`flushCallbacks: useShims=${this.useShims}, _lok_flushCallbacks exists=${t}`),this.useShims&&this.module._lok_flushCallbacks?(this.module._lok_flushCallbacks(e),this.log("flushCallbacks: callbacks flushed")):this.log("flushCallbacks: shim not available");}pollStateChanges(){let e=new Map,t=this.pollAllCallbacks();for(let r of t)if(r.type===8){let n=r.payload.indexOf("=");if(n!==-1){let o=r.payload.substring(0,n),s=r.payload.substring(n+1);e.set(o,s);}else e.set(r.payload,"");}return e}clickAndGetText(e,t,r){return this.postMouseEvent(e,0,t,r,1,1,0),this.postMouseEvent(e,1,t,r,1,1,0),this.getTextSelection(e,"text/plain")}doubleClickAndGetWord(e,t,r){return this.postMouseEvent(e,0,t,r,2,1,0),this.postMouseEvent(e,1,t,r,2,1,0),this.getTextSelection(e,"text/plain")}selectAll(e){this.postUnoCommand(e,".uno:SelectAll");}getAllText(e){this.log(`getAllText called with docPtr: ${e}`),this.selectAll(e);let t=this.getTextSelection(e,"text/plain");return this.log(`getAllText: text="${t?.slice(0,100)}..."`),this.resetSelection(e),t}parsePageRectangles(e){return e?e.split(";").filter(t=>t.trim()).map(t=>{let r=t.split(",").map(Number);return {x:r[0]??0,y:r[1]??0,width:r[2]??0,height:r[3]??0}}):[]}};var j={pdf:"pdf",docx:"docx",doc:"doc",odt:"odt",rtf:"rtf",txt:"txt",html:"html",xlsx:"xlsx",xls:"xls",ods:"ods",csv:"csv",pptx:"pptx",ppt:"ppt",odp:"odp",png:"png",jpg:"jpg",svg:"svg"},J={pdf:"",csv:"44,34,76,1,,0,false,true,false,false,false,-1",txt:"UTF8"};var x=class{lok;docPtr;options;inputPath="";constructor(e,t,r={}){this.lok=e,this.docPtr=t,this.options={maxResponseChars:r.maxResponseChars??8e3,...r};}getDocPtr(){return this.docPtr}getLokBindings(){return this.lok}save(){try{return this.inputPath?(this.lok.postUnoCommand(this.docPtr,".uno:Save"),this.createResult({path:this.inputPath})):this.createErrorResult("No input path set","Use saveAs() to specify a path")}catch(e){return this.createErrorResult(`Save failed: ${e}`)}}saveAs(e,t){try{return this.lok.documentSaveAs(this.docPtr,e,t,""),this.createResult({path:e})}catch(r){return this.createErrorResult(`SaveAs failed: ${r}`)}}close(){try{return this.lok.documentDestroy(this.docPtr),this.docPtr=0,this.createResult(void 0)}catch(e){return this.createErrorResult(`Close failed: ${e}`)}}getEditMode(){return this.lok.getEditMode(this.docPtr)}enableEditMode(){try{if(this.lok.getEditMode(this.docPtr)===1)return this.createResult({editMode:1});this.lok.postUnoCommand(this.docPtr,".uno:Edit");let t=this.lok.getEditMode(this.docPtr);return {success:!0,verified:t===1,data:{editMode:t}}}catch(e){return this.createErrorResult(`Failed to enable edit mode: ${e}`)}}undo(){try{return this.lok.postUnoCommand(this.docPtr,".uno:Undo"),this.createResult(void 0)}catch(e){return this.createErrorResult(`Undo failed: ${e}`)}}redo(){try{return this.lok.postUnoCommand(this.docPtr,".uno:Redo"),this.createResult(void 0)}catch(e){return this.createErrorResult(`Redo failed: ${e}`)}}find(e,t){try{let r=JSON.stringify({"SearchItem.SearchString":{type:"string",value:e},"SearchItem.Backward":{type:"boolean",value:!1},"SearchItem.SearchAll":{type:"boolean",value:!0},"SearchItem.MatchCase":{type:"boolean",value:t?.caseSensitive??!1},"SearchItem.WordOnly":{type:"boolean",value:t?.wholeWord??!1}});this.lok.postUnoCommand(this.docPtr,".uno:ExecuteSearch",r);let n=this.lok.getTextSelection(this.docPtr,"text/plain"),o=n!==null&&n.length>0;return this.createResult({matches:o?1:0,firstMatch:o?{x:0,y:0}:void 0})}catch(r){return this.createErrorResult(`Find failed: ${r}`)}}findAndReplaceAll(e,t,r){try{let n=JSON.stringify({"SearchItem.SearchString":{type:"string",value:e},"SearchItem.ReplaceString":{type:"string",value:t},"SearchItem.Command":{type:"long",value:3},"SearchItem.MatchCase":{type:"boolean",value:r?.caseSensitive??!1},"SearchItem.WordOnly":{type:"boolean",value:r?.wholeWord??!1}});return this.lok.postUnoCommand(this.docPtr,".uno:ExecuteSearch",n),this.createResult({replacements:-1})}catch(n){return this.createErrorResult(`Replace failed: ${n}`)}}getStateChanges(){try{let e=this.lok.pollStateChanges();return this.createResult(e)}catch(e){return this.createErrorResult(`Failed to poll state changes: ${e}`)}}flushAndPollState(){try{this.lok.flushCallbacks(this.docPtr);let e=this.lok.pollStateChanges();return this.createResult(e)}catch(e){return this.createErrorResult(`Failed to flush and poll state: ${e}`)}}clearCallbackQueue(){this.lok.clearCallbackQueue();}select(e){try{let t=this.lok.getTextSelection(this.docPtr,"text/plain");return this.createResult({selected:t||""})}catch(t){return this.createErrorResult(`Select failed: ${t}`)}}getSelection(){try{let e=this.lok.getTextSelection(this.docPtr,"text/plain");return this.createResult({text:e||"",range:{type:"text",start:{paragraph:0,character:0}}})}catch(e){return this.createErrorResult(`GetSelection failed: ${e}`)}}clearSelection(){try{return this.lok.resetSelection(this.docPtr),this.createResult(void 0)}catch(e){return this.createErrorResult(`ClearSelection failed: ${e}`)}}createResult(e){return {success:true,verified:true,data:e}}createErrorResult(e,t){return {success:false,verified:false,error:e,suggestion:t}}createResultWithTruncation(e,t){return {success:true,verified:true,data:e,truncated:t}}truncateContent(e,t){let r=t??this.options.maxResponseChars,n=e.length;if(n<=r)return {content:e,truncated:false,original:n,returned:n};let o=e.slice(0,r),s=o.lastIndexOf(" ");return s>r*.8&&(o=o.slice(0,s)),{content:o,truncated:true,original:n,returned:o.length}}truncateArray(e,t,r){let n=e.length,o=0,s=0;for(let i of e){let c=r(i);if(o+c.length>t)break;o+=c.length,s++;}return {items:e.slice(0,s),truncated:s<n,original:n,returned:s}}a1ToRowCol(e){let t=e.match(/^([A-Z]+)(\d+)$/i);if(!t)throw new Error(`Invalid A1 notation: ${e}`);let r=t[1].toUpperCase(),n=t[2],o=0;for(let i=0;i<r.length;i++)o=o*26+(r.charCodeAt(i)-64);return o-=1,{row:parseInt(n,10)-1,col:o}}rowColToA1(e,t){let r="",n=t+1;for(;n>0;){let o=(n-1)%26;r=String.fromCharCode(65+o)+r,n=Math.floor((n-1)/26);}return `${r}${e+1}`}normalizeCellRef(e){return typeof e=="string"?this.a1ToRowCol(e):e}setInputPath(e){this.inputPath=e;}isOpen(){return this.docPtr!==0}};var D=class extends x{cachedParagraphs=null;getDocumentType(){return "writer"}getStructure(e){try{let t=this.getParagraphsInternal(),r=e?.maxResponseChars??this.options.maxResponseChars,n=t.map((i,c)=>({index:c,preview:i.slice(0,100)+(i.length>100?"...":""),style:"Normal",charCount:i.length})),o=this.truncateArray(n,r,i=>JSON.stringify(i)),s={type:"writer",paragraphs:o.items,pageCount:this.lok.documentGetParts(this.docPtr),wordCount:t.join(" ").split(/\s+/).filter(i=>i.length>0).length};return o.truncated?this.createResultWithTruncation(s,{original:o.original,returned:o.returned,message:`Showing ${o.returned} of ${o.original} paragraphs. Use getParagraphs(start, count) to paginate.`}):this.createResult(s)}catch(t){return this.createErrorResult(`Failed to get structure: ${t}`)}}getParagraph(e){try{let t=this.getParagraphsInternal();if(e<0||e>=t.length)return this.createErrorResult(`Paragraph index ${e} out of range (0-${t.length-1})`,"Use getStructure() to see available paragraphs");let r=t[e];return this.createResult({index:e,text:r,style:"Normal",charCount:r.length})}catch(t){return this.createErrorResult(`Failed to get paragraph: ${t}`)}}getParagraphs(e,t){try{let r=this.getParagraphsInternal();if(e<0||e>=r.length)return this.createErrorResult(`Start index ${e} out of range`,`Valid range: 0-${r.length-1}`);let n=Math.min(e+t,r.length),o=r.slice(e,n).map((s,i)=>({index:e+i,text:s,style:"Normal",charCount:s.length}));return this.createResult(o)}catch(r){return this.createErrorResult(`Failed to get paragraphs: ${r}`)}}insertParagraph(e,t){try{let r=this.getParagraphsInternal(),n=t?.afterIndex!==void 0?t.afterIndex+1:r.length;n>0&&n<=r.length&&this.lok.postUnoCommand(this.docPtr,".uno:GoToEndOfDoc"),this.lok.postUnoCommand(this.docPtr,".uno:InsertPara");let o=JSON.stringify({Text:{type:"string",value:e}});if(this.lok.postUnoCommand(this.docPtr,".uno:InsertText",o),t?.style&&t.style!=="Normal"){let d={"Heading 1":"Heading 1","Heading 2":"Heading 2","Heading 3":"Heading 3",List:"List"}[t.style];if(d){let h=JSON.stringify({Template:{type:"string",value:d},Family:{type:"short",value:2}});this.lok.postUnoCommand(this.docPtr,".uno:StyleApply",h);}}return this.cachedParagraphs=null,{success:!0,verified:this.getParagraphsInternal().length>r.length,data:{index:n}}}catch(r){return this.createErrorResult(`Failed to insert paragraph: ${r}`)}}replaceParagraph(e,t){try{let r=this.getParagraphsInternal();if(e<0||e>=r.length)return this.createErrorResult(`Paragraph index ${e} out of range`,`Valid range: 0-${r.length-1}`);let n=r[e],o=JSON.stringify({"SearchItem.SearchString":{type:"string",value:n},"SearchItem.ReplaceString":{type:"string",value:t},"SearchItem.Command":{type:"long",value:2}});return this.lok.postUnoCommand(this.docPtr,".uno:ExecuteSearch",o),this.cachedParagraphs=null,this.createResult({oldText:n})}catch(r){return this.createErrorResult(`Failed to replace paragraph: ${r}`)}}deleteParagraph(e){try{let t=this.getParagraphsInternal();if(e<0||e>=t.length)return this.createErrorResult(`Paragraph index ${e} out of range`,`Valid range: 0-${t.length-1}`);let r=t[e],n=this.replaceParagraph(e,"");return n.success?this.createResult({deletedText:r}):this.createErrorResult(n.error||"Failed to delete")}catch(t){return this.createErrorResult(`Failed to delete paragraph: ${t}`)}}insertText(e,t){try{let r=JSON.stringify({Text:{type:"string",value:e}});return this.lok.postUnoCommand(this.docPtr,".uno:InsertText",r),this.cachedParagraphs=null,this.createResult(void 0)}catch(r){return this.createErrorResult(`Failed to insert text: ${r}`)}}deleteText(e,t){try{let r=this.lok.getTextSelection(this.docPtr,"text/plain");return this.lok.postUnoCommand(this.docPtr,".uno:Delete"),this.cachedParagraphs=null,this.createResult({deleted:r||""})}catch(r){return this.createErrorResult(`Failed to delete text: ${r}`)}}replaceText(e,t,r){try{let n=r?.all?3:2,o=JSON.stringify({"SearchItem.SearchString":{type:"string",value:e},"SearchItem.ReplaceString":{type:"string",value:t},"SearchItem.Command":{type:"long",value:n}});return this.lok.postUnoCommand(this.docPtr,".uno:ExecuteSearch",o),this.cachedParagraphs=null,this.createResult({replacements:-1})}catch(n){return this.createErrorResult(`Failed to replace text: ${n}`)}}formatText(e,t){try{if(t.bold!==void 0&&this.lok.postUnoCommand(this.docPtr,".uno:Bold"),t.italic!==void 0&&this.lok.postUnoCommand(this.docPtr,".uno:Italic"),t.underline!==void 0&&this.lok.postUnoCommand(this.docPtr,".uno:Underline"),t.fontSize!==void 0){let r=JSON.stringify({FontHeight:{type:"float",value:t.fontSize}});this.lok.postUnoCommand(this.docPtr,".uno:FontHeight",r);}if(t.fontName!==void 0){let r=JSON.stringify({CharFontName:{type:"string",value:t.fontName}});this.lok.postUnoCommand(this.docPtr,".uno:CharFontName",r);}return this.createResult(void 0)}catch(r){return this.createErrorResult(`Failed to format text: ${r}`)}}getFormat(e){try{this.lok.clearCallbackQueue(),this.lok.postUnoCommand(this.docPtr,".uno:CharRightSel"),this.lok.flushCallbacks(this.docPtr),this.lok.postUnoCommand(this.docPtr,".uno:CharLeft"),this.lok.flushCallbacks(this.docPtr);let t=this.lok.pollStateChanges(),r={},n=t.get(".uno:Bold");n!==void 0&&(r.bold=n==="true");let o=t.get(".uno:Italic");o!==void 0&&(r.italic=o==="true");let s=t.get(".uno:Underline");s!==void 0&&(r.underline=s==="true");let i=t.get(".uno:FontHeight");if(i!==void 0){let d=parseFloat(i);isNaN(d)||(r.fontSize=d);}let c=t.get(".uno:CharFontName");return c!==void 0&&c.length>0&&(r.fontName=c),this.createResult(r)}catch(t){return this.createErrorResult(`Failed to get format: ${t}`)}}getSelectionFormat(){try{let e=this.lok.pollStateChanges();if(e.size===0){this.lok.clearCallbackQueue(),this.lok.postUnoCommand(this.docPtr,".uno:SelectWord"),this.lok.flushCallbacks(this.docPtr);let t=this.lok.pollStateChanges();return this.createResult(t)}return this.createResult(e)}catch(e){return this.createErrorResult(`Failed to get selection format: ${e}`)}}getParagraphsInternal(){if(this.cachedParagraphs)return this.cachedParagraphs;let e=this.lok.getAllText(this.docPtr);return e?(this.cachedParagraphs=e.split(/\n\n|\r\n\r\n/).map(t=>t.trim()).filter(t=>t.length>0),this.cachedParagraphs):[]}};var U=class extends x{getDocumentType(){return "calc"}getStructure(e){try{let t=this.lok.documentGetParts(this.docPtr),r=[];for(let o=0;o<t;o++){let s=this.lok.getPartName(this.docPtr,o)||`Sheet${o+1}`,i=this.lok.getDataArea(this.docPtr,o);r.push({index:o,name:s,usedRange:i.col>0&&i.row>0?`A1:${this.rowColToA1(i.row-1,i.col-1)}`:"A1",rowCount:i.row,colCount:i.col});}let n={type:"calc",sheets:r};return this.createResult(n)}catch(t){return this.createErrorResult(`Failed to get structure: ${t}`)}}getSheetNames(){try{let e=this.lok.documentGetParts(this.docPtr),t=[];for(let r=0;r<e;r++){let n=this.lok.getPartName(this.docPtr,r)||`Sheet${r+1}`;t.push(n);}return this.createResult(t)}catch(e){return this.createErrorResult(`Failed to get sheet names: ${e}`)}}getCell(e,t){try{this.selectSheet(t);let{row:r,col:n}=this.normalizeCellRef(e),o=this.rowColToA1(r,n);this.goToCell(o);let s=this.getCellValueInternal(),i=this.getCellFormulaInternal();return this.createResult({address:o,value:s,formula:i||void 0})}catch(r){return this.createErrorResult(`Failed to get cell: ${r}`)}}getCells(e,t,r){try{this.selectSheet(t);let{startRow:n,startCol:o,endRow:s,endCol:i}=this.normalizeRangeRef(e),c=r?.maxResponseChars??this.options.maxResponseChars,d=[],h=0,m=!1;for(let u=n;u<=s&&!m;u++){let g=[];for(let y=o;y<=i&&!m;y++){let _=this.rowColToA1(u,y);this.goToCell(_);let p=this.getCellValueInternal(),E={address:_,value:p},C=JSON.stringify(E);if(h+C.length>c){m=!0;break}h+=C.length,g.push(E);}g.length>0&&d.push(g);}return m?this.createResultWithTruncation(d,{original:(s-n+1)*(i-o+1),returned:d.reduce((u,g)=>u+g.length,0),message:"Range truncated due to size. Use smaller ranges to paginate."}):this.createResult(d)}catch(n){return this.createErrorResult(`Failed to get cells: ${n}`)}}setCellValue(e,t,r){try{this.selectSheet(r);let{row:n,col:o}=this.normalizeCellRef(e),s=this.rowColToA1(n,o);this.goToCell(s);let i=this.getCellValueInternal(),c=typeof t=="number"?t.toString():t,d=JSON.stringify({StringName:{type:"string",value:c}});this.lok.postUnoCommand(this.docPtr,".uno:EnterString",d);let h=this.getCellValueInternal(),m=typeof t=="number"?t.toString():t;return {success:!0,verified:h===m||h===t,data:{oldValue:i,newValue:h}}}catch(n){return this.createErrorResult(`Failed to set cell value: ${n}`)}}setCellFormula(e,t,r){try{this.selectSheet(r);let{row:n,col:o}=this.normalizeCellRef(e),s=this.rowColToA1(n,o);this.goToCell(s);let i=JSON.stringify({StringName:{type:"string",value:t}});this.lok.postUnoCommand(this.docPtr,".uno:EnterString",i);let c=this.getCellValueInternal();return this.createResult({calculatedValue:c})}catch(n){return this.createErrorResult(`Failed to set formula: ${n}`)}}setCells(e,t,r){try{this.selectSheet(r);let{startRow:n,startCol:o}=this.normalizeRangeRef(e),s=0;for(let i=0;i<t.length;i++){let c=t[i];if(c)for(let d=0;d<c.length;d++){let h=c[d];if(h==null)continue;let m=this.rowColToA1(n+i,o+d);this.goToCell(m);let u=typeof h=="number"?h.toString():String(h),g=JSON.stringify({StringName:{type:"string",value:u}});this.lok.postUnoCommand(this.docPtr,".uno:EnterString",g),s++;}}return this.createResult({cellsUpdated:s})}catch(n){return this.createErrorResult(`Failed to set cells: ${n}`)}}clearCell(e,t){try{this.selectSheet(t);let{row:r,col:n}=this.normalizeCellRef(e),o=this.rowColToA1(r,n);this.goToCell(o);let s=this.getCellValueInternal();return this.lok.postUnoCommand(this.docPtr,".uno:ClearContents"),this.createResult({oldValue:s})}catch(r){return this.createErrorResult(`Failed to clear cell: ${r}`)}}clearRange(e,t){try{this.selectSheet(t);let r=this.normalizeRangeToString(e);this.goToCell(r),this.lok.postUnoCommand(this.docPtr,".uno:ClearContents");let{startRow:n,startCol:o,endRow:s,endCol:i}=this.normalizeRangeRef(e),c=(s-n+1)*(i-o+1);return this.createResult({cellsCleared:c})}catch(r){return this.createErrorResult(`Failed to clear range: ${r}`)}}insertRow(e,t){try{return this.selectSheet(t),this.goToCell(this.rowColToA1(e+1,0)),this.lok.postUnoCommand(this.docPtr,".uno:InsertRows"),this.createResult(void 0)}catch(r){return this.createErrorResult(`Failed to insert row: ${r}`)}}insertColumn(e,t){try{this.selectSheet(t);let r=typeof e=="string"?this.a1ToRowCol(e+"1").col+1:e+1;return this.goToCell(this.rowColToA1(0,r)),this.lok.postUnoCommand(this.docPtr,".uno:InsertColumns"),this.createResult(void 0)}catch(r){return this.createErrorResult(`Failed to insert column: ${r}`)}}deleteRow(e,t){try{return this.selectSheet(t),this.goToCell(this.rowColToA1(e,0)),this.lok.postUnoCommand(this.docPtr,".uno:DeleteRows"),this.createResult(void 0)}catch(r){return this.createErrorResult(`Failed to delete row: ${r}`)}}deleteColumn(e,t){try{this.selectSheet(t);let r=typeof e=="string"?this.a1ToRowCol(e+"1").col:e;return this.goToCell(this.rowColToA1(0,r)),this.lok.postUnoCommand(this.docPtr,".uno:DeleteColumns"),this.createResult(void 0)}catch(r){return this.createErrorResult(`Failed to delete column: ${r}`)}}formatCells(e,t,r){try{this.selectSheet(r);let n=this.normalizeRangeToString(e);if(this.goToCell(n),t.bold!==void 0&&this.lok.postUnoCommand(this.docPtr,".uno:Bold"),t.numberFormat!==void 0){let o=JSON.stringify({NumberFormatValue:{type:"string",value:t.numberFormat}});this.lok.postUnoCommand(this.docPtr,".uno:NumberFormatValue",o);}if(t.backgroundColor!==void 0){let o=JSON.stringify({BackgroundColor:{type:"long",value:this.hexToNumber(t.backgroundColor)}});this.lok.postUnoCommand(this.docPtr,".uno:BackgroundColor",o);}return this.createResult(void 0)}catch(n){return this.createErrorResult(`Failed to format cells: ${n}`)}}addSheet(e){try{let t=JSON.stringify({Name:{type:"string",value:e}});this.lok.postUnoCommand(this.docPtr,".uno:Insert",t);let r=this.lok.documentGetParts(this.docPtr);return this.createResult({index:r-1})}catch(t){return this.createErrorResult(`Failed to add sheet: ${t}`)}}renameSheet(e,t){try{this.selectSheet(e);let r=JSON.stringify({Name:{type:"string",value:t}});return this.lok.postUnoCommand(this.docPtr,".uno:RenameTable",r),this.createResult(void 0)}catch(r){return this.createErrorResult(`Failed to rename sheet: ${r}`)}}deleteSheet(e){try{return this.selectSheet(e),this.lok.postUnoCommand(this.docPtr,".uno:Remove"),this.createResult(void 0)}catch(t){return this.createErrorResult(`Failed to delete sheet: ${t}`)}}selectSheet(e){if(e===void 0)return;let t=typeof e=="number"?e:this.getSheetIndexByName(e);t>=0&&this.lok.documentSetPart(this.docPtr,t);}getSheetIndexByName(e){let t=this.lok.documentGetParts(this.docPtr);for(let r=0;r<t;r++)if(this.lok.getPartName(this.docPtr,r)===e)return r;return  -1}goToCell(e){let t=JSON.stringify({ToPoint:{type:"string",value:e}});this.lok.postUnoCommand(this.docPtr,".uno:GoToCell",t);}getCellValueInternal(){let e=this.lok.getTextSelection(this.docPtr,"text/plain");if(!e)return null;let t=parseFloat(e);return !isNaN(t)&&e.trim()===t.toString()?t:e.toLowerCase()==="true"?true:e.toLowerCase()==="false"?false:e}getCellFormulaInternal(){let e=this.lok.getCommandValues(this.docPtr,".uno:GetFormulaBarText");if(!e)return null;try{return JSON.parse(e).value||null}catch{return null}}normalizeRangeRef(e){if(typeof e=="string"){let n=e.split(":"),o=this.a1ToRowCol(n[0]),s=n[1]?this.a1ToRowCol(n[1]):o;return {startRow:o.row,startCol:o.col,endRow:s.row,endCol:s.col}}let t=this.normalizeCellRef(e.start),r=this.normalizeCellRef(e.end);return {startRow:t.row,startCol:t.col,endRow:r.row,endCol:r.col}}normalizeRangeToString(e){if(typeof e=="string")return e;let t=this.normalizeCellRef(e.start),r=this.normalizeCellRef(e.end);return `${this.rowColToA1(t.row,t.col)}:${this.rowColToA1(r.row,r.col)}`}hexToNumber(e){return parseInt(e.replace("#",""),16)}};var F=class extends x{getDocumentType(){return "impress"}getStructure(e){try{let t=this.lok.documentGetParts(this.docPtr),r=[];for(let o=0;o<t;o++){let s=this.getSlideInfoInternal(o);r.push(s);}let n={type:"impress",slides:r,slideCount:t};return this.createResult(n)}catch(t){return this.createErrorResult(`Failed to get structure: ${t}`)}}getSlide(e){try{let t=this.lok.documentGetParts(this.docPtr);if(e<0||e>=t)return this.createErrorResult(`Invalid slide index: ${e}. Valid range: 0-${t-1}`,"Use getStructure() to see available slides");this.lok.documentSetPart(this.docPtr,e);let r=this.lok.getAllText(this.docPtr)||"",n=this.parseTextFrames(r),o={index:e,title:n.find(s=>s.type==="title")?.text,textFrames:n,hasNotes:!1};return this.createResult(o)}catch(t){return this.createErrorResult(`Failed to get slide: ${t}`)}}getSlideCount(){try{let e=this.lok.documentGetParts(this.docPtr);return this.createResult(e)}catch(e){return this.createErrorResult(`Failed to get slide count: ${e}`)}}addSlide(e){try{let t=this.lok.documentGetParts(this.docPtr);e?.afterSlide!==void 0?this.lok.documentSetPart(this.docPtr,e.afterSlide):this.lok.documentSetPart(this.docPtr,t-1),this.lok.postUnoCommand(this.docPtr,".uno:InsertPage"),e?.layout&&this.applySlideLayout(e.layout);let r=e?.afterSlide!==void 0?e.afterSlide+1:t;return {success:!0,verified:this.lok.documentGetParts(this.docPtr)>t,data:{index:r}}}catch(t){return this.createErrorResult(`Failed to add slide: ${t}`)}}deleteSlide(e){try{let t=this.lok.documentGetParts(this.docPtr);return t<=1?this.createErrorResult("Cannot delete the last slide","A presentation must have at least one slide"):e<0||e>=t?this.createErrorResult(`Invalid slide index: ${e}`,`Valid range: 0-${t-1}`):(this.lok.documentSetPart(this.docPtr,e),this.lok.postUnoCommand(this.docPtr,".uno:DeletePage"),this.createResult(void 0))}catch(t){return this.createErrorResult(`Failed to delete slide: ${t}`)}}duplicateSlide(e){try{let t=this.lok.documentGetParts(this.docPtr);return e<0||e>=t?this.createErrorResult(`Invalid slide index: ${e}`,`Valid range: 0-${t-1}`):(this.lok.documentSetPart(this.docPtr,e),this.lok.postUnoCommand(this.docPtr,".uno:DuplicatePage"),this.createResult({newIndex:e+1}))}catch(t){return this.createErrorResult(`Failed to duplicate slide: ${t}`)}}moveSlide(e,t){try{let r=this.lok.documentGetParts(this.docPtr);if(e<0||e>=r||t<0||t>=r)return this.createErrorResult(`Invalid slide indices. Valid range: 0-${r-1}`,"Check slide indices are within bounds");if(e===t)return this.createErrorResult("Source and destination are the same","Provide different indices to move");this.lok.documentSetPart(this.docPtr,e);let n=JSON.stringify({Position:{type:"long",value:t}});return this.lok.postUnoCommand(this.docPtr,".uno:MovePageFirst",n),this.createResult(void 0)}catch(r){return this.createErrorResult(`Failed to move slide: ${r}`)}}setSlideTitle(e,t){try{let r=this.lok.documentGetParts(this.docPtr);if(e<0||e>=r)return this.createErrorResult(`Invalid slide index: ${e}`);this.lok.documentSetPart(this.docPtr,e);let n=this.lok.getAllText(this.docPtr)||"",s=this.parseTextFrames(n).find(c=>c.type==="title")?.text;this.lok.postUnoCommand(this.docPtr,".uno:SelectAll");let i=JSON.stringify({Text:{type:"string",value:t}});return this.lok.postUnoCommand(this.docPtr,".uno:InsertText",i),this.createResult({oldTitle:s})}catch(r){return this.createErrorResult(`Failed to set slide title: ${r}`)}}setSlideBody(e,t){try{let r=this.lok.documentGetParts(this.docPtr);if(e<0||e>=r)return this.createErrorResult(`Invalid slide index: ${e}`);this.lok.documentSetPart(this.docPtr,e);let n=this.lok.getAllText(this.docPtr)||"",s=this.parseTextFrames(n).find(c=>c.type==="body")?.text;this.lok.postUnoCommand(this.docPtr,".uno:NextObject");let i=JSON.stringify({Text:{type:"string",value:t}});return this.lok.postUnoCommand(this.docPtr,".uno:InsertText",i),this.createResult({oldBody:s})}catch(r){return this.createErrorResult(`Failed to set slide body: ${r}`)}}setSlideNotes(e,t){try{let r=this.lok.documentGetParts(this.docPtr);if(e<0||e>=r)return this.createErrorResult(`Invalid slide index: ${e}`);this.lok.documentSetPart(this.docPtr,e),this.lok.postUnoCommand(this.docPtr,".uno:NotesMode");let n=JSON.stringify({Text:{type:"string",value:t}});return this.lok.postUnoCommand(this.docPtr,".uno:InsertText",n),this.lok.postUnoCommand(this.docPtr,".uno:NormalViewMode"),this.createResult(void 0)}catch(r){return this.createErrorResult(`Failed to set slide notes: ${r}`)}}setSlideLayout(e,t){try{let r=this.lok.documentGetParts(this.docPtr);return e<0||e>=r?this.createErrorResult(`Invalid slide index: ${e}`):(this.lok.documentSetPart(this.docPtr,e),this.applySlideLayout(t),this.createResult(void 0))}catch(r){return this.createErrorResult(`Failed to set slide layout: ${r}`)}}getSlideInfoInternal(e){this.lok.documentSetPart(this.docPtr,e);let t=this.lok.getAllText(this.docPtr)||"",r=this.parseTextFrames(t),n=r.find(o=>o.type==="title");return {index:e,title:n?.text,layout:this.detectLayout(r),textFrameCount:r.length}}parseTextFrames(e){let t=e.split(/\n\n+/).filter(n=>n.trim()),r=[];return t.forEach((n,o)=>{let s=o===0?"title":o===1?"body":"other";r.push({index:o,type:s,text:n.trim(),bounds:{x:0,y:0,width:0,height:0}});}),r}detectLayout(e){return e.length===0?"blank":e.length===1&&e[0]?.type==="title"?"title":e.length>=2?"titleContent":"blank"}applySlideLayout(e){let r={blank:0,title:1,titleContent:2,twoColumn:3}[e]??0,n=JSON.stringify({WhatLayout:{type:"long",value:r}});this.lok.postUnoCommand(this.docPtr,".uno:AssignLayout",n);}};var $=class extends x{isImportedPdf=false;getDocumentType(){return "draw"}setImportedPdf(e){this.isImportedPdf=e;}getStructure(e){try{let t=this.lok.documentGetParts(this.docPtr),r=[];for(let o=0;o<t;o++){let s=this.getPageInfoInternal(o);r.push(s);}let n={type:"draw",pages:r,pageCount:t,isImportedPdf:this.isImportedPdf};return this.createResult(n)}catch(t){return this.createErrorResult(`Failed to get structure: ${t}`)}}getPage(e){try{let t=this.lok.documentGetParts(this.docPtr);if(e<0||e>=t)return this.createErrorResult(`Invalid page index: ${e}. Valid range: 0-${t-1}`,"Use getStructure() to see available pages");this.lok.documentSetPart(this.docPtr,e);let r=this.lok.documentGetDocumentSize(this.docPtr),n=this.getShapesOnPage(),o={index:e,shapes:n,size:{width:r.width,height:r.height}};return this.createResult(o)}catch(t){return this.createErrorResult(`Failed to get page: ${t}`)}}getPageCount(){try{let e=this.lok.documentGetParts(this.docPtr);return this.createResult(e)}catch(e){return this.createErrorResult(`Failed to get page count: ${e}`)}}addPage(e){try{let t=this.lok.documentGetParts(this.docPtr);e?.afterPage!==void 0?this.lok.documentSetPart(this.docPtr,e.afterPage):this.lok.documentSetPart(this.docPtr,t-1),this.lok.postUnoCommand(this.docPtr,".uno:InsertPage");let r=e?.afterPage!==void 0?e.afterPage+1:t;return this.createResult({index:r})}catch(t){return this.createErrorResult(`Failed to add page: ${t}`)}}deletePage(e){try{let t=this.lok.documentGetParts(this.docPtr);return t<=1?this.createErrorResult("Cannot delete the last page","A drawing document must have at least one page"):e<0||e>=t?this.createErrorResult(`Invalid page index: ${e}`,`Valid range: 0-${t-1}`):(this.lok.documentSetPart(this.docPtr,e),this.lok.postUnoCommand(this.docPtr,".uno:DeletePage"),this.createResult(void 0))}catch(t){return this.createErrorResult(`Failed to delete page: ${t}`)}}duplicatePage(e){try{let t=this.lok.documentGetParts(this.docPtr);return e<0||e>=t?this.createErrorResult(`Invalid page index: ${e}`,`Valid range: 0-${t-1}`):(this.lok.documentSetPart(this.docPtr,e),this.lok.postUnoCommand(this.docPtr,".uno:DuplicatePage"),this.createResult({newIndex:e+1}))}catch(t){return this.createErrorResult(`Failed to duplicate page: ${t}`)}}addShape(e,t,r,n){try{let o=this.lok.documentGetParts(this.docPtr);if(e<0||e>=o)return this.createErrorResult(`Invalid page index: ${e}`);this.lok.documentSetPart(this.docPtr,e);let s=this.getShapeCommand(t),i=JSON.stringify({X:{type:"long",value:r.x},Y:{type:"long",value:r.y},Width:{type:"long",value:r.width},Height:{type:"long",value:r.height}});if(this.lok.postUnoCommand(this.docPtr,s,i),n?.text){let c=JSON.stringify({Text:{type:"string",value:n.text}});this.lok.postUnoCommand(this.docPtr,".uno:InsertText",c);}if(n?.fillColor){let c=JSON.stringify({FillColor:{type:"long",value:this.hexToNumber(n.fillColor)}});this.lok.postUnoCommand(this.docPtr,".uno:FillColor",c);}if(n?.lineColor){let c=JSON.stringify({LineColor:{type:"long",value:this.hexToNumber(n.lineColor)}});this.lok.postUnoCommand(this.docPtr,".uno:XLineColor",c);}return this.createResult({shapeIndex:0})}catch(o){return this.createErrorResult(`Failed to add shape: ${o}`)}}addLine(e,t,r,n){try{let o=this.lok.documentGetParts(this.docPtr);if(e<0||e>=o)return this.createErrorResult(`Invalid page index: ${e}`);this.lok.documentSetPart(this.docPtr,e);let s=JSON.stringify({StartX:{type:"long",value:t.x},StartY:{type:"long",value:t.y},EndX:{type:"long",value:r.x},EndY:{type:"long",value:r.y}});if(this.lok.postUnoCommand(this.docPtr,".uno:Line",s),n?.lineColor){let i=JSON.stringify({LineColor:{type:"long",value:this.hexToNumber(n.lineColor)}});this.lok.postUnoCommand(this.docPtr,".uno:XLineColor",i);}if(n?.lineWidth){let i=JSON.stringify({LineWidth:{type:"long",value:n.lineWidth}});this.lok.postUnoCommand(this.docPtr,".uno:LineWidth",i);}return this.createResult({shapeIndex:0})}catch(o){return this.createErrorResult(`Failed to add line: ${o}`)}}deleteShape(e,t){try{return this.lok.documentSetPart(this.docPtr,e),this.selectShape(t),this.lok.postUnoCommand(this.docPtr,".uno:Delete"),this.createResult(void 0)}catch(r){return this.createErrorResult(`Failed to delete shape: ${r}`)}}setShapeText(e,t,r){try{this.lok.documentSetPart(this.docPtr,e),this.selectShape(t),this.lok.postUnoCommand(this.docPtr,".uno:EnterGroup"),this.lok.postUnoCommand(this.docPtr,".uno:SelectAll");let n=JSON.stringify({Text:{type:"string",value:r}});return this.lok.postUnoCommand(this.docPtr,".uno:InsertText",n),this.lok.postUnoCommand(this.docPtr,".uno:LeaveGroup"),this.createResult(void 0)}catch(n){return this.createErrorResult(`Failed to set shape text: ${n}`)}}moveShape(e,t,r){try{this.lok.documentSetPart(this.docPtr,e),this.selectShape(t);let n=JSON.stringify({X:{type:"long",value:r.x},Y:{type:"long",value:r.y}});return this.lok.postUnoCommand(this.docPtr,".uno:SetObjectPosition",n),this.createResult(void 0)}catch(n){return this.createErrorResult(`Failed to move shape: ${n}`)}}resizeShape(e,t,r){try{this.lok.documentSetPart(this.docPtr,e),this.selectShape(t);let n=JSON.stringify({Width:{type:"long",value:r.width},Height:{type:"long",value:r.height}});return this.lok.postUnoCommand(this.docPtr,".uno:Size",n),this.createResult(void 0)}catch(n){return this.createErrorResult(`Failed to resize shape: ${n}`)}}getPageInfoInternal(e){this.lok.documentSetPart(this.docPtr,e);let t=this.lok.documentGetDocumentSize(this.docPtr),r=this.getShapesOnPage();return {index:e,shapeCount:r.length,size:{width:t.width,height:t.height}}}getShapesOnPage(){let e=this.lok.getAllText(this.docPtr)||"";return e.trim()?[{index:0,type:"text",text:e,bounds:{x:0,y:0,width:0,height:0}}]:[]}selectShape(e){let t=JSON.stringify({Index:{type:"long",value:e}});this.lok.postUnoCommand(this.docPtr,".uno:SelectObject",t);}getShapeCommand(e){return {rectangle:".uno:Rect",ellipse:".uno:Ellipse",line:".uno:Line",text:".uno:Text",image:".uno:InsertGraphic",group:".uno:FormatGroup",other:".uno:Rect"}[e]}hexToNumber(e){return parseInt(e.replace("#",""),16)}};var ie=0,ae=1,le=2,ce=3;function q(a,e,t){let r=a.documentGetDocumentType(e);switch(r){case ie:return new D(a,e,t);case ae:return new U(a,e,t);case le:return new F(a,e,t);case ce:return new $(a,e,t);default:throw new Error(`Unsupported document type: ${r}`)}}var ee={"download-wasm":50,"download-data":30,compile:5,filesystem:7,"lok-init":7,ready:1},A={"download-wasm":0,"download-data":0,compile:0,filesystem:0,"lok-init":0,ready:0},te=0,H=0;function re(){let a=0;for(let t of Object.keys(A))a+=A[t];let e=Math.min(100,Math.round(a));return e>H&&(H=e),H}function z(a){return `${(a/1048576).toFixed(1)} MB`}function Z(a,e,t){let r=ee[a],n=t>0?e/t:0,o=r*n;o>A[a]&&(A[a]=o);let s=a==="download-wasm"?`Downloading WebAssembly... ${z(e)} / ${z(t)}`:`Downloading filesystem... ${z(e)} / ${z(t)}`;oe({percent:re(),message:s,phase:a,bytesLoaded:e,bytesTotal:t});}function N(a,e){let t=ee[a];t>A[a]&&(A[a]=t),oe({percent:re(),message:e,phase:a});}function oe(a){self.postMessage({type:"progress",id:te,progress:a});}function ue(){let a=self.fetch;self.fetch=async function(r,n){let o=typeof r=="string"?r:r instanceof URL?r.href:r.url,s=null;o.includes("soffice.wasm")?(s="download-wasm",console.log("[Worker] Starting fetch download: soffice.wasm")):o.includes("soffice.data")&&(s="download-data",console.log("[Worker] Starting fetch download: soffice.data"));let i=await a(r,n);if(!s)return i;let c=i.headers.get("Content-Length"),d=c?parseInt(c,10):0;if(!d||!i.body)return console.log(`[Worker] No content-length for ${o}, skipping progress tracking`),i;let h=i.body.getReader(),m=0,u=new ReadableStream({async start(g){for(;;){let{done:y,value:_}=await h.read();if(y){console.log(`[Worker] Finished fetch download: ${s==="download-wasm"?"soffice.wasm":"soffice.data"}`),g.close();break}m+=_.length,Z(s,m,d),g.enqueue(_);}}});return new Response(u,{headers:i.headers,status:i.status,statusText:i.statusText})},console.log("[Worker] Installed progress-tracking fetch interceptor");let e=self.XMLHttpRequest,t=function(){let r=new e,n="",o=r.open.bind(r);r.open=function(i,c,...d){return n=String(c),o(i,c,...d)};let s=r.send.bind(r);return r.send=function(i){let c=null;if(n.includes("soffice.wasm")?(c="download-wasm",console.log("[Worker] Starting XHR download: soffice.wasm")):n.includes("soffice.data")&&(c="download-data",console.log("[Worker] Starting XHR download: soffice.data")),c){let d=c;r.addEventListener("progress",h=>{h.lengthComputable&&Z(d,h.loaded,h.total);}),r.addEventListener("load",()=>{console.log(`[Worker] Finished XHR download: ${d==="download-wasm"?"soffice.wasm":"soffice.data"}`);});}return s(i)},r};Object.defineProperty(t,"prototype",{value:e.prototype,writable:false}),self.XMLHttpRequest=t,console.log("[Worker] Installed progress-tracking XHR interceptor");}var S=null,l=null,L=false,T=null,K=new Map,de=0;function he(a){let e=0,t=Math.max(1,Math.floor(a.length/1e3));for(let r=0;r<a.length;r+=t)e=(e<<5)-e+a[r]|0;return `${e}_${a.length}`}function me(a){let e=l.documentGetDocumentType(a);if(e===0){let r=l.getPartPageRectangles(a);if(r){let n=l.parsePageRectangles(r);return console.log(`[Worker] getDocumentPageCount: TEXT doc has ${n.length} pages from rectangles`),n.length}return console.log("[Worker] getDocumentPageCount: TEXT doc has no page rectangles, assuming 1 page"),1}let t=l.documentGetParts(a);return console.log(`[Worker] getDocumentPageCount: docType=${e} has ${t} parts`),t}function I(a,e){let t=he(a);if(T&&T.inputHash===t&&l)return console.log(`[Worker] getOrLoadDocument: reusing cached doc ptr=${T.docPtr}, pageCount=${T.pageCount}`),{docPtr:T.docPtr,pageCount:T.pageCount};console.log(`[Worker] getOrLoadDocument: loading new document (hash=${t})`),w();let r=`/tmp/input/cached_doc.${e||"docx"}`;S.FS.writeFile(r,a);let n=l.documentLoad(r);if(n===0){let s=l.getError();throw new Error(s||"Failed to load document")}let o=me(n);return console.log(`[Worker] getOrLoadDocument: loaded doc ptr=${n}, pageCount=${o}`),T={docPtr:n,inputHash:t,filePath:r,pageCount:o},{docPtr:n,pageCount:o}}function w(){if(T&&l&&S){console.log(`[Worker] closeCachedDocument: closing cached doc ptr=${T.docPtr}`);try{l.documentDestroy(T.docPtr);}catch{}try{S.FS.unlink(T.filePath);}catch{}T=null;}}function f(a){a.data?self.postMessage(a,[a.data.buffer]):self.postMessage(a);}function R(a,e,t){f({type:"progress",id:a,progress:{percent:e,message:t}});}async function pe(a){if(L){f({type:"ready",id:a.id});return}let{sofficeJs:e,sofficeWasm:t,sofficeData:r,sofficeWorkerJs:n}=a;if(!e||!t||!r||!n){f({type:"error",id:a.id,error:"Missing required WASM paths (sofficeJs, sofficeWasm, sofficeData, sofficeWorkerJs)"});return}let o=a.verbose||false;te=a.id;for(let s of Object.keys(A))A[s]=0;H=0,ue(),N("download-wasm","Preparing to download WebAssembly...");try{console.log("[Worker] Setting up Module with explicit paths:",{sofficeJs:e,sofficeWasm:t,sofficeData:r,sofficeWorkerJs:n}),self.Module={mainScriptUrlOrBlob:e,locateFile:(i,c)=>{let d;return i.endsWith(".wasm")?d=t:i.endsWith(".data")?d=r:i.includes(".worker.")?d=n:d=`${e.substring(0,e.lastIndexOf("/")+1)}${i}`,console.log("[Worker] locateFile called:",i,"scriptDir:",c,"-> result:",d),d},print:console.log,printErr:console.error},importScripts(e),N("compile","Compiling WebAssembly module..."),await new Promise((i,c)=>{let d=()=>{if(self.Module&&self.Module.calledRun)i();else if(self.Module&&self.Module.onRuntimeInitialized){let h=self.Module.onRuntimeInitialized;self.Module.onRuntimeInitialized=()=>{h(),i();};}else self.Module.onRuntimeInitialized=i;setTimeout(()=>c(new Error("WASM initialization timeout")),12e4);};self.Module&&self.Module.calledRun?i():d();}),S=self.Module,N("filesystem","Setting up filesystem...");try{let i=S;i.ENV?(i.ENV.SAL_LOG="+ALL",i.ENV.MAX_CONCURRENCY="1",console.log("[Worker] Set SAL_LOG to +ALL")):console.log("[Worker] ENV not available");}catch(i){console.log("[Worker] Could not set SAL_LOG:",i);}let s=S.FS;if(o){let i=s.open.bind(s);s.open=(c,d,h)=>{console.log("[FS OPEN CALL]",c);try{return i(c,d,h)}catch(m){throw m?.code==="ENOENT"&&console.log("[FS ENOENT]",c),m}};}try{s.mkdir("/tmp");}catch{}try{s.mkdir("/tmp/input");}catch{}try{s.mkdir("/tmp/output");}catch{}N("lok-init","Initializing LibreOfficeKit..."),l=new B(S,o),l.initialize("/instdir/program"),l.enableSyncEvents(),console.log("[LOK Worker] Enabled synchronous event dispatch (Unipoll mode)"),L=!0,N("ready","Ready"),f({type:"ready",id:a.id});}catch(s){f({type:"error",id:a.id,error:s instanceof Error?s.message:String(s)});}}var ge=["png","jpg","jpeg","svg"];async function fe(a){if(!L||!S||!l){f({type:"error",id:a.id,error:"Worker not initialized"});return}let{inputData:e,inputExt:t,outputFormat:r,filterOptions:n,password:o}=a;if(!e||!r){f({type:"error",id:a.id,error:"Missing input data or output format"});return}let s=ge.includes(r.toLowerCase()),i=`/tmp/input/doc.${t||"docx"}`,c=`/tmp/output/doc.${r}`,d=0,h=[];try{if(R(a.id,10,"Writing input file..."),S.FS.writeFile(i,e),R(a.id,30,"Loading document..."),o?d=l.documentLoadWithOptions(i,`,Password=${o}`):d=l.documentLoad(i),d===0){let g=l.getError();throw new Error(g||"Failed to load document")}let m=l.documentGetParts(d),u=l.documentGetDocumentType(d);if(s&&m>1){R(a.id,40,`Exporting ${m} pages as ${r.toUpperCase()}...`);let g=j[r],y=n||J[r]||"",_=[],{width:p,height:E}=l.documentGetDocumentSize(d),C=E/p,v=1024,W=Math.round(v*C);for(let b=0;b<m;b++){let V=40+Math.round(b/m*40);R(a.id,V,`Exporting page ${b+1}/${m}...`);let k=`/tmp/output/page_${b+1}.${r}`;if(h.push(k),u===2||u===3){l.documentSetPart(d,b);let P=y;(r==="png"||r==="jpg"||r==="jpeg")&&(P=`PixelWidth=${v};PixelHeight=${W}`,y&&(P=`${y};${P}`)),l.documentSaveAs(d,k,g,P),console.log(`[Worker] Page ${b+1} (presentation) exported with opts: ${P}`);}else {let P=`PageRange=${b+1}-${b+1}`;(r==="png"||r==="jpg"||r==="jpeg")&&(P+=`;PixelWidth=${v};PixelHeight=${W}`),y&&(P=`${y};${P}`),l.documentSaveAs(d,k,g,P),console.log(`[Worker] Page ${b+1} (text) exported with opts: ${P}`);}let O=S.FS.readFile(k);if(console.log(`[Worker] Page ${b+1} exported: ${O.length} bytes`),O.length>0){let P=new Uint8Array(O.length);P.set(O),_.push({name:`page_${b+1}.${r}`,data:P});}else console.warn(`[Worker] Page ${b+1} export produced empty file`);}R(a.id,85,"Creating ZIP archive...");let M=Se(_);R(a.id,100,"Complete"),f({type:"result",id:a.id,data:M});}else {R(a.id,50,"Converting...");let g=j[r],y=n||J[r]||"";R(a.id,70,"Saving..."),l.documentSaveAs(d,c,g,y),h.push(c),R(a.id,90,"Reading output...");let _=S.FS.readFile(c);if(_.length===0)throw new Error("Conversion produced empty output");let p=new Uint8Array(_.length);p.set(_),R(a.id,100,"Complete"),f({type:"result",id:a.id,data:p});}}catch(m){f({type:"error",id:a.id,error:m instanceof Error?m.message:String(m)});}finally{if(d!==0)try{l.documentDestroy(d);}catch{}try{S.FS.unlink(i);}catch{}for(let m of h)try{S.FS.unlink(m);}catch{}}}function Se(a){let e=[],t=[],r=0;for(let m of a){let u=new TextEncoder().encode(m.name),g=new Uint8Array(30+u.length),y=new DataView(g.buffer);y.setUint32(0,67324752,true),y.setUint16(4,20,true),y.setUint16(6,0,true),y.setUint16(8,0,true),y.setUint16(10,0,true),y.setUint16(12,0,true),y.setUint32(14,Q(m.data),true),y.setUint32(18,m.data.length,true),y.setUint32(22,m.data.length,true),y.setUint16(26,u.length,true),y.setUint16(28,0,true),g.set(u,30),e.push(g),e.push(m.data);let _=new Uint8Array(46+u.length),p=new DataView(_.buffer);p.setUint32(0,33639248,true),p.setUint16(4,20,true),p.setUint16(6,20,true),p.setUint16(8,0,true),p.setUint16(10,0,true),p.setUint16(12,0,true),p.setUint16(14,0,true),p.setUint32(16,Q(m.data),true),p.setUint32(20,m.data.length,true),p.setUint32(24,m.data.length,true),p.setUint16(28,u.length,true),p.setUint16(30,0,true),p.setUint16(32,0,true),p.setUint16(34,0,true),p.setUint16(36,0,true),p.setUint32(38,0,true),p.setUint32(42,r,true),_.set(u,46),t.push(_),r+=g.length+m.data.length;}let n=r,o=0;for(let m of t)e.push(m),o+=m.length;let s=new Uint8Array(22),i=new DataView(s.buffer);i.setUint32(0,101010256,true),i.setUint16(4,0,true),i.setUint16(6,0,true),i.setUint16(8,a.length,true),i.setUint16(10,a.length,true),i.setUint32(12,o,true),i.setUint32(16,n,true),i.setUint16(20,0,true),e.push(s);let c=e.reduce((m,u)=>m+u.length,0),d=new Uint8Array(c),h=0;for(let m of e)d.set(m,h),h+=m.length;return d}function Q(a){let e=4294967295;for(let t=0;t<a.length;t++){let r=a[t];e^=r;for(let n=0;n<8;n++)e=e>>>1^(e&1?3988292384:0);}return (e^4294967295)>>>0}async function ye(a){if(!L||!S||!l){f({type:"error",id:a.id,error:"Worker not initialized"});return}let{inputData:e,inputExt:t}=a;if(!e){f({type:"error",id:a.id,error:"Missing input data"});return}try{let{pageCount:r}=I(e,t||"docx");f({type:"pageCount",id:a.id,pageCount:r});}catch(r){f({type:"error",id:a.id,error:r instanceof Error?r.message:String(r)}),w();}}async function _e(a){if(!L||!S||!l){f({type:"error",id:a.id,error:"Worker not initialized"});return}let{inputData:e,inputExt:t,maxWidth:r=256}=a;if(!e){f({type:"error",id:a.id,error:"Missing input data"});return}try{R(a.id,10,"Loading document for preview...");let{docPtr:n,pageCount:o}=I(e,t||"docx");R(a.id,20,`Rendering ${o} pages...`);let s=[];for(let c=0;c<o;c++){let d=20+Math.round(c/o*70);R(a.id,d,`Rendering page ${c+1}/${o}...`);let h=l.renderPage(n,c,r),m=new Uint8Array(h.data.length);m.set(h.data),s.push({page:c+1,data:m,width:h.width,height:h.height});}R(a.id,100,"Preview complete");let i=s.map(c=>c.data.buffer);self.postMessage({type:"previews",id:a.id,previews:s},i);}catch(n){f({type:"error",id:a.id,error:n instanceof Error?n.message:String(n)}),w();}}async function Ee(a){if(!L||!S||!l){f({type:"error",id:a.id,error:"Worker not initialized"});return}let{inputData:e,inputExt:t,maxWidth:r=256,pageIndex:n=0}=a;if(!e){f({type:"error",id:a.id,error:"Missing input data"});return}let o=-1,s=0;try{let i=I(e,t||"docx");s=i.docPtr;let c=i.pageCount;if(n<0||n>=c)throw new Error(`Page index ${n} out of range (0-${c-1})`);let d=l.documentGetDocumentType(s);console.log(`[Worker] handleRenderSinglePage: ${["TEXT","SPREADSHEET","PRESENTATION","DRAWING"][d]||"UNKNOWN"} document - creating view for rendering`),o=l.createView(s),o>=0&&(l.setView(s,o),console.log(`[Worker] handleRenderSinglePage: Created and set view ${o}`)),console.log(`[Worker] handleRenderSinglePage: calling renderPage for page ${n} at maxWidth=${r}...`);let m=l.renderPage(s,n,r);console.log(`[Worker] handleRenderSinglePage: renderPage returned ${m.data.length} bytes (${m.width}x${m.height})`);let u=new Uint8Array(m.data.length);u.set(m.data);let g={page:n+1,data:u,width:m.width,height:m.height};if(o>=0&&s!==0){try{l.destroyView(s,o);}catch{}console.log(`[Worker] handleRenderSinglePage: Destroyed view ${o}`);}self.postMessage({type:"singlePagePreview",id:a.id,preview:g},[u.buffer]);}catch(i){if(o>=0&&s!==0){try{l.destroyView(s,o);}catch{}console.log(`[Worker] handleRenderSinglePage: Destroyed view ${o} (on error)`);}let c=i instanceof Error?String(i.message):String(i);f({type:"error",id:a.id,error:c}),w();}}async function Ce(a){if(!L||!S||!l){f({type:"error",id:a.id,error:"Worker not initialized"});return}let{inputData:e,inputExt:t,maxWidth:r=256,pageIndex:n=0}=a;if(!e){f({type:"error",id:a.id,error:"Missing input data"});return}let o=`/tmp/output/page_${n}.png`;try{let{docPtr:s,pageCount:i}=I(e,t||"pdf"),c=l.documentGetDocumentType(s);if(n<0||n>=i)throw new Error(`Page index ${n} out of range (0-${i-1})`);(c===2||c===3)&&l.documentSetPart(s,n);let{width:d,height:h}=l.documentGetDocumentSize(s),m=h/d,u=Math.min(r,d),g=Math.round(u*m),y=`PixelWidth=${u};PixelHeight=${g}`;c===0&&(y+=`;PageRange=${n+1}-${n+1}`),l.documentSaveAs(s,o,"png",y);let _=S.FS.readFile(o);if(_.length===0)throw new Error("PNG export produced empty output");let p=new Uint8Array(_.length);p.set(_);let E={page:n+1,data:p,width:u,height:g,format:"png"};self.postMessage({type:"singlePagePreview",id:a.id,preview:E,isPng:!0},[p.buffer]);try{S.FS.unlink(o);}catch{}}catch(s){f({type:"error",id:a.id,error:s instanceof Error?s.message:String(s)}),w();try{S.FS.unlink(o);}catch{}}}async function be(a){if(!L||!S||!l){f({type:"error",id:a.id,error:"Worker not initialized"});return}let{inputData:e,inputExt:t}=a;if(!e){f({type:"error",id:a.id,error:"Missing input data"});return}try{let{docPtr:r,pageCount:n}=I(e,t||"docx"),o=l.documentGetDocumentType(r),s={0:["pdf","docx","doc","odt","rtf","txt","html","png","jpg","svg"],1:["pdf","xlsx","xls","ods","csv","html","png","jpg","svg"],2:["pdf","pptx","ppt","odp","png","jpg","svg","html"],3:["pdf","png","jpg","svg","html"],4:["pdf"]},c={documentType:o,documentTypeName:{0:"Text Document",1:"Spreadsheet",2:"Presentation",3:"Drawing",4:"Other"}[o]||"Unknown",validOutputFormats:s[o]||["pdf"],pageCount:n};f({type:"documentInfo",id:a.id,documentInfo:c});}catch(r){f({type:"error",id:a.id,error:r instanceof Error?r.message:String(r)}),w();}}async function ke(a){if(console.log("[LOK Worker] handleGetLokInfo called"),!L||!S||!l){f({type:"error",id:a.id,error:"Worker not initialized"});return}let{inputData:e,inputExt:t}=a;if(!e){f({type:"error",id:a.id,error:"Missing input data"});return}try{console.log("[LOK Worker] Getting or loading document...");let{docPtr:r}=I(e,t||"docx");console.log(`[LOK Worker] Got docPtr: ${r}`),console.log("[LOK Worker] Calling LOK methods...");let n=l.getPartPageRectangles(r);console.log(`[LOK Worker] pageRectangles: ${n}`);let o=l.documentGetDocumentSize(r);console.log(`[LOK Worker] documentSize: ${o.width}x${o.height}`);let s=l.getPartInfo(r,0);console.log(`[LOK Worker] partInfo: ${s}`);let i=l.getA11yFocusedParagraph(r);console.log(`[LOK Worker] a11yFocusedParagraph: ${i}`);let c=l.getA11yCaretPosition(r);console.log(`[LOK Worker] a11yCaretPosition: ${c}`);let d=l.getEditMode(r);console.log(`[LOK Worker] editMode (initial): ${d}`);let h=null,m=-1;m=l.getView(r),console.log(`[LOK Worker] Got existing view: ${m}`),m>=0&&(l.setView(r,m),console.log(`[LOK Worker] Set active view to ${m}`));let u=l.createView(r);console.log(`[LOK Worker] Created new view: ${u}`),u>=0&&(l.setView(r,u),console.log(`[LOK Worker] Switched to new view: ${u}`)),l.setEditMode(r,1),d=l.getEditMode(r),console.log(`[LOK Worker] editMode (after setEditMode): ${d}`),h=l.getAllText(r),console.log(`[LOK Worker] allText: ${h?.slice(0,100)||"null"}`),u>=0&&(l.destroyView(r,u),console.log(`[LOK Worker] Destroyed view: ${u}`));let g=null;if(s)try{g=JSON.parse(s);}catch{console.warn("[LOK Worker] Failed to parse partInfo JSON:",s);}let y=null;if(i)try{y=JSON.parse(i);}catch{console.warn("[LOK Worker] Failed to parse a11yFocusedParagraph JSON:",i);}let _={pageRectangles:n,documentSize:o,partInfo:g,a11yFocusedParagraph:y,a11yCaretPosition:c,editMode:d,allText:h};console.log("[LOK Worker] Posting lokInfo response"),f({type:"lokInfo",id:a.id,lokInfo:_});}catch(r){console.error("[LOK Worker] Error in handleGetLokInfo:",r),f({type:"error",id:a.id,error:r instanceof Error?r.message:String(r)}),w();}}async function Oe(a){if(console.log("[LOK Worker] handleEditText called"),!L||!S||!l){f({type:"error",id:a.id,error:"Worker not initialized"});return}let{inputData:e,inputExt:t,findText:r,replaceText:n,insertText:o}=a;if(!e){f({type:"error",id:a.id,error:"Missing input data"});return}w();let s=`/tmp/input/edit_doc.${t||"docx"}`,i=`/tmp/output/edited_doc.${t||"docx"}`,c=0,d=-1;try{if(console.log("[LOK Worker] Writing input file..."),S.FS.writeFile(s,e),console.log("[LOK Worker] Loading document for editing..."),c=l.documentLoad(s),c===0){let p=l.getError();throw new Error(p||"Failed to load document")}console.log(`[LOK Worker] Document loaded, docPtr=${c}`),l.documentInitializeForRendering(c),console.log("[LOK Worker] Document initialized for rendering"),d=l.getView(c),console.log(`[LOK Worker] Got existing view: ${d}`),d>=0&&(l.setView(c,d),console.log(`[LOK Worker] Set active view to ${d}`));let h=l.createView(c);console.log(`[LOK Worker] Created new view: ${h}`),h>=0&&(l.setView(c,h),console.log(`[LOK Worker] Switched to new view: ${h}`),d=h),l.setEditMode(c,1);let m=l.getEditMode(c);console.log(`[LOK Worker] Edit mode after setEditMode(1): ${m}`);let u="";if(r&&n!==void 0){console.log(`[LOK Worker] Attempting find/replace: "${r}" -> "${n}"`);let p=JSON.stringify({"SearchItem.SearchString":{type:"string",value:r},"SearchItem.ReplaceString":{type:"string",value:n},"SearchItem.Command":{type:"unsigned short",value:"3"}});try{l.postUnoCommand(c,".uno:ExecuteSearch",p),u=`Attempted replace all "${r}" with "${n}"`,console.log(`[LOK Worker] ${u}`);}catch(E){console.error("[LOK Worker] ExecuteSearch threw:",E),u=`ExecuteSearch failed: ${E}`;}}else if(o){console.log(`[LOK Worker] Attempting to insert text: "${o}"`);let p=[];try{console.log("[LOK Worker] Clicking in document to establish focus..."),l.postMouseEvent(c,0,1e3,1e3,1,1,0),l.postMouseEvent(c,1,1e3,1e3,1,1,0),console.log("[LOK Worker] Posted mouse events for focus"),p.push("mouseEvents:ok");}catch(C){console.error("[LOK Worker] postMouseEvent threw:",C),p.push("mouseEvents:err");}try{l.postUnoCommand(c,".uno:GoToEndOfDoc"),console.log("[LOK Worker] Posted GoToEndOfDoc"),p.push("GoToEndOfDoc:ok");}catch(C){console.error("[LOK Worker] GoToEndOfDoc threw:",C),p.push("GoToEndOfDoc:err");}let E=!1;try{console.log("[LOK Worker] Trying paste() with text/plain..."),E=l.paste(c,"text/plain;charset=utf-8",o),console.log(`[LOK Worker] paste() returned: ${E}`),p.push(`paste:${E}`);}catch(C){console.error("[LOK Worker] paste() threw:",C),p.push("paste:err");}try{let C=JSON.stringify({Text:{type:"string",value:o}});l.postUnoCommand(c,".uno:InsertText",C),console.log("[LOK Worker] Posted InsertText"),p.push("InsertText:ok");}catch(C){console.error("[LOK Worker] InsertText threw:",C),p.push("InsertText:err");}try{console.log("[LOK Worker] Now trying postKeyEvent for each character...");for(let C=0;C<o.length;C++){let v=o.charCodeAt(C);l.postKeyEvent(c,0,v,0),l.postKeyEvent(c,1,v,0);}console.log(`[LOK Worker] Posted ${o.length} key events`),p.push(`keyEvents:${o.length}`);}catch(C){console.error("[LOK Worker] postKeyEvent threw:",C),p.push("keyEvents:err");}u=`Insert attempts: ${p.join(", ")}`,console.log(`[LOK Worker] ${u}`);}else u="No edit operation specified (need findText+replaceText or insertText)",console.log(`[LOK Worker] ${u}`);console.log("[LOK Worker] Attempting to save modified document...");let g=t||"docx",_={docx:"docx",doc:"doc",odt:"odt",xlsx:"xlsx",xls:"xls",ods:"ods",pptx:"pptx",ppt:"ppt",odp:"odp"}[g]||g;try{l.documentSaveAs(c,i,_,""),console.log("[LOK Worker] Document saved");let p=S.FS.readFile(i);console.log(`[LOK Worker] Modified document size: ${p.length} bytes`);let E=new Uint8Array(p.length);E.set(p);let C={success:!0,editMode:m,message:u+` | Document saved (${E.length} bytes)`,modifiedDocument:E};self.postMessage({type:"editResult",id:a.id,editResult:C},[E.buffer]);}catch(p){console.error("[LOK Worker] Save error:",p);let E={success:!1,editMode:m,message:u+` | Save failed: ${p}`};f({type:"editResult",id:a.id,editResult:E});}}catch(h){console.error("[LOK Worker] Error in handleEditText:",h),h instanceof Error&&(console.error("[LOK Worker] Error name:",h.name),console.error("[LOK Worker] Error message:",h.message),console.error("[LOK Worker] Error stack:",h.stack));let m=h;if(m&&typeof m=="object"){console.error("[LOK Worker] Error keys:",Object.keys(m));for(let u of Object.keys(m))try{console.error(`[LOK Worker] Error.${u}:`,m[u]);}catch{}}if(typeof h=="number"){console.error("[LOK Worker] Emscripten exception pointer:",h);let u=S;if(u&&typeof u.getExceptionMessage=="function")try{let g=u.getExceptionMessage(h);console.error("[LOK Worker] Emscripten exception message:",g);}catch{}}f({type:"error",id:a.id,error:h instanceof Error?h.message:String(h)});}finally{if(c!==0&&l){if(d>=0)try{l.destroyView(c,d);}catch{}try{l.documentDestroy(c);}catch{}}if(S){try{S.FS.unlink(s);}catch{}try{S.FS.unlink(i);}catch{}}}}async function Pe(a){if(console.log("[LOK Worker] handleRenderPageRectangles called"),!L||!S||!l){f({type:"error",id:a.id,error:"Worker not initialized"});return}let{inputData:e,inputExt:t,maxWidth:r=256}=a;if(!e){f({type:"error",id:a.id,error:"Missing input data"});return}try{let{docPtr:n}=I(e,t||"docx");l.documentInitializeForRendering(n);let o=l.getPartPageRectangles(n);if(console.log(`[LOK Worker] Page rectangles string: ${o?.slice(0,100)||"null"}...`),!o||o.length===0){f({type:"pageRectangles",id:a.id,pageRectangles:[]});return}let s=l.parsePageRectangles(o);console.log(`[LOK Worker] Parsed ${s.length} page rectangles`);let i=[],c=[];for(let d=0;d<s.length;d++){let h=s[d];console.log(`[LOK Worker] Rendering page ${d}: x=${h.x}, y=${h.y}, w=${h.width}, h=${h.height}`);let m=h.height/h.width,u=r,g=Math.round(r*m),y=l.documentPaintTile(n,u,g,h.x,h.y,h.width,h.height),_=new Uint8Array(y.length);_.set(y),i.push({index:d,x:h.x,y:h.y,width:h.width,height:h.height,imageData:_,imageWidth:u,imageHeight:g}),c.push(_.buffer),console.log(`[LOK Worker] Rendered page ${d}: ${u}x${g}, ${_.length} bytes`);}self.postMessage({type:"pageRectangles",id:a.id,pageRectangles:i},c);}catch(n){console.error("[LOK Worker] Error in handleRenderPageRectangles:",n);let o=n instanceof Error?String(n.message):String(n);f({type:"error",id:a.id,error:o}),w();}}async function Re(a){if(console.log("[LOK Worker] handleTestLokOperations called"),!L||!S||!l){f({type:"error",id:a.id,error:"Worker not initialized"});return}let{inputData:e,inputExt:t}=a;if(!e){f({type:"error",id:a.id,error:"Missing input data"});return}w();let r=`/tmp/input/test_ops_doc.${t||"docx"}`,n=`/tmp/output/test_ops_doc.${t||"docx"}`,o=0,s=-1,i=[];try{if(console.log("[LOK Worker] Writing input file..."),S.FS.writeFile(r,e),console.log("[LOK Worker] Loading document for LOK operations testing..."),o=l.documentLoad(r),o===0){let u=l.getError();throw new Error(u||"Failed to load document")}console.log(`[LOK Worker] Document loaded, docPtr=${o}`),l.documentInitializeForRendering(o),console.log("[LOK Worker] Document initialized for rendering"),s=l.getView(o),console.log(`[LOK Worker] Got existing view: ${s}`),s>=0&&l.setView(o,s);let c=l.createView(o);console.log(`[LOK Worker] Created new view: ${c}`),c>=0&&(l.setView(o,c),s=c),l.setEditMode(o,1);let d=l.getEditMode(o);console.log(`[LOK Worker] Edit mode: ${d}`),l.registerCallback(o),l.clearCallbackQueue(),console.log("[LOK Worker] Callback registered for STATE_CHANGED events");try{l.postMouseEvent(o,0,1e3,1e3,1,1,0),l.postMouseEvent(o,1,1e3,1e3,1,1,0),i.push({operation:"establishFocus",success:!0,result:"Mouse click events sent"});}catch(u){i.push({operation:"establishFocus",success:!1,error:String(u)});}console.log("[LOK Worker] Testing SelectAll + getTextSelection...");try{l.postUnoCommand(o,".uno:SelectAll");let u=l.getTextSelection(o,"text/plain;charset=utf-8"),g=u?.length||0;console.log(`[LOK Worker] SelectAll result: ${g} chars, preview: "${u?.slice(0,100)}..."`),i.push({operation:"SelectAll+getTextSelection",success:g>0,result:{textLength:g,preview:u?.slice(0,200)}});}catch(u){console.error("[LOK Worker] SelectAll error:",u),i.push({operation:"SelectAll+getTextSelection",success:!1,error:String(u)});}console.log("[LOK Worker] Testing getSelectionType...");try{let u=l.getSelectionType(o);console.log(`[LOK Worker] Selection type: ${u}`),i.push({operation:"getSelectionType",success:!0,result:{selectionType:u,meaning:u===0?"NONE":u===1?"TEXT":u===2?"CELL":"UNKNOWN"}});}catch(u){console.error("[LOK Worker] getSelectionType error:",u),i.push({operation:"getSelectionType",success:!1,error:String(u)});}console.log("[LOK Worker] Testing resetSelection...");try{l.resetSelection(o);let u=l.getSelectionType(o);console.log(`[LOK Worker] Selection type after reset: ${u}`),i.push({operation:"resetSelection",success:!0,result:{selectionTypeAfterReset:u}});}catch(u){console.error("[LOK Worker] resetSelection error:",u),i.push({operation:"resetSelection",success:!1,error:String(u)});}console.log("[LOK Worker] Testing GoToStartOfDoc + selection + Delete...");try{l.postUnoCommand(o,".uno:GoToStartOfDoc"),console.log("[LOK Worker] Sent GoToStartOfDoc"),l.postUnoCommand(o,".uno:WordRightSel"),console.log("[LOK Worker] Sent WordRightSel");let u=l.getTextSelection(o,"text/plain;charset=utf-8");console.log(`[LOK Worker] Selected text before delete: "${u}"`),l.postUnoCommand(o,".uno:Delete"),console.log("[LOK Worker] Sent Delete"),i.push({operation:"SelectWord+Delete",success:!0,result:{deletedText:u}});}catch(u){console.error("[LOK Worker] SelectWord+Delete error:",u),i.push({operation:"SelectWord+Delete",success:!1,error:String(u)});}console.log("[LOK Worker] Testing Undo...");try{l.postUnoCommand(o,".uno:Undo"),console.log("[LOK Worker] Sent Undo"),l.postUnoCommand(o,".uno:SelectAll");let u=l.getTextSelection(o,"text/plain;charset=utf-8");console.log(`[LOK Worker] Text after Undo: ${u?.length} chars`),i.push({operation:"Undo",success:!0,result:{textLengthAfterUndo:u?.length||0}});}catch(u){console.error("[LOK Worker] Undo error:",u),i.push({operation:"Undo",success:!1,error:String(u)});}console.log("[LOK Worker] Testing Redo...");try{l.postUnoCommand(o,".uno:Redo"),console.log("[LOK Worker] Sent Redo"),l.postUnoCommand(o,".uno:SelectAll");let u=l.getTextSelection(o,"text/plain;charset=utf-8");console.log(`[LOK Worker] Text after Redo: ${u?.length} chars`),i.push({operation:"Redo",success:!0,result:{textLengthAfterRedo:u?.length||0}});}catch(u){console.error("[LOK Worker] Redo error:",u),i.push({operation:"Redo",success:!1,error:String(u)});}console.log("[LOK Worker] Testing Bold formatting...");try{l.postUnoCommand(o,".uno:Undo"),l.postUnoCommand(o,".uno:GoToStartOfDoc"),l.postUnoCommand(o,".uno:WordRightSel");let u=l.getTextSelection(o,"text/plain;charset=utf-8");console.log(`[LOK Worker] Selected for bold: "${u}"`),l.postUnoCommand(o,".uno:Bold"),console.log("[LOK Worker] Sent Bold");let g=l.getCommandValues(o,".uno:Bold");console.log(`[LOK Worker] Bold state: ${g}`),i.push({operation:"Bold",success:!0,result:{selectedText:u,boldState:g}});}catch(u){console.error("[LOK Worker] Bold error:",u),i.push({operation:"Bold",success:!1,error:String(u)});}console.log("[LOK Worker] Testing Italic formatting...");try{l.postUnoCommand(o,".uno:GoRight"),l.postUnoCommand(o,".uno:WordRightSel");let u=l.getTextSelection(o,"text/plain;charset=utf-8");console.log(`[LOK Worker] Selected for italic: "${u}"`),l.postUnoCommand(o,".uno:Italic"),console.log("[LOK Worker] Sent Italic");let g=l.getCommandValues(o,".uno:Italic");console.log(`[LOK Worker] Italic state: ${g}`),i.push({operation:"Italic",success:!0,result:{selectedText:u,italicState:g}});}catch(u){console.error("[LOK Worker] Italic error:",u),i.push({operation:"Italic",success:!1,error:String(u)});}console.log("[LOK Worker] Testing getCharacterFormatting via STATE_CHANGED callbacks...");try{let u=l.getCallbackEventCount();console.log(`[LOK Worker] Existing events in queue: ${u}`);let g=l.pollStateChanges();console.log(`[LOK Worker] Existing STATE_CHANGED events: ${g.size}`);for(let[k,O]of g.entries())console.log(`[LOK Worker]   ${k} = ${O}`);l.clearCallbackQueue(),l.postUnoCommand(o,".uno:GoToStartOfDoc"),l.flushCallbacks(o),l.postUnoCommand(o,".uno:WordRightSel"),l.flushCallbacks(o);let y=l.getCallbackEventCount(),_=l.hasCallbackEvents();console.log(`[LOK Worker] Event count after WordRightSel: ${y}, hasEvents: ${_}`);let p=l.pollStateChanges();console.log(`[LOK Worker] State changes after selection: ${p.size}`);for(let[k,O]of p.entries())console.log(`[LOK Worker]   ${k} = ${O}`);for(let[k,O]of g.entries())p.has(k)||p.set(k,O);let E={};for(let[k,O]of p.entries())E[k]=O;console.log(`[LOK Worker] Received ${p.size} state changes:`);for(let[k,O]of p.entries())console.log(`  ${k} = ${O}`);let C=p.get(".uno:Bold")??null,v=p.get(".uno:Italic")??null,W=p.get(".uno:Underline")??null,M=p.get(".uno:CharFontName")??null,b=p.get(".uno:FontHeight")??null,V=p.get(".uno:Color")??p.get(".uno:CharColor")??null;console.log("[LOK Worker] Character formatting from STATE_CHANGED:"),console.log(`  Bold: ${C}`),console.log(`  Italic: ${v}`),console.log(`  Underline: ${W}`),console.log(`  FontName: ${M}`),console.log(`  FontSize: ${b}`),console.log(`  Color: ${V}`),i.push({operation:"getCharacterFormatting",success:!0,result:{stateChangeCount:p.size,note:p.size===0?"Callback queue empty - C++ shims may need to be added to WASM build":void 0,bold:C,italic:v,underline:W,fontName:M,fontSize:b,color:V,allStates:E}});}catch(u){console.error("[LOK Worker] getCharacterFormatting error:",u),i.push({operation:"getCharacterFormatting",success:!1,error:String(u)});}console.log("[LOK Worker] Testing setTextSelection...");try{l.resetSelection(o),l.setTextSelection(o,0,500,500),l.setTextSelection(o,1,3e3,500);let u=l.getTextSelection(o,"text/plain;charset=utf-8");console.log(`[LOK Worker] Coordinate-selected text: "${u}"`),i.push({operation:"setTextSelection",success:!0,result:{selectedText:u}});}catch(u){console.error("[LOK Worker] setTextSelection error:",u),i.push({operation:"setTextSelection",success:!1,error:String(u)});}console.log("[LOK Worker] Testing document save...");try{let u=t||"docx",y={docx:"docx",doc:"doc",odt:"odt",xlsx:"xlsx",xls:"xls",ods:"ods",pptx:"pptx",ppt:"ppt",odp:"odp"}[u]||u;l.documentSaveAs(o,n,y,"");let _=S.FS.readFile(n);i.push({operation:"documentSave",success:_.length>0,result:{savedBytes:_.length,originalBytes:e.length}});}catch(u){console.error("[LOK Worker] Save error:",u),i.push({operation:"documentSave",success:!1,error:String(u)});}let m=`${i.filter(u=>u.success).length}/${i.length} operations succeeded`;console.log(`[LOK Worker] Test results summary: ${m}`),f({type:"testLokOperations",id:a.id,testLokOperationsResult:{operations:i,summary:m}});}catch(c){console.error("[LOK Worker] Error in handleTestLokOperations:",c),f({type:"error",id:a.id,error:c instanceof Error?c.message:String(c)});}finally{if(o!==0&&l){try{l.unregisterCallback(o);}catch{}if(s>=0)try{l.destroyView(o,s);}catch{}try{l.documentDestroy(o);}catch{}}if(S){try{S.FS.unlink(r);}catch{}try{S.FS.unlink(n);}catch{}}}}async function Le(a){if(!L||!S||!l){f({type:"error",id:a.id,error:"Worker not initialized"});return}let e=a.inputData,t=a.inputExt||"docx";if(!e||e.length===0){f({type:"error",id:a.id,error:"No input data provided"});return}try{let r=`session_${++de}_${Date.now()}`,n=`/tmp/edit_${r}.${t}`;S.FS.writeFile(n,e);let o=l.documentLoad(n);if(o===0){let h=l.getError();S.FS.unlink(n),f({type:"error",id:a.id,error:`Failed to load document: ${h}`});return}l.documentInitializeForRendering(o);let s=l.createView(o);l.setView(o,s),l.registerCallback(o),l.postUnoCommand(o,".uno:Edit");let i=q(l,o),c=i.getDocumentType(),d=l.documentGetParts(o);K.set(r,{sessionId:r,docPtr:o,filePath:n,editor:i,documentType:c}),console.log(`[LOK Worker] Opened document session: ${r}, type: ${c}, pages: ${d}`),f({type:"editorSession",id:a.id,editorSession:{sessionId:r,documentType:c,pageCount:d}});}catch(r){console.error("[LOK Worker] Error in handleOpenDocument:",r),f({type:"error",id:a.id,error:r instanceof Error?r.message:String(r)});}}async function Te(a){let{sessionId:e,editorMethod:t,editorArgs:r}=a;if(!e||!t){f({type:"error",id:a.id,error:"Missing sessionId or editorMethod"});return}let n=K.get(e);if(!n){f({type:"error",id:a.id,error:`Session not found: ${e}`});return}try{let{editor:o}=n,s=r||[],i=o[t];if(typeof i!="function"){f({type:"error",id:a.id,error:`Unknown editor method: ${t}`});return}let c=i.apply(o,s),d=c.data;c.data instanceof Map&&(d=Object.fromEntries(c.data)),f({type:"editorOperationResult",id:a.id,editorOperationResult:{success:c.success,verified:c.verified,data:d,error:c.error,suggestion:c.suggestion}});}catch(o){console.error(`[LOK Worker] Error in handleEditorOperation (${t}):`,o),f({type:"error",id:a.id,error:o instanceof Error?o.message:String(o)});}}async function xe(a){let{sessionId:e}=a;if(!e){f({type:"error",id:a.id,error:"Missing sessionId"});return}let t=K.get(e);if(!t){f({type:"error",id:a.id,error:`Session not found: ${e}`});return}try{let{docPtr:r,filePath:n}=t,o;if(S)try{let s=n.split(".").pop()||"docx";l?.documentSaveAs(r,n,s,""),o=S.FS.readFile(n);}catch(s){console.warn("[LOK Worker] Could not save document:",s);}if(l&&r!==0){try{l.unregisterCallback(r);}catch{}try{l.documentDestroy(r);}catch{}}if(S)try{S.FS.unlink(n);}catch{}K.delete(e),console.log(`[LOK Worker] Closed document session: ${e}`),f({type:"documentClosed",id:a.id,data:o});}catch(r){console.error("[LOK Worker] Error in handleCloseDocument:",r),f({type:"error",id:a.id,error:r instanceof Error?r.message:String(r)});}}function we(a){console.log("handleDestroy");for(let[,e]of K)try{if(l&&e.docPtr!==0){try{l.unregisterCallback(e.docPtr);}catch{}try{l.documentDestroy(e.docPtr);}catch{}}if(S)try{S.FS.unlink(e.filePath);}catch{}}catch{}if(K.clear(),w(),l){try{l.destroy();}catch{}l=null;}if(S&&S.PThread?.terminateAllThreads)try{S.PThread.terminateAllThreads();}catch{}S=null,L=false,f({type:"ready",id:a.id}),setTimeout(()=>self.close(),100);}self.onmessage=async a=>{let e=a.data;switch(e.type){case "init":await pe(e);break;case "convert":await fe(e);break;case "getPageCount":await ye(e);break;case "renderPreviews":await _e(e);break;case "renderSinglePage":await Ee(e);break;case "renderPageViaConvert":await Ce(e);break;case "getDocumentInfo":await be(e);break;case "getLokInfo":await ke(e);break;case "editText":await Oe(e);break;case "renderPageRectangles":await Pe(e);break;case "testLokOperations":await Re(e);break;case "openDocument":await Le(e);break;case "editorOperation":await Te(e);break;case "closeDocument":await xe(e);break;case "destroy":we(e);break}};self.postMessage({type:"loaded"});
})();//# sourceMappingURL=browser.worker.global.js.map
//# sourceMappingURL=browser.worker.global.js.map