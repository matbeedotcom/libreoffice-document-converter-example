(function(){'use strict';var S=class extends Error{code;details;constructor(e,t,r){super(t),this.name="ConversionError",this.code=e,this.details=r;}},te={pdf:"writer_pdf_Export",docx:"MS Word 2007 XML",doc:"MS Word 97",odt:"writer8",rtf:"Rich Text Format",txt:"Text",html:"HTML (StarWriter)",xlsx:"Calc MS Excel 2007 XML",xls:"MS Excel 97",ods:"calc8",csv:"Text - txt - csv (StarCalc)",pptx:"Impress MS PowerPoint 2007 XML",ppt:"MS PowerPoint 97",odp:"impress8",png:"writer_png_Export",jpg:"writer_jpg_Export",svg:"writer_svg_Export"};var ae={pdf:"application/pdf",docx:"application/vnd.openxmlformats-officedocument.wordprocessingml.document",doc:"application/msword",odt:"application/vnd.oasis.opendocument.text",rtf:"application/rtf",txt:"text/plain",html:"text/html",xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",xls:"application/vnd.ms-excel",ods:"application/vnd.oasis.opendocument.spreadsheet",csv:"text/csv",pptx:"application/vnd.openxmlformats-officedocument.presentationml.presentation",ppt:"application/vnd.ms-powerpoint",odp:"application/vnd.oasis.opendocument.presentation",png:"image/png",jpg:"image/jpeg",svg:"image/svg+xml"},le={doc:"doc",docx:"docx",xls:"xls",xlsx:"xlsx",ppt:"ppt",pptx:"pptx",odt:"odt",ods:"ods",odp:"odp",odg:"odg",odf:"odf",rtf:"rtf",txt:"txt",html:"html",htm:"html",csv:"csv",xml:"xml",epub:"epub",pdf:"pdf"},Oe={0:["pdf","docx","doc","odt","rtf","txt","html","png"],1:["pdf","xlsx","xls","ods","csv","html","png"],2:["pdf","pptx","ppt","odp","png","svg","html"],3:["pdf","png","svg","html"],4:["pdf"]};function ce(l){return Oe[l]||["pdf"]}var K={pdf:"pdf",docx:"docx",doc:"doc",odt:"odt",rtf:"rtf",txt:"txt",html:"html",xlsx:"xlsx",xls:"xls",ods:"ods",csv:"csv",pptx:"pptx",ppt:"ppt",odp:"odp",png:"png",jpg:"jpg",svg:"svg"},M={pdf:"",csv:"44,34,76,1,,0,false,true,false,false,false,-1",txt:"UTF8"},ue={doc:"text",docx:"text",odt:"text",rtf:"text",txt:"text",html:"text",htm:"text",epub:"text",xml:"text",xls:"spreadsheet",xlsx:"spreadsheet",ods:"spreadsheet",csv:"spreadsheet",ppt:"presentation",pptx:"presentation",odp:"presentation",odg:"drawing",odf:"drawing",pdf:"drawing"},ke={text:["pdf","docx","doc","odt","rtf","txt","html","png"],spreadsheet:["pdf","xlsx","xls","ods","csv","html","png"],presentation:["pdf","pptx","ppt","odp","png","svg","html"],drawing:["pdf","png","svg","html"],other:["pdf"]};function z(l){let e=l.toLowerCase(),t=ue[e];return t?ke[t]:["pdf"]}function re(l,e){return z(l).includes(e.toLowerCase())}function de(l,e){let t=l.toLowerCase(),r=e.toLowerCase(),n=z(t),o=ue[t]||"unknown",i="";return o==="drawing"&&["docx","doc","xlsx","xls","pptx","ppt"].includes(r)?i="PDF files are imported as Draw documents and cannot be exported to Office formats. ":o==="spreadsheet"&&["docx","doc","pptx","ppt"].includes(r)?i="Spreadsheet documents cannot be converted to word processing or presentation formats. ":o==="presentation"&&["docx","doc","xlsx","xls"].includes(r)?i="Presentation documents cannot be converted to word processing or spreadsheet formats. ":o==="text"&&["xlsx","xls","pptx","ppt"].includes(r)&&(i="Text documents cannot be converted to spreadsheet or presentation formats. "),`Cannot convert ${t.toUpperCase()} to ${r.toUpperCase()}. ${i}Valid output formats for ${t.toUpperCase()}: ${n.join(", ")}`}var A=class{lok;docPtr;options;inputPath="";constructor(e,t,r={}){this.lok=e,this.docPtr=t,this.options={maxResponseChars:r.maxResponseChars??8e3,...r};}getDocPtr(){return this.docPtr}getLokBindings(){return this.lok}save(){try{return this.inputPath?(this.lok.postUnoCommand(this.docPtr,".uno:Save"),this.createResult({path:this.inputPath})):this.createErrorResult("No input path set","Use saveAs() to specify a path")}catch(e){return this.createErrorResult(`Save failed: ${String(e)}`)}}saveAs(e,t){try{return this.lok.documentSaveAs(this.docPtr,e,t,""),this.createResult({path:e})}catch(r){return this.createErrorResult(`SaveAs failed: ${String(r)}`)}}close(){try{return this.lok.documentDestroy(this.docPtr),this.docPtr=0,this.createResult(void 0)}catch(e){return this.createErrorResult(`Close failed: ${String(e)}`)}}getEditMode(){return this.lok.getEditMode(this.docPtr)}enableEditMode(){try{if(this.lok.getEditMode(this.docPtr)===1)return this.createResult({editMode:1});this.lok.postUnoCommand(this.docPtr,".uno:Edit");let t=this.lok.getEditMode(this.docPtr);return {success:!0,verified:t===1,data:{editMode:t}}}catch(e){return this.createErrorResult(`Failed to enable edit mode: ${String(e)}`)}}undo(){try{return this.lok.postUnoCommand(this.docPtr,".uno:Undo"),this.createResult(void 0)}catch(e){return this.createErrorResult(`Undo failed: ${String(e)}`)}}redo(){try{return this.lok.postUnoCommand(this.docPtr,".uno:Redo"),this.createResult(void 0)}catch(e){return this.createErrorResult(`Redo failed: ${String(e)}`)}}find(e,t){try{let r=JSON.stringify({"SearchItem.SearchString":{type:"string",value:e},"SearchItem.Backward":{type:"boolean",value:!1},"SearchItem.SearchAll":{type:"boolean",value:!0},"SearchItem.MatchCase":{type:"boolean",value:t?.caseSensitive??!1},"SearchItem.WordOnly":{type:"boolean",value:t?.wholeWord??!1}});this.lok.postUnoCommand(this.docPtr,".uno:ExecuteSearch",r);let n=this.lok.getTextSelection(this.docPtr,"text/plain"),o=n!==null&&n.length>0;return this.createResult({matches:o?1:0,firstMatch:o?{x:0,y:0}:void 0})}catch(r){return this.createErrorResult(`Find failed: ${String(r)}`)}}findAndReplaceAll(e,t,r){try{let n=JSON.stringify({"SearchItem.SearchString":{type:"string",value:e},"SearchItem.ReplaceString":{type:"string",value:t},"SearchItem.Command":{type:"long",value:3},"SearchItem.MatchCase":{type:"boolean",value:r?.caseSensitive??!1},"SearchItem.WordOnly":{type:"boolean",value:r?.wholeWord??!1}});return this.lok.postUnoCommand(this.docPtr,".uno:ExecuteSearch",n),this.createResult({replacements:-1})}catch(n){return this.createErrorResult(`Replace failed: ${String(n)}`)}}getStateChanges(){try{let e=this.lok.pollStateChanges();return this.createResult(e)}catch(e){return this.createErrorResult(`Failed to poll state changes: ${String(e)}`)}}flushAndPollState(){try{this.lok.flushCallbacks(this.docPtr);let e=this.lok.pollStateChanges();return this.createResult(e)}catch(e){return this.createErrorResult(`Failed to flush and poll state: ${String(e)}`)}}clearCallbackQueue(){this.lok.clearCallbackQueue();}select(e){try{let t=this.lok.getTextSelection(this.docPtr,"text/plain");return this.createResult({selected:t||""})}catch(t){return this.createErrorResult(`Select failed: ${String(t)}`)}}getSelection(){try{let e=this.lok.getTextSelection(this.docPtr,"text/plain");return this.createResult({text:e||"",range:{type:"text",start:{paragraph:0,character:0}}})}catch(e){return this.createErrorResult(`GetSelection failed: ${String(e)}`)}}clearSelection(){try{return this.lok.resetSelection(this.docPtr),this.createResult(void 0)}catch(e){return this.createErrorResult(`ClearSelection failed: ${String(e)}`)}}createResult(e){return {success:true,verified:true,data:e}}createErrorResult(e,t){return {success:false,verified:false,error:e,suggestion:t}}createResultWithTruncation(e,t){return {success:true,verified:true,data:e,truncated:t}}truncateContent(e,t){let r=t??this.options.maxResponseChars,n=e.length;if(n<=r)return {content:e,truncated:false,original:n,returned:n};let o=e.slice(0,r),i=o.lastIndexOf(" ");return i>r*.8&&(o=o.slice(0,i)),{content:o,truncated:true,original:n,returned:o.length}}truncateArray(e,t,r){let n=e.length,o=0,i=0;for(let s of e){let a=r(s);if(o+a.length>t)break;o+=a.length,i++;}return {items:e.slice(0,i),truncated:i<n,original:n,returned:i}}a1ToRowCol(e){let t=e.match(/^([A-Z]+)(\d+)$/i);if(!t)throw new Error(`Invalid A1 notation: ${e}`);let r=t[1].toUpperCase(),n=t[2],o=0;for(let s=0;s<r.length;s++)o=o*26+(r.charCodeAt(s)-64);return o-=1,{row:parseInt(n,10)-1,col:o}}rowColToA1(e,t){let r="",n=t+1;for(;n>0;){let o=(n-1)%26;r=String.fromCharCode(65+o)+r,n=Math.floor((n-1)/26);}return `${r}${e+1}`}normalizeCellRef(e){return typeof e=="string"?this.a1ToRowCol(e):e}setInputPath(e){this.inputPath=e;}isOpen(){return this.docPtr!==0}};var G=class extends A{cachedParagraphs=null;getDocumentType(){return "writer"}getStructure(e){try{let t=this.getParagraphsInternal(),r=e?.maxResponseChars??this.options.maxResponseChars,n=t.map((s,a)=>({index:a,preview:s.slice(0,100)+(s.length>100?"...":""),style:"Normal",charCount:s.length})),o=this.truncateArray(n,r,s=>JSON.stringify(s)),i={type:"writer",paragraphs:o.items,pageCount:this.lok.documentGetParts(this.docPtr),wordCount:t.join(" ").split(/\s+/).filter(s=>s.length>0).length};return o.truncated?this.createResultWithTruncation(i,{original:o.original,returned:o.returned,message:`Showing ${o.returned} of ${o.original} paragraphs. Use getParagraphs(start, count) to paginate.`}):this.createResult(i)}catch(t){return this.createErrorResult(`Failed to get structure: ${String(t)}`)}}getParagraph(e){try{let t=this.getParagraphsInternal();if(e<0||e>=t.length)return this.createErrorResult(`Paragraph index ${e} out of range (0-${t.length-1})`,"Use getStructure() to see available paragraphs");let r=t[e];return this.createResult({index:e,text:r,style:"Normal",charCount:r.length})}catch(t){return this.createErrorResult(`Failed to get paragraph: ${String(t)}`)}}getParagraphs(e,t){try{let r=this.getParagraphsInternal();if(e<0||e>=r.length)return this.createErrorResult(`Start index ${e} out of range`,`Valid range: 0-${r.length-1}`);let n=Math.min(e+t,r.length),o=r.slice(e,n).map((i,s)=>({index:e+s,text:i,style:"Normal",charCount:i.length}));return this.createResult(o)}catch(r){return this.createErrorResult(`Failed to get paragraphs: ${String(r)}`)}}insertParagraph(e,t){try{let r=this.getParagraphsInternal(),n=t?.afterIndex!==void 0?t.afterIndex+1:r.length;n>0&&n<=r.length&&this.lok.postUnoCommand(this.docPtr,".uno:GoToEndOfDoc"),this.lok.postUnoCommand(this.docPtr,".uno:InsertPara");let o=JSON.stringify({Text:{type:"string",value:e}});if(this.lok.postUnoCommand(this.docPtr,".uno:InsertText",o),t?.style&&t.style!=="Normal"){let d={"Heading 1":"Heading 1","Heading 2":"Heading 2","Heading 3":"Heading 3",List:"List"}[t.style];if(d){let h=JSON.stringify({Template:{type:"string",value:d},Family:{type:"short",value:2}});this.lok.postUnoCommand(this.docPtr,".uno:StyleApply",h);}}return this.cachedParagraphs=null,{success:!0,verified:this.getParagraphsInternal().length>r.length,data:{index:n}}}catch(r){return this.createErrorResult(`Failed to insert paragraph: ${String(r)}`)}}replaceParagraph(e,t){try{let r=this.getParagraphsInternal();if(e<0||e>=r.length)return this.createErrorResult(`Paragraph index ${e} out of range`,`Valid range: 0-${r.length-1}`);let n=r[e],o=JSON.stringify({"SearchItem.SearchString":{type:"string",value:n},"SearchItem.ReplaceString":{type:"string",value:t},"SearchItem.Command":{type:"long",value:2}});return this.lok.postUnoCommand(this.docPtr,".uno:ExecuteSearch",o),this.cachedParagraphs=null,this.createResult({oldText:n})}catch(r){return this.createErrorResult(`Failed to replace paragraph: ${String(r)}`)}}deleteParagraph(e){try{let t=this.getParagraphsInternal();if(e<0||e>=t.length)return this.createErrorResult(`Paragraph index ${e} out of range`,`Valid range: 0-${t.length-1}`);let r=t[e],n=this.replaceParagraph(e,"");return n.success?this.createResult({deletedText:r}):this.createErrorResult(n.error||"Failed to delete")}catch(t){return this.createErrorResult(`Failed to delete paragraph: ${String(t)}`)}}insertText(e,t){try{let r=JSON.stringify({Text:{type:"string",value:e}});return this.lok.postUnoCommand(this.docPtr,".uno:InsertText",r),this.cachedParagraphs=null,this.createResult(void 0)}catch(r){return this.createErrorResult(`Failed to insert text: ${String(r)}`)}}deleteText(e,t){try{let r=this.lok.getTextSelection(this.docPtr,"text/plain");return this.lok.postUnoCommand(this.docPtr,".uno:Delete"),this.cachedParagraphs=null,this.createResult({deleted:r||""})}catch(r){return this.createErrorResult(`Failed to delete text: ${String(r)}`)}}replaceText(e,t,r){try{let n=r?.all?3:2,o=JSON.stringify({"SearchItem.SearchString":{type:"string",value:e},"SearchItem.ReplaceString":{type:"string",value:t},"SearchItem.Command":{type:"long",value:n}});return this.lok.postUnoCommand(this.docPtr,".uno:ExecuteSearch",o),this.cachedParagraphs=null,this.createResult({replacements:-1})}catch(n){return this.createErrorResult(`Failed to replace text: ${String(n)}`)}}formatText(e,t){try{if(t.bold!==void 0&&this.lok.postUnoCommand(this.docPtr,".uno:Bold"),t.italic!==void 0&&this.lok.postUnoCommand(this.docPtr,".uno:Italic"),t.underline!==void 0&&this.lok.postUnoCommand(this.docPtr,".uno:Underline"),t.fontSize!==void 0){let r=JSON.stringify({FontHeight:{type:"float",value:t.fontSize}});this.lok.postUnoCommand(this.docPtr,".uno:FontHeight",r);}if(t.fontName!==void 0){let r=JSON.stringify({CharFontName:{type:"string",value:t.fontName}});this.lok.postUnoCommand(this.docPtr,".uno:CharFontName",r);}return this.createResult(void 0)}catch(r){return this.createErrorResult(`Failed to format text: ${String(r)}`)}}getFormat(e){try{this.lok.clearCallbackQueue(),this.lok.postUnoCommand(this.docPtr,".uno:CharRightSel"),this.lok.flushCallbacks(this.docPtr),this.lok.postUnoCommand(this.docPtr,".uno:CharLeft"),this.lok.flushCallbacks(this.docPtr);let t=this.lok.pollStateChanges(),r={},n=t.get(".uno:Bold");n!==void 0&&(r.bold=n==="true");let o=t.get(".uno:Italic");o!==void 0&&(r.italic=o==="true");let i=t.get(".uno:Underline");i!==void 0&&(r.underline=i==="true");let s=t.get(".uno:FontHeight");if(s!==void 0){let d=parseFloat(s);isNaN(d)||(r.fontSize=d);}let a=t.get(".uno:CharFontName");return a!==void 0&&a.length>0&&(r.fontName=a),this.createResult(r)}catch(t){return this.createErrorResult(`Failed to get format: ${String(t)}`)}}getSelectionFormat(){try{let e=this.lok.pollStateChanges();if(e.size===0){this.lok.clearCallbackQueue(),this.lok.postUnoCommand(this.docPtr,".uno:SelectWord"),this.lok.flushCallbacks(this.docPtr);let t=this.lok.pollStateChanges();return this.createResult(t)}return this.createResult(e)}catch(e){return this.createErrorResult(`Failed to get selection format: ${String(e)}`)}}getParagraphsInternal(){if(this.cachedParagraphs)return this.cachedParagraphs;let e=this.lok.getAllText(this.docPtr);return e?(this.cachedParagraphs=e.split(/\n\n|\r\n\r\n/).map(t=>t.trim()).filter(t=>t.length>0),this.cachedParagraphs):[]}};var H=class extends A{getDocumentType(){return "calc"}getStructure(e){try{let t=this.lok.documentGetParts(this.docPtr),r=[];for(let o=0;o<t;o++){let i=this.lok.getPartName(this.docPtr,o)||`Sheet${o+1}`,s=this.lok.getDataArea(this.docPtr,o);r.push({index:o,name:i,usedRange:s.col>0&&s.row>0?`A1:${this.rowColToA1(s.row-1,s.col-1)}`:"A1",rowCount:s.row,colCount:s.col});}let n={type:"calc",sheets:r};return this.createResult(n)}catch(t){return this.createErrorResult(`Failed to get structure: ${String(t)}`)}}getSheetNames(){try{let e=this.lok.documentGetParts(this.docPtr),t=[];for(let r=0;r<e;r++){let n=this.lok.getPartName(this.docPtr,r)||`Sheet${r+1}`;t.push(n);}return this.createResult(t)}catch(e){return this.createErrorResult(`Failed to get sheet names: ${String(e)}`)}}getCell(e,t){try{this.selectSheet(t);let{row:r,col:n}=this.normalizeCellRef(e),o=this.rowColToA1(r,n);this.goToCell(o);let i=this.getCellValueInternal(),s=this.getCellFormulaInternal();return this.createResult({address:o,value:i,formula:s||void 0})}catch(r){return this.createErrorResult(`Failed to get cell: ${String(r)}`)}}getCells(e,t,r){try{this.selectSheet(t);let{startRow:n,startCol:o,endRow:i,endCol:s}=this.normalizeRangeRef(e),a=r?.maxResponseChars??this.options.maxResponseChars,d=[],h=0,m=!1;for(let u=n;u<=i&&!m;u++){let g=[];for(let _=o;_<=s&&!m;_++){let E=this.rowColToA1(u,_);this.goToCell(E);let p=this.getCellValueInternal(),O={address:E,value:p},k=JSON.stringify(O);if(h+k.length>a){m=!0;break}h+=k.length,g.push(O);}g.length>0&&d.push(g);}return m?this.createResultWithTruncation(d,{original:(i-n+1)*(s-o+1),returned:d.reduce((u,g)=>u+g.length,0),message:"Range truncated due to size. Use smaller ranges to paginate."}):this.createResult(d)}catch(n){return this.createErrorResult(`Failed to get cells: ${String(n)}`)}}setCellValue(e,t,r){try{this.selectSheet(r);let{row:n,col:o}=this.normalizeCellRef(e),i=this.rowColToA1(n,o);this.goToCell(i);let s=this.getCellValueInternal(),a=typeof t=="number"?t.toString():t,d=JSON.stringify({StringName:{type:"string",value:a}});this.lok.postUnoCommand(this.docPtr,".uno:EnterString",d);let h=this.getCellValueInternal(),m=typeof t=="number"?t.toString():t;return {success:!0,verified:h===m||h===t,data:{oldValue:s,newValue:h}}}catch(n){return this.createErrorResult(`Failed to set cell value: ${String(n)}`)}}setCellFormula(e,t,r){try{this.selectSheet(r);let{row:n,col:o}=this.normalizeCellRef(e),i=this.rowColToA1(n,o);this.goToCell(i);let s=JSON.stringify({StringName:{type:"string",value:t}});this.lok.postUnoCommand(this.docPtr,".uno:EnterString",s);let a=this.getCellValueInternal();return this.createResult({calculatedValue:a})}catch(n){return this.createErrorResult(`Failed to set formula: ${String(n)}`)}}setCells(e,t,r){try{this.selectSheet(r);let{startRow:n,startCol:o}=this.normalizeRangeRef(e),i=0;for(let s=0;s<t.length;s++){let a=t[s];if(a)for(let d=0;d<a.length;d++){let h=a[d];if(h==null)continue;let m=this.rowColToA1(n+s,o+d);this.goToCell(m);let u=typeof h=="number"?h.toString():String(h),g=JSON.stringify({StringName:{type:"string",value:u}});this.lok.postUnoCommand(this.docPtr,".uno:EnterString",g),i++;}}return this.createResult({cellsUpdated:i})}catch(n){return this.createErrorResult(`Failed to set cells: ${String(n)}`)}}clearCell(e,t){try{this.selectSheet(t);let{row:r,col:n}=this.normalizeCellRef(e),o=this.rowColToA1(r,n);this.goToCell(o);let i=this.getCellValueInternal();return this.lok.postUnoCommand(this.docPtr,".uno:ClearContents"),this.createResult({oldValue:i})}catch(r){return this.createErrorResult(`Failed to clear cell: ${String(r)}`)}}clearRange(e,t){try{this.selectSheet(t);let r=this.normalizeRangeToString(e);this.goToCell(r),this.lok.postUnoCommand(this.docPtr,".uno:ClearContents");let{startRow:n,startCol:o,endRow:i,endCol:s}=this.normalizeRangeRef(e),a=(i-n+1)*(s-o+1);return this.createResult({cellsCleared:a})}catch(r){return this.createErrorResult(`Failed to clear range: ${String(r)}`)}}insertRow(e,t){try{return this.selectSheet(t),this.goToCell(this.rowColToA1(e+1,0)),this.lok.postUnoCommand(this.docPtr,".uno:InsertRows"),this.createResult(void 0)}catch(r){return this.createErrorResult(`Failed to insert row: ${String(r)}`)}}insertColumn(e,t){try{this.selectSheet(t);let r=typeof e=="string"?this.a1ToRowCol(e+"1").col+1:e+1;return this.goToCell(this.rowColToA1(0,r)),this.lok.postUnoCommand(this.docPtr,".uno:InsertColumns"),this.createResult(void 0)}catch(r){return this.createErrorResult(`Failed to insert column: ${String(r)}`)}}deleteRow(e,t){try{return this.selectSheet(t),this.goToCell(this.rowColToA1(e,0)),this.lok.postUnoCommand(this.docPtr,".uno:DeleteRows"),this.createResult(void 0)}catch(r){return this.createErrorResult(`Failed to delete row: ${String(r)}`)}}deleteColumn(e,t){try{this.selectSheet(t);let r=typeof e=="string"?this.a1ToRowCol(e+"1").col:e;return this.goToCell(this.rowColToA1(0,r)),this.lok.postUnoCommand(this.docPtr,".uno:DeleteColumns"),this.createResult(void 0)}catch(r){return this.createErrorResult(`Failed to delete column: ${String(r)}`)}}formatCells(e,t,r){try{this.selectSheet(r);let n=this.normalizeRangeToString(e);if(this.goToCell(n),t.bold!==void 0&&this.lok.postUnoCommand(this.docPtr,".uno:Bold"),t.numberFormat!==void 0){let o=JSON.stringify({NumberFormatValue:{type:"string",value:t.numberFormat}});this.lok.postUnoCommand(this.docPtr,".uno:NumberFormatValue",o);}if(t.backgroundColor!==void 0){let o=JSON.stringify({BackgroundColor:{type:"long",value:this.hexToNumber(t.backgroundColor)}});this.lok.postUnoCommand(this.docPtr,".uno:BackgroundColor",o);}return this.createResult(void 0)}catch(n){return this.createErrorResult(`Failed to format cells: ${String(n)}`)}}addSheet(e){try{let t=JSON.stringify({Name:{type:"string",value:e}});this.lok.postUnoCommand(this.docPtr,".uno:Insert",t);let r=this.lok.documentGetParts(this.docPtr);return this.createResult({index:r-1})}catch(t){return this.createErrorResult(`Failed to add sheet: ${String(t)}`)}}renameSheet(e,t){try{this.selectSheet(e);let r=JSON.stringify({Name:{type:"string",value:t}});return this.lok.postUnoCommand(this.docPtr,".uno:RenameTable",r),this.createResult(void 0)}catch(r){return this.createErrorResult(`Failed to rename sheet: ${String(r)}`)}}deleteSheet(e){try{return this.selectSheet(e),this.lok.postUnoCommand(this.docPtr,".uno:Remove"),this.createResult(void 0)}catch(t){return this.createErrorResult(`Failed to delete sheet: ${String(t)}`)}}selectSheet(e){if(e===void 0)return;let t=typeof e=="number"?e:this.getSheetIndexByName(e);t>=0&&this.lok.documentSetPart(this.docPtr,t);}getSheetIndexByName(e){let t=this.lok.documentGetParts(this.docPtr);for(let r=0;r<t;r++)if(this.lok.getPartName(this.docPtr,r)===e)return r;return  -1}goToCell(e){let t=JSON.stringify({ToPoint:{type:"string",value:e}});this.lok.postUnoCommand(this.docPtr,".uno:GoToCell",t);}getCellValueInternal(){let e=this.lok.getTextSelection(this.docPtr,"text/plain");if(!e)return null;let t=parseFloat(e);return !isNaN(t)&&e.trim()===t.toString()?t:e.toLowerCase()==="true"?true:e.toLowerCase()==="false"?false:e}getCellFormulaInternal(){let e=this.lok.getCommandValues(this.docPtr,".uno:GetFormulaBarText");if(!e)return null;try{return JSON.parse(e).value??null}catch{return null}}normalizeRangeRef(e){if(typeof e=="string"){let n=e.split(":"),o=this.a1ToRowCol(n[0]),i=n[1]?this.a1ToRowCol(n[1]):o;return {startRow:o.row,startCol:o.col,endRow:i.row,endCol:i.col}}let t=this.normalizeCellRef(e.start),r=this.normalizeCellRef(e.end);return {startRow:t.row,startCol:t.col,endRow:r.row,endCol:r.col}}normalizeRangeToString(e){if(typeof e=="string")return e;let t=this.normalizeCellRef(e.start),r=this.normalizeCellRef(e.end);return `${this.rowColToA1(t.row,t.col)}:${this.rowColToA1(r.row,r.col)}`}hexToNumber(e){return parseInt(e.replace("#",""),16)}};var j=class extends A{getDocumentType(){return "impress"}getStructure(e){try{let t=this.lok.documentGetParts(this.docPtr),r=[];for(let o=0;o<t;o++){let i=this.getSlideInfoInternal(o);r.push(i);}let n={type:"impress",slides:r,slideCount:t};return this.createResult(n)}catch(t){return this.createErrorResult(`Failed to get structure: ${String(t)}`)}}getSlide(e){try{let t=this.lok.documentGetParts(this.docPtr);if(e<0||e>=t)return this.createErrorResult(`Invalid slide index: ${e}. Valid range: 0-${t-1}`,"Use getStructure() to see available slides");this.lok.documentSetPart(this.docPtr,e);let r=this.lok.getAllText(this.docPtr)||"",n=this.parseTextFrames(r),o={index:e,title:n.find(i=>i.type==="title")?.text,textFrames:n,hasNotes:!1};return this.createResult(o)}catch(t){return this.createErrorResult(`Failed to get slide: ${String(t)}`)}}getSlideCount(){try{let e=this.lok.documentGetParts(this.docPtr);return this.createResult(e)}catch(e){return this.createErrorResult(`Failed to get slide count: ${String(e)}`)}}addSlide(e){try{let t=this.lok.documentGetParts(this.docPtr);e?.afterSlide!==void 0?this.lok.documentSetPart(this.docPtr,e.afterSlide):this.lok.documentSetPart(this.docPtr,t-1),this.lok.postUnoCommand(this.docPtr,".uno:InsertPage"),e?.layout&&this.applySlideLayout(e.layout);let r=e?.afterSlide!==void 0?e.afterSlide+1:t;return {success:!0,verified:this.lok.documentGetParts(this.docPtr)>t,data:{index:r}}}catch(t){return this.createErrorResult(`Failed to add slide: ${String(t)}`)}}deleteSlide(e){try{let t=this.lok.documentGetParts(this.docPtr);return t<=1?this.createErrorResult("Cannot delete the last slide","A presentation must have at least one slide"):e<0||e>=t?this.createErrorResult(`Invalid slide index: ${e}`,`Valid range: 0-${t-1}`):(this.lok.documentSetPart(this.docPtr,e),this.lok.postUnoCommand(this.docPtr,".uno:DeletePage"),this.createResult(void 0))}catch(t){return this.createErrorResult(`Failed to delete slide: ${String(t)}`)}}duplicateSlide(e){try{let t=this.lok.documentGetParts(this.docPtr);return e<0||e>=t?this.createErrorResult(`Invalid slide index: ${e}`,`Valid range: 0-${t-1}`):(this.lok.documentSetPart(this.docPtr,e),this.lok.postUnoCommand(this.docPtr,".uno:DuplicatePage"),this.createResult({newIndex:e+1}))}catch(t){return this.createErrorResult(`Failed to duplicate slide: ${String(t)}`)}}moveSlide(e,t){try{let r=this.lok.documentGetParts(this.docPtr);if(e<0||e>=r||t<0||t>=r)return this.createErrorResult(`Invalid slide indices. Valid range: 0-${r-1}`,"Check slide indices are within bounds");if(e===t)return this.createErrorResult("Source and destination are the same","Provide different indices to move");this.lok.documentSetPart(this.docPtr,e);let n=JSON.stringify({Position:{type:"long",value:t}});return this.lok.postUnoCommand(this.docPtr,".uno:MovePageFirst",n),this.createResult(void 0)}catch(r){return this.createErrorResult(`Failed to move slide: ${String(r)}`)}}setSlideTitle(e,t){try{let r=this.lok.documentGetParts(this.docPtr);if(e<0||e>=r)return this.createErrorResult(`Invalid slide index: ${e}`);this.lok.documentSetPart(this.docPtr,e);let n=this.lok.getAllText(this.docPtr)||"",i=this.parseTextFrames(n).find(a=>a.type==="title")?.text;this.lok.postUnoCommand(this.docPtr,".uno:SelectAll");let s=JSON.stringify({Text:{type:"string",value:t}});return this.lok.postUnoCommand(this.docPtr,".uno:InsertText",s),this.createResult({oldTitle:i})}catch(r){return this.createErrorResult(`Failed to set slide title: ${String(r)}`)}}setSlideBody(e,t){try{let r=this.lok.documentGetParts(this.docPtr);if(e<0||e>=r)return this.createErrorResult(`Invalid slide index: ${e}`);this.lok.documentSetPart(this.docPtr,e);let n=this.lok.getAllText(this.docPtr)||"",i=this.parseTextFrames(n).find(a=>a.type==="body")?.text;this.lok.postUnoCommand(this.docPtr,".uno:NextObject");let s=JSON.stringify({Text:{type:"string",value:t}});return this.lok.postUnoCommand(this.docPtr,".uno:InsertText",s),this.createResult({oldBody:i})}catch(r){return this.createErrorResult(`Failed to set slide body: ${String(r)}`)}}setSlideNotes(e,t){try{let r=this.lok.documentGetParts(this.docPtr);if(e<0||e>=r)return this.createErrorResult(`Invalid slide index: ${e}`);this.lok.documentSetPart(this.docPtr,e),this.lok.postUnoCommand(this.docPtr,".uno:NotesMode");let n=JSON.stringify({Text:{type:"string",value:t}});return this.lok.postUnoCommand(this.docPtr,".uno:InsertText",n),this.lok.postUnoCommand(this.docPtr,".uno:NormalViewMode"),this.createResult(void 0)}catch(r){return this.createErrorResult(`Failed to set slide notes: ${String(r)}`)}}setSlideLayout(e,t){try{let r=this.lok.documentGetParts(this.docPtr);return e<0||e>=r?this.createErrorResult(`Invalid slide index: ${e}`):(this.lok.documentSetPart(this.docPtr,e),this.applySlideLayout(t),this.createResult(void 0))}catch(r){return this.createErrorResult(`Failed to set slide layout: ${String(r)}`)}}getSlideInfoInternal(e){this.lok.documentSetPart(this.docPtr,e);let t=this.lok.getAllText(this.docPtr)||"",r=this.parseTextFrames(t),n=r.find(o=>o.type==="title");return {index:e,title:n?.text,layout:this.detectLayout(r),textFrameCount:r.length}}parseTextFrames(e){let t=e.split(/\n\n+/).filter(n=>n.trim()),r=[];return t.forEach((n,o)=>{let i=o===0?"title":o===1?"body":"other";r.push({index:o,type:i,text:n.trim(),bounds:{x:0,y:0,width:0,height:0}});}),r}detectLayout(e){return e.length===0?"blank":e.length===1&&e[0]?.type==="title"?"title":e.length>=2?"titleContent":"blank"}applySlideLayout(e){let r={blank:0,title:1,titleContent:2,twoColumn:3}[e]??0,n=JSON.stringify({WhatLayout:{type:"long",value:r}});this.lok.postUnoCommand(this.docPtr,".uno:AssignLayout",n);}};var J=class extends A{isImportedPdf=false;getDocumentType(){return "draw"}setImportedPdf(e){this.isImportedPdf=e;}getStructure(e){try{let t=this.lok.documentGetParts(this.docPtr),r=[];for(let o=0;o<t;o++){let i=this.getPageInfoInternal(o);r.push(i);}let n={type:"draw",pages:r,pageCount:t,isImportedPdf:this.isImportedPdf};return this.createResult(n)}catch(t){return this.createErrorResult(`Failed to get structure: ${String(t)}`)}}getPage(e){try{let t=this.lok.documentGetParts(this.docPtr);if(e<0||e>=t)return this.createErrorResult(`Invalid page index: ${e}. Valid range: 0-${t-1}`,"Use getStructure() to see available pages");this.lok.documentSetPart(this.docPtr,e);let r=this.lok.documentGetDocumentSize(this.docPtr),n=this.getShapesOnPage(),o={index:e,shapes:n,size:{width:r.width,height:r.height}};return this.createResult(o)}catch(t){return this.createErrorResult(`Failed to get page: ${String(t)}`)}}getPageCount(){try{let e=this.lok.documentGetParts(this.docPtr);return this.createResult(e)}catch(e){return this.createErrorResult(`Failed to get page count: ${String(e)}`)}}addPage(e){try{let t=this.lok.documentGetParts(this.docPtr);e?.afterPage!==void 0?this.lok.documentSetPart(this.docPtr,e.afterPage):this.lok.documentSetPart(this.docPtr,t-1),this.lok.postUnoCommand(this.docPtr,".uno:InsertPage");let r=e?.afterPage!==void 0?e.afterPage+1:t;return this.createResult({index:r})}catch(t){return this.createErrorResult(`Failed to add page: ${String(t)}`)}}deletePage(e){try{let t=this.lok.documentGetParts(this.docPtr);return t<=1?this.createErrorResult("Cannot delete the last page","A drawing document must have at least one page"):e<0||e>=t?this.createErrorResult(`Invalid page index: ${e}`,`Valid range: 0-${t-1}`):(this.lok.documentSetPart(this.docPtr,e),this.lok.postUnoCommand(this.docPtr,".uno:DeletePage"),this.createResult(void 0))}catch(t){return this.createErrorResult(`Failed to delete page: ${String(t)}`)}}duplicatePage(e){try{let t=this.lok.documentGetParts(this.docPtr);return e<0||e>=t?this.createErrorResult(`Invalid page index: ${e}`,`Valid range: 0-${t-1}`):(this.lok.documentSetPart(this.docPtr,e),this.lok.postUnoCommand(this.docPtr,".uno:DuplicatePage"),this.createResult({newIndex:e+1}))}catch(t){return this.createErrorResult(`Failed to duplicate page: ${String(t)}`)}}addShape(e,t,r,n){try{let o=this.lok.documentGetParts(this.docPtr);if(e<0||e>=o)return this.createErrorResult(`Invalid page index: ${e}`);this.lok.documentSetPart(this.docPtr,e);let i=this.getShapeCommand(t),s=JSON.stringify({X:{type:"long",value:r.x},Y:{type:"long",value:r.y},Width:{type:"long",value:r.width},Height:{type:"long",value:r.height}});if(this.lok.postUnoCommand(this.docPtr,i,s),n?.text){let a=JSON.stringify({Text:{type:"string",value:n.text}});this.lok.postUnoCommand(this.docPtr,".uno:InsertText",a);}if(n?.fillColor){let a=JSON.stringify({FillColor:{type:"long",value:this.hexToNumber(n.fillColor)}});this.lok.postUnoCommand(this.docPtr,".uno:FillColor",a);}if(n?.lineColor){let a=JSON.stringify({LineColor:{type:"long",value:this.hexToNumber(n.lineColor)}});this.lok.postUnoCommand(this.docPtr,".uno:XLineColor",a);}return this.createResult({shapeIndex:0})}catch(o){return this.createErrorResult(`Failed to add shape: ${String(o)}`)}}addLine(e,t,r,n){try{let o=this.lok.documentGetParts(this.docPtr);if(e<0||e>=o)return this.createErrorResult(`Invalid page index: ${e}`);this.lok.documentSetPart(this.docPtr,e);let i=JSON.stringify({StartX:{type:"long",value:t.x},StartY:{type:"long",value:t.y},EndX:{type:"long",value:r.x},EndY:{type:"long",value:r.y}});if(this.lok.postUnoCommand(this.docPtr,".uno:Line",i),n?.lineColor){let s=JSON.stringify({LineColor:{type:"long",value:this.hexToNumber(n.lineColor)}});this.lok.postUnoCommand(this.docPtr,".uno:XLineColor",s);}if(n?.lineWidth){let s=JSON.stringify({LineWidth:{type:"long",value:n.lineWidth}});this.lok.postUnoCommand(this.docPtr,".uno:LineWidth",s);}return this.createResult({shapeIndex:0})}catch(o){return this.createErrorResult(`Failed to add line: ${String(o)}`)}}deleteShape(e,t){try{return this.lok.documentSetPart(this.docPtr,e),this.selectShape(t),this.lok.postUnoCommand(this.docPtr,".uno:Delete"),this.createResult(void 0)}catch(r){return this.createErrorResult(`Failed to delete shape: ${String(r)}`)}}setShapeText(e,t,r){try{this.lok.documentSetPart(this.docPtr,e),this.selectShape(t),this.lok.postUnoCommand(this.docPtr,".uno:EnterGroup"),this.lok.postUnoCommand(this.docPtr,".uno:SelectAll");let n=JSON.stringify({Text:{type:"string",value:r}});return this.lok.postUnoCommand(this.docPtr,".uno:InsertText",n),this.lok.postUnoCommand(this.docPtr,".uno:LeaveGroup"),this.createResult(void 0)}catch(n){return this.createErrorResult(`Failed to set shape text: ${String(n)}`)}}moveShape(e,t,r){try{this.lok.documentSetPart(this.docPtr,e),this.selectShape(t);let n=JSON.stringify({X:{type:"long",value:r.x},Y:{type:"long",value:r.y}});return this.lok.postUnoCommand(this.docPtr,".uno:SetObjectPosition",n),this.createResult(void 0)}catch(n){return this.createErrorResult(`Failed to move shape: ${String(n)}`)}}resizeShape(e,t,r){try{this.lok.documentSetPart(this.docPtr,e),this.selectShape(t);let n=JSON.stringify({Width:{type:"long",value:r.width},Height:{type:"long",value:r.height}});return this.lok.postUnoCommand(this.docPtr,".uno:Size",n),this.createResult(void 0)}catch(n){return this.createErrorResult(`Failed to resize shape: ${String(n)}`)}}getPageInfoInternal(e){this.lok.documentSetPart(this.docPtr,e);let t=this.lok.documentGetDocumentSize(this.docPtr),r=this.getShapesOnPage();return {index:e,shapeCount:r.length,size:{width:t.width,height:t.height}}}getShapesOnPage(){let e=this.lok.getAllText(this.docPtr)||"";return e.trim()?[{index:0,type:"text",text:e,bounds:{x:0,y:0,width:0,height:0}}]:[]}selectShape(e){let t=JSON.stringify({Index:{type:"long",value:e}});this.lok.postUnoCommand(this.docPtr,".uno:SelectObject",t);}getShapeCommand(e){return {rectangle:".uno:Rect",ellipse:".uno:Ellipse",line:".uno:Line",text:".uno:Text",image:".uno:InsertGraphic",group:".uno:FormatGroup",other:".uno:Rect"}[e]}hexToNumber(e){return parseInt(e.replace("#",""),16)}};var Pe=0,Ce=1,be=2,Te=3;function he(l,e,t){let r=l.documentGetDocumentType(e);switch(r){case Pe:return new G(l,e,t);case Ce:return new H(l,e,t);case be:return new j(l,e,t);case Te:return new J(l,e,t);default:throw new Error(`Unsupported document type: ${r}`)}}function Le(l){return {0:"INVALIDATE_TILES",1:"INVALIDATE_VISIBLE_CURSOR",2:"TEXT_SELECTION",3:"TEXT_SELECTION_START",4:"TEXT_SELECTION_END",5:"CURSOR_VISIBLE",6:"GRAPHIC_SELECTION",7:"HYPERLINK_CLICKED",8:"STATE_CHANGED",9:"STATUS_INDICATOR_START",10:"STATUS_INDICATOR_SET_VALUE",11:"STATUS_INDICATOR_FINISH",12:"SEARCH_NOT_FOUND",13:"DOCUMENT_SIZE_CHANGED",14:"SET_PART",15:"SEARCH_RESULT_SELECTION",16:"UNO_COMMAND_RESULT",17:"CELL_CURSOR",18:"MOUSE_POINTER",19:"CELL_FORMULA",20:"DOCUMENT_PASSWORD",21:"DOCUMENT_PASSWORD_TO_MODIFY",22:"CONTEXT_MENU",23:"INVALIDATE_VIEW_CURSOR",24:"TEXT_VIEW_SELECTION",25:"CELL_VIEW_CURSOR",26:"GRAPHIC_VIEW_SELECTION",27:"VIEW_CURSOR_VISIBLE",28:"VIEW_LOCK",29:"REDLINE_TABLE_SIZE_CHANGED",30:"REDLINE_TABLE_ENTRY_MODIFIED",31:"COMMENT",32:"INVALIDATE_HEADER",33:"CELL_ADDRESS"}[l]||`UNKNOWN(${l})`}var X={nSize:0,destroy:4,documentLoad:8,getError:12,documentLoadWithOptions:16,freeError:20},me={nSize:0,destroy:4,saveAs:8},we=new TextEncoder,pe=new TextDecoder,Y=class{module;lokPtr=0;verbose;useShims;constructor(e,t=false){this.module=e,this.verbose=t,this.useShims=typeof this.module._lok_documentLoad=="function",this.useShims?this.log("Using direct LOK shim exports"):this.log("Using vtable traversal (shims not available)");}log(...e){this.verbose&&console.log("[LOK]",...e);}get HEAPU8(){return this.module.HEAPU8}get HEAPU32(){return this.module.HEAPU32}get HEAP32(){return this.module.HEAP32}allocString(e){let t=we.encode(e+"\0"),r=this.module._malloc(t.length);return this.HEAPU8.set(t,r),r}readString(e){if(e===0)return null;let t=this.HEAPU8,r=e;for(;t[r]!==0;)r++;let n=t.slice(e,r);return pe.decode(n)}readPtr(e){return this.HEAPU32[e>>2]||0}getFunc(e){return this.module.wasmTable.get(e)}initialize(e="/instdir/program"){this.log("Initializing with path:",e);let t=this.allocString(e);try{let r=this.module._libreofficekit_hook;if(typeof r!="function")throw new Error("libreofficekit_hook export not found on module");if(this.lokPtr=r(t),this.lokPtr===0)throw new Error("Failed to initialize LibreOfficeKit");this.log("LOK initialized, ptr:",this.lokPtr);}finally{this.module._free(t);}}getError(){if(this.lokPtr===0)return null;if(this.useShims&&this.module._lok_getError){let o=this.module._lok_getError(this.lokPtr);return this.readString(o)}let e=this.readPtr(this.lokPtr),t=this.readPtr(e+X.getError);if(t===0)return null;let n=this.getFunc(t)(this.lokPtr);return this.readString(n)}getVersionInfo(){return "LibreOffice WASM"}toFileUrl(e){return e.startsWith("file://")?e:"file://"+(e.startsWith("/")?e:"/"+e)}documentLoad(e){if(this.lokPtr===0)throw new Error("LOK not initialized");let t=this.toFileUrl(e);this.log("Loading document:",e,"->",t);let r=this.allocString(t);try{let n=Date.now(),o;if(this.useShims&&this.module._lok_documentLoad)o=this.module._lok_documentLoad(this.lokPtr,r);else {let i=this.readPtr(this.lokPtr),s=this.readPtr(i+X.documentLoad);o=this.getFunc(s)(this.lokPtr,r);}if(this.log("Document loaded in",Date.now()-n,"ms, ptr:",o),o===0){let i=this.getError();throw new Error(`Failed to load document: ${i||"unknown error"}`)}return o}finally{this.module._free(r);}}documentLoadWithOptions(e,t){if(this.lokPtr===0)throw new Error("LOK not initialized");let r=this.toFileUrl(e);this.log("Loading document with options:",e,"->",r,t);let n=this.allocString(r),o=this.allocString(t);try{let i;if(this.useShims&&this.module._lok_documentLoadWithOptions)i=this.module._lok_documentLoadWithOptions(this.lokPtr,n,o);else {let s=this.readPtr(this.lokPtr),a=this.readPtr(s+X.documentLoadWithOptions);if(a===0)return this.documentLoad(e);i=this.getFunc(a)(this.lokPtr,n,o);}if(i===0){let s=this.getError();throw new Error(`Failed to load document: ${s||"unknown error"}`)}return this.log("Document loaded, ptr:",i),i}finally{this.module._free(n),this.module._free(o);}}documentSaveAs(e,t,r,n=""){if(e===0)throw new Error("Invalid document pointer");let o=this.toFileUrl(t);this.log("Saving document to:",t,"->",o,"format:",r);let i=this.allocString(o),s=this.allocString(r),a=this.allocString(n);try{let d;if(this.useShims&&this.module._lok_documentSaveAs)d=this.module._lok_documentSaveAs(e,i,s,a);else {let h=this.readPtr(e),m=this.readPtr(h+me.saveAs);d=this.getFunc(m)(e,i,s,a);}if(this.log("Save result:",d),d===0)throw new Error("Failed to save document")}finally{this.module._free(i),this.module._free(s),this.module._free(a);}}documentDestroy(e){if(e===0)return;if(this.useShims&&this.module._lok_documentDestroy){this.module._lok_documentDestroy(e),this.log("Document destroyed (via shim)");return}let t=this.readPtr(e),r=this.readPtr(t+me.destroy);r!==0&&(this.getFunc(r)(e),this.log("Document destroyed (via vtable)"));}destroy(){if(this.lokPtr!==0){try{if(this.useShims&&this.module._lok_destroy)this.module._lok_destroy(this.lokPtr),this.log("LOK destroyed (via shim)");else {let e=this.readPtr(this.lokPtr),t=this.readPtr(e+X.destroy);t!==0&&(this.getFunc(t)(this.lokPtr),this.log("LOK destroyed (via vtable)"));}}catch(e){this.log("LOK destroy error (ignored):",e);}this.lokPtr=0;}}isInitialized(){return this.lokPtr!==0}isUsingShims(){return this.useShims}documentGetParts(e){if(e===0)throw new Error("Invalid document pointer");return this.useShims&&this.module._lok_documentGetParts?this.module._lok_documentGetParts(e):(this.log("documentGetParts: shim not available"),0)}documentGetPart(e){if(e===0)throw new Error("Invalid document pointer");return this.useShims&&this.module._lok_documentGetPart?this.module._lok_documentGetPart(e):(this.log("documentGetPart: shim not available"),0)}documentSetPart(e,t){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentSetPart){this.module._lok_documentSetPart(e,t);return}this.log("documentSetPart: shim not available");}documentGetDocumentType(e){if(e===0)throw new Error("Invalid document pointer");return this.useShims&&this.module._lok_documentGetDocumentType?this.module._lok_documentGetDocumentType(e):(this.log("documentGetDocumentType: shim not available"),0)}documentGetDocumentSize(e){if(this.log(`documentGetDocumentSize called with docPtr: ${e}`),e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentGetDocumentSize){let t=this.module._malloc(8);try{this.module._lok_documentGetDocumentSize(e,t,t+4);let r=this.HEAP32[t>>2]??0,n=this.HEAP32[t+4>>2]??0;return this.log(`documentGetDocumentSize: ${r}x${n} twips`),{width:r,height:n}}finally{this.module._free(t);}}return this.log("documentGetDocumentSize: shim not available"),{width:0,height:0}}documentInitializeForRendering(e,t=""){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentInitializeForRendering){let r=this.allocString(t);try{this.module._lok_documentInitializeForRendering(e,r);}finally{this.module._free(r);}return}this.log("documentInitializeForRendering: shim not available");}documentPaintTile(e,t,r,n,o,i,s){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentPaintTile){let a=t*r*4,d=this.module._malloc(a);if(d===0)throw new Error(`Failed to allocate ${a} bytes for tile buffer`);try{this.module._lok_documentPaintTile(e,d,t,r,n,o,i,s);let h=new Uint8Array(a);return h.set(this.HEAPU8.subarray(d,d+a)),h}finally{this.module._free(d);}}return this.log("documentPaintTile: shim not available"),new Uint8Array(0)}documentGetTileMode(e){if(e===0)throw new Error("Invalid document pointer");return this.useShims&&this.module._lok_documentGetTileMode?this.module._lok_documentGetTileMode(e):(this.log("documentGetTileMode: shim not available"),0)}renderPage(e,t,r,n=0){this.documentInitializeForRendering(e);let o=this.documentGetDocumentType(e);if(o===2||o===3){console.log(`[LOK] Setting part to ${t} for presentation/drawing`),this.documentSetPart(e,t);let E=this.documentGetPart(e);console.log(`[LOK] Current part after setPart: ${E}`);}let i=this.documentGetDocumentSize(e);if(this.log("Document size (twips):",i),i.width===0||i.height===0)throw new Error("Failed to get document size");let s=0,a=0,d=i.width,h=i.height;if(o===0||o===1){let E=this.getPartPageRectangles(e);if(E){let O=this.parsePageRectangles(E)[t];O&&(s=O.x,a=O.y,d=O.width,h=O.height,this.log(`Page ${t} rectangle:`,O));}}let m=h/d,u=r,g=n>0?n:Math.round(r*m);console.log(`[LOK] Calling paintTile: ${u}x${g} from tile pos (${s}, ${a}) size (${d}x${h})`);let _=this.documentPaintTile(e,u,g,s,a,d,h);return console.log(`[LOK] paintTile returned ${_.length} bytes`),{data:_,width:u,height:g}}getTextSelection(e,t="text/plain;charset=utf-8"){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentGetTextSelection){let r=this.allocString(t),n=this.module._malloc(4);try{let o=this.module._lok_documentGetTextSelection(e,r,n);if(o===0)return null;let i=this.readString(o);return this.module._free(o),i}finally{this.module._free(r),this.module._free(n);}}return this.log("getTextSelection: shim not available"),null}setTextSelection(e,t,r,n){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentSetTextSelection){this.module._lok_documentSetTextSelection(e,t,r,n);return}this.log("setTextSelection: shim not available");}getSelectionType(e){if(e===0)throw new Error("Invalid document pointer");return this.useShims&&this.module._lok_documentGetSelectionType?this.module._lok_documentGetSelectionType(e):(this.log("getSelectionType: shim not available"),0)}resetSelection(e){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentResetSelection){this.module._lok_documentResetSelection(e);return}this.log("resetSelection: shim not available");}postMouseEvent(e,t,r,n,o=1,i=1,s=0){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentPostMouseEvent){this.module._lok_documentPostMouseEvent(e,t,r,n,o,i,s);return}this.log("postMouseEvent: shim not available");}postKeyEvent(e,t,r,n){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentPostKeyEvent){this.module._lok_documentPostKeyEvent(e,t,r,n);return}this.log("postKeyEvent: shim not available");}postUnoCommand(e,t,r="{}",n=false){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentPostUnoCommand){let o=this.allocString(t),i=this.allocString(r);try{this.module._lok_documentPostUnoCommand(e,o,i,n?1:0);}finally{this.module._free(o),this.module._free(i);}return}this.log("postUnoCommand: shim not available");}getCommandValues(e,t){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentGetCommandValues){let r=this.allocString(t);try{let n=this.module._lok_documentGetCommandValues(e,r);if(n===0)return null;let o=this.readString(n);return this.module._free(n),o}finally{this.module._free(r);}}return this.log("getCommandValues: shim not available"),null}getPartPageRectangles(e){if(this.log(`getPartPageRectangles called with docPtr: ${e}`),e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentGetPartPageRectangles){this.log("getPartPageRectangles: using shim");let t=this.module._lok_documentGetPartPageRectangles(e);if(this.log(`getPartPageRectangles: resultPtr=${t}`),t===0)return null;let r=this.readString(t);return this.log(`getPartPageRectangles: result="${r?.slice(0,100)}..."`),this.module._free(t),r}return this.log("getPartPageRectangles: shim not available"),null}getPartInfo(e,t){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentGetPartInfo){let r=this.module._lok_documentGetPartInfo(e,t);if(r===0)return null;let n=this.readString(r);return this.module._free(r),n}return this.log("getPartInfo: shim not available"),null}getPartName(e,t){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentGetPartName){let r=this.module._lok_documentGetPartName(e,t);if(r===0)return null;let n=this.readString(r);return this.module._free(r),n}return this.log("getPartName: shim not available"),null}paste(e,t,r){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentPaste){let n=this.allocString(t),o,i;if(typeof r=="string"){let s=new TextEncoder().encode(r);i=s.length,o=this.module._malloc(i),this.HEAPU8.set(s,o);}else i=r.length,o=this.module._malloc(i),this.HEAPU8.set(r,o);try{return this.module._lok_documentPaste(e,n,o,i)!==0}finally{this.module._free(n),this.module._free(o);}}return this.log("paste: shim not available"),false}setClientZoom(e,t,r,n,o){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentSetClientZoom){this.module._lok_documentSetClientZoom(e,t,r,n,o);return}this.log("setClientZoom: shim not available");}setClientVisibleArea(e,t,r,n,o){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentSetClientVisibleArea){this.module._lok_documentSetClientVisibleArea(e,t,r,n,o);return}this.log("setClientVisibleArea: shim not available");}getA11yFocusedParagraph(e){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentGetA11yFocusedParagraph){let t=this.module._lok_documentGetA11yFocusedParagraph(e);if(t===0)return null;let r=this.readString(t);return this.module._free(t),r}return this.log("getA11yFocusedParagraph: shim not available"),null}getA11yCaretPosition(e){if(e===0)throw new Error("Invalid document pointer");return this.useShims&&this.module._lok_documentGetA11yCaretPosition?this.module._lok_documentGetA11yCaretPosition(e):(this.log("getA11yCaretPosition: shim not available"),-1)}setAccessibilityState(e,t,r){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentSetAccessibilityState){this.module._lok_documentSetAccessibilityState(e,t,r?1:0);return}this.log("setAccessibilityState: shim not available");}getDataArea(e,t){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentGetDataArea){let r=this.module._malloc(8),n=this.module._malloc(8);try{this.module._lok_documentGetDataArea(e,t,r,n);let o=this.HEAP32[r>>2]??0,i=this.HEAP32[n>>2]??0;return {col:o,row:i}}finally{this.module._free(r),this.module._free(n);}}return this.log("getDataArea: shim not available"),{col:0,row:0}}getEditMode(e){if(e===0)throw new Error("Invalid document pointer");return this.useShims&&this.module._lok_documentGetEditMode?this.module._lok_documentGetEditMode(e):(this.log("getEditMode: shim not available"),0)}setEditMode(e,t){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentSetEditMode){this.log(`setEditMode: setting mode to ${t}`),this.module._lok_documentSetEditMode(e,t);return}this.log("setEditMode: shim not available");}createView(e){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentCreateView){let t=this.module._lok_documentCreateView(e);return this.log(`createView: created view ${t}`),t}return this.log("createView: shim not available"),-1}createViewWithOptions(e,t){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentCreateViewWithOptions){let r=this.allocString(t);try{let n=this.module._lok_documentCreateViewWithOptions(e,r);return this.log(`createViewWithOptions: created view ${n}`),n}finally{this.module._free(r);}}return this.log("createViewWithOptions: shim not available"),-1}destroyView(e,t){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentDestroyView){this.log(`destroyView: destroying view ${t}`),this.module._lok_documentDestroyView(e,t);return}this.log("destroyView: shim not available");}setView(e,t){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentSetView){this.log(`setView: setting active view to ${t}`),this.module._lok_documentSetView(e,t);return}this.log("setView: shim not available");}getView(e){if(e===0)throw new Error("Invalid document pointer");return this.useShims&&this.module._lok_documentGetView?this.module._lok_documentGetView(e):(this.log("getView: shim not available"),-1)}getViewsCount(e){if(e===0)throw new Error("Invalid document pointer");return this.useShims&&this.module._lok_documentGetViewsCount?this.module._lok_documentGetViewsCount(e):(this.log("getViewsCount: shim not available"),0)}enableSyncEvents(){this.useShims&&this.module._lok_enableSyncEvents?(this.module._lok_enableSyncEvents(),this.log("enableSyncEvents: Unipoll mode enabled")):this.log("enableSyncEvents: shim not available");}disableSyncEvents(){this.useShims&&this.module._lok_disableSyncEvents?(this.module._lok_disableSyncEvents(),this.log("disableSyncEvents: Unipoll mode disabled")):this.log("disableSyncEvents: shim not available");}registerCallback(e){if(e===0)throw new Error("Invalid document pointer");this.useShims&&this.module._lok_documentRegisterCallback?(this.module._lok_documentRegisterCallback(e),this.log("registerCallback: callback registered")):this.log("registerCallback: shim not available");}unregisterCallback(e){if(e===0)throw new Error("Invalid document pointer");this.useShims&&this.module._lok_documentUnregisterCallback?(this.module._lok_documentUnregisterCallback(e),this.log("unregisterCallback: callback unregistered")):this.log("unregisterCallback: shim not available");}hasCallbackEvents(){return this.useShims&&this.module._lok_hasCallbackEvents?this.module._lok_hasCallbackEvents()!==0:false}getCallbackEventCount(){return this.useShims&&this.module._lok_getCallbackEventCount?this.module._lok_getCallbackEventCount():0}pollCallback(){if(!this.useShims||!this.module._lok_pollCallback)return null;let e=4096,t=this.module._malloc(e),r=this.module._malloc(4);try{let n=this.module._lok_pollCallback(t,e,r);if(n===-1)return null;let o=this.module.HEAP32[r>>2]??0,i="";if(o>0){let s=Math.min(o,e-1),a=this.module.HEAPU8.slice(t,t+s);i=pe.decode(a);}return {type:n,typeName:Le(n),payload:i}}finally{this.module._free(t),this.module._free(r);}}pollAllCallbacks(){let e=[],t=this.pollCallback();for(;t!==null;)e.push(t),t=this.pollCallback();return e}clearCallbackQueue(){this.useShims&&this.module._lok_clearCallbackQueue&&(this.module._lok_clearCallbackQueue(),this.log("clearCallbackQueue: queue cleared"));}flushCallbacks(e){if(e===0)throw new Error("Invalid document pointer");let t=!!this.module._lok_flushCallbacks;this.log(`flushCallbacks: useShims=${this.useShims}, _lok_flushCallbacks exists=${t}`),this.useShims&&this.module._lok_flushCallbacks?(this.module._lok_flushCallbacks(e),this.log("flushCallbacks: callbacks flushed")):this.log("flushCallbacks: shim not available");}pollStateChanges(){let e=new Map,t=this.pollAllCallbacks();for(let r of t)if(r.type===8){let n=r.payload.indexOf("=");if(n!==-1){let o=r.payload.substring(0,n),i=r.payload.substring(n+1);e.set(o,i);}else e.set(r.payload,"");}return e}clickAndGetText(e,t,r){return this.postMouseEvent(e,0,t,r,1,1,0),this.postMouseEvent(e,1,t,r,1,1,0),this.getTextSelection(e,"text/plain;charset=utf-8")}doubleClickAndGetWord(e,t,r){return this.postMouseEvent(e,0,t,r,2,1,0),this.postMouseEvent(e,1,t,r,2,1,0),this.getTextSelection(e,"text/plain;charset=utf-8")}selectAll(e){this.postUnoCommand(e,".uno:SelectAll");}getAllText(e){this.log(`getAllText called with docPtr: ${e}`),this.selectAll(e);let t=this.getTextSelection(e,"text/plain;charset=utf-8");return this.log(`getAllText: text="${t?.slice(0,100)}..."`),this.resetSelection(e),t}parsePageRectangles(e){return e?e.split(";").filter(t=>t.trim()).map(t=>{let r=t.split(",").map(Number);return {x:r[0]??0,y:r[1]??0,width:r[2]??0,height:r[3]??0}}):[]}};async function Re(){return  false;}var q=class{module=null;lokBindings=null;initialized=false;initializing=false;options;corrupted=false;fsTracked=false;constructor(e={}){this.options={wasmPath:"./wasm",verbose:false,...e};}isCorruptionError(e){let t=e instanceof Error?e.message:e;return t.includes("memory access out of bounds")||t.includes("ComponentContext is not avail")||t.includes("unreachable")||t.includes("table index is out of bounds")||t.includes("null function")}async reinitialize(){if(this.options.verbose&&console.log("[LibreOfficeConverter] Reinitializing due to corruption..."),this.lokBindings){try{this.lokBindings.destroy();}catch{}this.lokBindings=null;}this.module=null,this.initialized=false,this.corrupted=false,await this.initialize();}async initializeWithModule(e){if(!this.initialized){if(this.initializing){for(;this.initializing;)await new Promise(t=>setTimeout(t,100));return}this.initializing=true;try{this.module=e,this.setupFileSystem(),this.initializeLibreOfficeKit(),this.initialized=!0,this.options.onReady?.();}catch(t){console.error("[LibreOfficeConverter] Initialization error:",t);let r=t instanceof S?t:new S("WASM_NOT_INITIALIZED",`Failed to initialize with module: ${String(t)}`);throw this.options.onError?.(r),r}finally{this.initializing=false;}}}async initialize(){if(!this.initialized){if(this.initializing){for(;this.initializing;)await new Promise(e=>setTimeout(e,100));return}this.initializing=true,this.emitProgress("loading",0,"Loading LibreOffice WASM module...");try{this.module=await this.loadModule(),this.emitProgress("initializing",50,"Setting up virtual filesystem..."),this.setupFileSystem(),this.emitProgress("initializing",60,"Initializing LibreOfficeKit..."),this.initializeLibreOfficeKit(),this.emitProgress("initializing",90,"LibreOfficeKit ready"),this.initialized=!0,this.emitProgress("complete",100,"LibreOffice ready"),this.options.onReady?.();}catch(e){console.error("[LibreOfficeConverter] Initialization error:",e);let t=e instanceof S?e:new S("WASM_NOT_INITIALIZED",`Failed to initialize WASM module: ${String(e)}`);throw this.options.onError?.(t),t}finally{this.initializing=false;}}}async loadModule(){let e=this.options.wasmPath||"./wasm";return console.log("[LibreOfficeConverter] Loading WASM module from:",e),this.loadBrowserModule(e)}async loadNodeModule(e){if(await Re(),true)throw new S("WASM_NOT_INITIALIZED","Node.js modules not available. This method should only be called in Node.js environment.");}async loadBrowserModule(e){let t=`${e}/soffice.js`,r={locateFile:i=>i.endsWith(".wasm")?`${e}/soffice.wasm`:i.endsWith(".data")?`${e}/soffice.data`:`${e}/${i}`,print:this.options.verbose?console.log:()=>{},printErr:this.options.verbose?console.error:()=>{}},n=document.createElement("script");n.src=t,await new Promise((i,s)=>{n.onload=()=>i(),n.onerror=()=>s(new Error(`Failed to load ${t}`)),document.head.appendChild(n);});let o=window.createSofficeModule;if(!o)throw new S("WASM_NOT_INITIALIZED","WASM module factory not found. Make sure soffice.js is loaded.");return new Promise((i,s)=>{let a={...r,onRuntimeInitialized:()=>{i(a);}};o(a).catch(s);})}setupFileSystem(){if(!this.module?.FS)throw new S("WASM_NOT_INITIALIZED","Filesystem not available");let e=this.module.FS,t=r=>{try{e.mkdir(r);}catch{}};t("/tmp"),t("/tmp/input"),t("/tmp/output");}initializeLibreOfficeKit(){if(!this.module)throw new S("WASM_NOT_INITIALIZED","Module not loaded");if(this.options.verbose&&this.module.FS){let e=this.module.FS;if(!this.fsTracked&&(this.fsTracked=true,e.trackingDelegate||(e.trackingDelegate={onOpen:r=>{console.log("[FS OPEN]",r);},onOpenFile:r=>{console.log("[FS OPEN FILE]",r);}}),typeof e.open=="function")){let r=e.open.bind(e);e.open=((n,o,i)=>{console.log("[FS OPEN CALL]",n);try{return r(n,o,i)}catch(s){throw s?.code==="ENOENT"&&console.log("[FS ENOENT]",n),s}});}let t=(r,n)=>{try{console.log(`[FS] ${r}:`,e.readdir(n));}catch(o){console.log(`[FS] ${r}: ERROR -`,o.message);}};t("ROOT","/"),t("PROGRAM DIR","/instdir/program"),t("SHARE DIR","/instdir/share"),t("REGISTRY DIR","/instdir/share/registry"),t("FILTER DIR","/instdir/share/filter"),t("CONFIG DIR","/instdir/share/config/soffice.cfg"),t("CONFIG FILTER","/instdir/share/config/soffice.cfg/filter"),t("IMPRESS MODULES","/instdir/share/config/soffice.cfg/modules/simpress");}this.lokBindings=new Y(this.module,this.options.verbose);try{if(this.lokBindings.initialize("/instdir/program"),this.options.verbose){let e=this.lokBindings.getVersionInfo();e&&console.log("[LOK] Version:",e);}}catch(e){throw new S("WASM_NOT_INITIALIZED",`Failed to initialize LibreOfficeKit: ${String(e)}`)}}async convert(e,t,r="document"){if(this.corrupted&&await this.reinitialize(),!this.initialized||!this.module)throw new S("WASM_NOT_INITIALIZED","LibreOffice WASM not initialized. Call initialize() first.");let n=Date.now(),o=this.normalizeInput(e);if(o.length===0)throw new S("INVALID_INPUT","Empty document provided");let i=t.inputFormat||this.getExtensionFromFilename(r)||"docx",s=t.outputFormat;if(!te[s])throw new S("UNSUPPORTED_FORMAT",`Unsupported output format: ${s}`);if(!re(i,s))throw new S("UNSUPPORTED_FORMAT",de(i,s));let a=`/tmp/input/doc.${i}`,d=`/tmp/output/doc.${s}`;try{this.emitProgress("converting",10,"Writing input document..."),this.module.FS.writeFile(a,o),this.emitProgress("converting",30,"Converting document...");let h=await this.performConversion(a,d,t);this.emitProgress("complete",100,"Conversion complete");let u=`${this.getBasename(r)}.${s}`;return {data:h,mimeType:ae[s],filename:u,duration:Date.now()-n}}catch(h){throw h instanceof Error&&this.isCorruptionError(h)&&(this.corrupted=true,this.options.verbose&&console.log("[LibreOfficeConverter] Corruption detected, will reinitialize on next convert")),h}finally{try{this.module?.FS.unlink(a);}catch{}try{this.module?.FS.unlink(d);}catch{}}}async performConversion(e,t,r){if(!this.module||!this.lokBindings)throw new S("WASM_NOT_INITIALIZED","Module not loaded");this.emitProgress("converting",40,"Loading document...");let n=0;try{let o=r.password?`,Password=${r.password}`:"";if(this.options.verbose)try{let a=this.module.FS.stat(e);console.log("[Convert] File exists before LOK load:",e,"size:",a.size);}catch(a){console.log("[Convert] File NOT found before LOK load:",e,a.message);}if(o?n=this.lokBindings.documentLoadWithOptions(e,o):n=this.lokBindings.documentLoad(e),n===0)throw new S("LOAD_FAILED","Failed to load document");this.emitProgress("converting",60,"Converting format...");let i=K[r.outputFormat],s=M[r.outputFormat]||"";if(r.outputFormat==="pdf"&&r.pdf){let a=[];if(r.pdf.pdfaLevel){let d={"PDF/A-1b":1,"PDF/A-2b":2,"PDF/A-3b":3};a.push(`SelectPdfVersion=${d[r.pdf.pdfaLevel]||0}`);}r.pdf.quality!==void 0&&a.push(`Quality=${r.pdf.quality}`),a.length>0&&(s=a.join(","));}if(["png","jpg","svg"].includes(r.outputFormat)&&r.image?.pageIndex!==void 0){let a=r.image.pageIndex+1;s?s+=`;PageRange=${a}-${a}`:s=`PageRange=${a}-${a}`;}this.emitProgress("converting",70,"Saving document..."),this.lokBindings.documentSaveAs(n,t,i,s),this.emitProgress("converting",90,"Reading output...");try{let a=this.module.FS.readFile(t);if(a.length===0)throw new S("CONVERSION_FAILED","Conversion produced empty output");return a}catch(a){throw new S("CONVERSION_FAILED",`Failed to read converted file: ${String(a)}`)}}catch(o){throw o instanceof S?o:new S("CONVERSION_FAILED",`Conversion failed: ${String(o)}`)}finally{if(n!==0&&this.lokBindings)try{this.lokBindings.documentDestroy(n);}catch{}}}async renderPagePreviews(e,t,r={}){if(!this.initialized||!this.module||!this.lokBindings)throw new S("WASM_NOT_INITIALIZED","Converter not initialized");let n=this.normalizeInput(e),o=(t.inputFormat||"docx").toLowerCase(),i=r.width??256,s=r.height??0,a=r.pageIndices??[],d=`/tmp/preview/doc.${o}`,h=this.module.FS;try{try{h.mkdir("/tmp/preview");}catch{}h.writeFile(d,n);let m=this.lokBindings.documentLoad(d);if(m===0)throw new S("LOAD_FAILED","Failed to load document for preview");try{let u=this.lokBindings.documentGetParts(m);this.options.verbose&&console.log(`[Preview] Document has ${u} pages/parts`);let g=a.length>0?a.filter(E=>E>=0&&E<u):Array.from({length:u},(E,p)=>p),_=[];for(let E of g){this.options.verbose&&console.log(`[Preview] Rendering page ${E+1}/${u}`);let p=this.lokBindings.renderPage(m,E,i,s);_.push({page:E,data:p.data,width:p.width,height:p.height});}return _}finally{this.lokBindings.documentDestroy(m);}}finally{try{h.unlink(d);}catch{}try{h.rmdir("/tmp/preview");}catch{}}}async getPageCount(e,t){if(!this.initialized||!this.module||!this.lokBindings)throw new S("WASM_NOT_INITIALIZED","Converter not initialized");let r=this.normalizeInput(e),o=`/tmp/pagecount/doc.${(t.inputFormat||"docx").toLowerCase()}`,i=this.module.FS;try{try{i.mkdir("/tmp/pagecount");}catch{}i.writeFile(o,r);let s=this.lokBindings.documentLoad(o);if(s===0)throw new S("LOAD_FAILED","Failed to load document");try{return this.lokBindings.documentGetParts(s)}finally{this.lokBindings.documentDestroy(s);}}finally{try{i.unlink(o);}catch{}try{i.rmdir("/tmp/pagecount");}catch{}}}async getDocumentInfo(e,t){if(!this.initialized||!this.module||!this.lokBindings)throw new S("WASM_NOT_INITIALIZED","Converter not initialized");let r=this.normalizeInput(e),o=`/tmp/docinfo/doc.${(t.inputFormat||"docx").toLowerCase()}`,i=this.module.FS;try{try{i.mkdir("/tmp/docinfo");}catch{}i.writeFile(o,r);let s=this.lokBindings.documentLoad(o);if(s===0)throw new S("LOAD_FAILED","Failed to load document");try{let a=this.lokBindings.documentGetDocumentType(s),d=this.lokBindings.documentGetParts(s),h=ce(a),m={0:"Text Document",1:"Spreadsheet",2:"Presentation",3:"Drawing",4:"Other"};return {documentType:a,documentTypeName:m[a]||"Unknown",validOutputFormats:h,pageCount:d}}finally{this.lokBindings.documentDestroy(s);}}finally{try{i.unlink(o);}catch{}try{i.rmdir("/tmp/docinfo");}catch{}}}async getDocumentText(e,t){if(!this.initialized||!this.module||!this.lokBindings)throw new S("WASM_NOT_INITIALIZED","Converter not initialized");let r=this.normalizeInput(e),n=t.inputFormat?.toLowerCase();if(!n)throw new S("INVALID_INPUT","Input format is required");let o=`/tmp/inspect/doc.${n}`,i=this.module.FS;try{try{i.mkdir("/tmp/inspect");}catch{}i.writeFile(o,r);let s=this.lokBindings.documentLoad(o);if(s===0)throw new S("LOAD_FAILED","Failed to load document");try{return this.lokBindings.getAllText(s)}finally{this.lokBindings.documentDestroy(s);}}finally{try{i.unlink(o);}catch{}try{i.rmdir("/tmp/inspect");}catch{}}}async getPageNames(e,t){if(!this.initialized||!this.module||!this.lokBindings)throw new S("WASM_NOT_INITIALIZED","Converter not initialized");let r=this.normalizeInput(e),n=t.inputFormat?.toLowerCase();if(!n)throw new S("INVALID_INPUT","Input format is required");let o=`/tmp/names/doc.${n}`,i=this.module.FS;try{try{i.mkdir("/tmp/names");}catch{}i.writeFile(o,r);let s=this.lokBindings.documentLoad(o);if(s===0)throw new S("LOAD_FAILED","Failed to load document");try{let a=this.lokBindings.documentGetParts(s),d=[];for(let h=0;h<a;h++){let m=this.lokBindings.getPartName(s,h);d.push(m||`Page ${h+1}`);}return d}finally{this.lokBindings.documentDestroy(s);}}finally{try{i.unlink(o);}catch{}try{i.rmdir("/tmp/names");}catch{}}}async getPageRectangles(e,t){if(!this.initialized||!this.module||!this.lokBindings)throw new S("WASM_NOT_INITIALIZED","Converter not initialized");let r=this.normalizeInput(e),n=t.inputFormat?.toLowerCase();if(!n)throw new S("INVALID_INPUT","Input format is required");let o=`/tmp/rects/doc.${n}`,i=this.module.FS;try{try{i.mkdir("/tmp/rects");}catch{}i.writeFile(o,r);let s=this.lokBindings.documentLoad(o);if(s===0)throw new S("LOAD_FAILED","Failed to load document");try{let a=this.lokBindings.getPartPageRectangles(s);return this.lokBindings.parsePageRectangles(a||"")}finally{this.lokBindings.documentDestroy(s);}}finally{try{i.unlink(o);}catch{}try{i.rmdir("/tmp/rects");}catch{}}}async getSpreadsheetDataArea(e,t,r=0){if(!this.initialized||!this.module||!this.lokBindings)throw new S("WASM_NOT_INITIALIZED","Converter not initialized");let n=this.normalizeInput(e),o=t.inputFormat?.toLowerCase();if(!o)throw new S("INVALID_INPUT","Input format is required");let i=`/tmp/dataarea/doc.${o}`,s=this.module.FS;try{try{s.mkdir("/tmp/dataarea");}catch{}s.writeFile(i,n);let a=this.lokBindings.documentLoad(i);if(a===0)throw new S("LOAD_FAILED","Failed to load document");try{return this.lokBindings.getDataArea(a,r)}finally{this.lokBindings.documentDestroy(a);}}finally{try{s.unlink(i);}catch{}try{s.rmdir("/tmp/dataarea");}catch{}}}async executeUnoCommand(e,t,r,n="{}"){if(!this.initialized||!this.module||!this.lokBindings)throw new S("WASM_NOT_INITIALIZED","Converter not initialized");let o=this.normalizeInput(e),i=t.inputFormat?.toLowerCase();if(!i)throw new S("INVALID_INPUT","Input format is required");let s=`/tmp/uno/doc.${i}`,a=this.module.FS;try{try{a.mkdir("/tmp/uno");}catch{}a.writeFile(s,o);let d=this.lokBindings.documentLoad(s);if(d===0)throw new S("LOAD_FAILED","Failed to load document");try{this.lokBindings.postUnoCommand(d,r,n);}finally{this.lokBindings.documentDestroy(d);}}finally{try{a.unlink(s);}catch{}try{a.rmdir("/tmp/uno");}catch{}}}async renderPage(e,t,r,n,o=0){if(!this.initialized||!this.module||!this.lokBindings)throw new S("WASM_NOT_INITIALIZED","Converter not initialized");let i=this.normalizeInput(e),a=`/tmp/renderpage/doc.${(t.inputFormat||"docx").toLowerCase()}`,d=this.module.FS;try{try{d.mkdir("/tmp/renderpage");}catch{}d.writeFile(a,i);let h=this.lokBindings.documentLoad(a);if(h===0)throw new S("LOAD_FAILED","Failed to load document");try{let m=this.lokBindings.renderPage(h,r,n,o);return {page:r,data:m.data,width:m.width,height:m.height}}finally{this.lokBindings.documentDestroy(h);}}finally{try{d.unlink(a);}catch{}try{d.rmdir("/tmp/renderpage");}catch{}}}openDocument(e,t){return Promise.reject(new S("CONVERSION_FAILED","Editor sessions not supported by LibreOfficeConverter. Use WorkerConverter or WorkerBrowserConverter."))}editorOperation(e,t,r){return Promise.reject(new S("CONVERSION_FAILED","Editor operations not supported by LibreOfficeConverter. Use WorkerConverter or WorkerBrowserConverter."))}closeDocument(e){return Promise.reject(new S("CONVERSION_FAILED","Editor sessions not supported by LibreOfficeConverter. Use WorkerConverter or WorkerBrowserConverter."))}getLokBindings(){return this.lokBindings}destroy(){if(this.lokBindings){try{this.lokBindings.destroy();}catch{}this.lokBindings=null;}if(this.module)try{let e=this.module;if(e.PThread?.terminateAllThreads&&e.PThread.terminateAllThreads(),e.PThread?.runningWorkers){for(let t of e.PThread.runningWorkers)t?.unref&&t.unref(),t?.terminate&&t.terminate();e.PThread.runningWorkers=[];}if(e.PThread?.unusedWorkers){for(let t of e.PThread.unusedWorkers)t?.unref&&t.unref(),t?.terminate&&t.terminate();e.PThread.unusedWorkers=[];}}catch{}return this.module=null,this.initialized=false,Promise.resolve()}isReady(){return this.initialized}getModule(){return this.module}static getSupportedInputFormats(){return Object.keys(le)}static getSupportedOutputFormats(){return Object.keys(te)}static getValidOutputFormats(e){return z(e)}static isConversionSupported(e,t){return re(e,t)}normalizeInput(e){return e instanceof Uint8Array?e:e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e)}getExtensionFromFilename(e){let t=e.split(".");return t.length>1&&t.pop()?.toLowerCase()||null}getBasename(e){let t=e.lastIndexOf(".");return t>0?e.substring(0,t):e}emitProgress(e,t,r){this.options.onProgress?.({phase:e,percent:t,message:r});}};var Se={"download-wasm":50,"download-data":30,compile:5,filesystem:7,"lok-init":7,ready:1,starting:0,loading:0,initializing:0,converting:0,complete:0},F={"download-wasm":0,"download-data":0,compile:0,filesystem:0,"lok-init":0,ready:0,starting:0,loading:0,initializing:0,converting:0,complete:0},ye=0,ee=0;function Ee(){let l=0;for(let t of Object.keys(F))l+=F[t];let e=Math.min(100,Math.round(l));return e>ee&&(ee=e),ee}function Q(l){return `${(l/1048576).toFixed(1)} MB`}function ge(l,e,t){let r=Se[l],n=t>0?e/t:0,o=r*n;o>F[l]&&(F[l]=o);let i=l==="download-wasm"?`Downloading WebAssembly... ${Q(e)} / ${Q(t)}`:`Downloading filesystem... ${Q(e)} / ${Q(t)}`;_e({percent:Ee(),message:i,phase:l,bytesLoaded:e,bytesTotal:t});}function $(l,e){let t=Se[l];t>F[l]&&(F[l]=t),_e({percent:Ee(),message:e,phase:l});}function _e(l){self.postMessage({type:"progress",id:ye,progress:l});}function ve(){let l=self.fetch;self.fetch=async function(r,n){let o=typeof r=="string"?r:r instanceof URL?r.href:r.url,i=null;o.includes("soffice.wasm")?(i="download-wasm",console.log("[Worker] Starting fetch download: soffice.wasm")):o.includes("soffice.data")&&(i="download-data",console.log("[Worker] Starting fetch download: soffice.data"));let s=await l(r,n);if(!i)return s;let a=s.headers.get("Content-Length"),d=a?parseInt(a,10):0;if(!d||!s.body)return console.log(`[Worker] No content-length for ${o}, skipping progress tracking`),s;let h=s.body.getReader(),m=0,u=new ReadableStream({async start(g){for(;;){let{done:_,value:E}=await h.read();if(_){console.log(`[Worker] Finished fetch download: ${i==="download-wasm"?"soffice.wasm":"soffice.data"}`),g.close();break}m+=E.length,ge(i,m,d),g.enqueue(E);}}});return new Response(u,{headers:s.headers,status:s.status,statusText:s.statusText})},console.log("[Worker] Installed progress-tracking fetch interceptor");let e=self.XMLHttpRequest,t=function(){let r=new e,n="",o=r.open.bind(r);r.open=function(s,a,d,h,m){return n=String(a),o(s,a,d??true,h,m)};let i=r.send.bind(r);return r.send=function(s){let a=null;if(n.includes("soffice.wasm")?(a="download-wasm",console.log("[Worker] Starting XHR download: soffice.wasm")):n.includes("soffice.data")&&(a="download-data",console.log("[Worker] Starting XHR download: soffice.data")),a){let d=a;r.addEventListener("progress",h=>{h.lengthComputable&&ge(d,h.loaded,h.total);}),r.addEventListener("load",()=>{console.log(`[Worker] Finished XHR download: ${d==="download-wasm"?"soffice.wasm":"soffice.data"}`);});}return i(s)},r};Object.defineProperty(t,"prototype",{value:e.prototype,writable:false}),self.XMLHttpRequest=t,console.log("[Worker] Installed progress-tracking XHR interceptor");}var y=null,c=null,W=null,w=false,R=null,N=new Map,Ae=0;function Ie(l){let e=0,t=Math.max(1,Math.floor(l.length/1e3));for(let r=0;r<l.length;r+=t){let n=l[r];n!==void 0&&(e=(e<<5)-e+n|0);}return `${e}_${l.length}`}function xe(l){let e=c.documentGetDocumentType(l);if(e===0){let r=c.getPartPageRectangles(l);if(r){let n=c.parsePageRectangles(r);return console.log(`[Worker] getDocumentPageCount: TEXT doc has ${n.length} pages from rectangles`),n.length}return console.log("[Worker] getDocumentPageCount: TEXT doc has no page rectangles, assuming 1 page"),1}let t=c.documentGetParts(l);return console.log(`[Worker] getDocumentPageCount: docType=${e} has ${t} parts`),t}function D(l,e){let t=Ie(l);if(R&&R.inputHash===t&&c)return console.log(`[Worker] getOrLoadDocument: reusing cached doc ptr=${R.docPtr}, pageCount=${R.pageCount}`),{docPtr:R.docPtr,pageCount:R.pageCount};console.log(`[Worker] getOrLoadDocument: loading new document (hash=${t})`),v();let r=`/tmp/input/cached_doc.${e||"docx"}`;y.FS.writeFile(r,l);let n=c.documentLoad(r);if(n===0){let i=c.getError();throw new Error(i||"Failed to load document")}let o=xe(n);return console.log(`[Worker] getOrLoadDocument: loaded doc ptr=${n}, pageCount=${o}`),R={docPtr:n,inputHash:t,filePath:r,pageCount:o},{docPtr:n,pageCount:o}}function v(){if(R&&c&&y){console.log(`[Worker] closeCachedDocument: closing cached doc ptr=${R.docPtr}`);try{c.documentDestroy(R.docPtr);}catch{}try{y.FS.unlink(R.filePath);}catch{}R=null;}}function f(l){l.data?self.postMessage(l,[l.data.buffer]):self.postMessage(l);}function L(l,e,t){f({type:"progress",id:l,progress:{percent:e,message:t}});}async function Fe(l){if(w){f({type:"ready",id:l.id});return}let{sofficeJs:e,sofficeWasm:t,sofficeData:r,sofficeWorkerJs:n}=l;if(!e||!t||!r||!n){f({type:"error",id:l.id,error:"Missing required WASM paths (sofficeJs, sofficeWasm, sofficeData, sofficeWorkerJs)"});return}let o=l.verbose||false;ye=l.id;for(let i of Object.keys(F))F[i]=0;ee=0,ve(),$("download-wasm","Preparing to download WebAssembly...");try{console.log("[Worker] Setting up Module with explicit paths:",{sofficeJs:e,sofficeWasm:t,sofficeData:r,sofficeWorkerJs:n}),self.Module={mainScriptUrlOrBlob:e,locateFile:(s,a)=>{let d;return s.endsWith(".wasm")?d=t:s.endsWith(".data")?d=r:s.includes(".worker.")?d=n:d=`${e.substring(0,e.lastIndexOf("/")+1)}${s}`,console.log("[Worker] locateFile called:",s,"scriptDir:",a,"-> result:",d),d},print:console.log,printErr:console.error},importScripts(e),$("compile","Compiling WebAssembly module..."),await new Promise((s,a)=>{let d=()=>{if(self.Module&&self.Module.calledRun)s();else if(self.Module?.onRuntimeInitialized){let h=self.Module.onRuntimeInitialized;self.Module.onRuntimeInitialized=()=>{h?.(),s();};}else self.Module&&(self.Module.onRuntimeInitialized=s);setTimeout(()=>a(new Error("WASM initialization timeout")),12e4);};self.Module&&self.Module.calledRun?s():d();}),y=self.Module,$("filesystem","Setting up filesystem...");try{let s=y;s.ENV?(s.ENV.SAL_LOG="+ALL",s.ENV.MAX_CONCURRENCY="1",console.log("[Worker] Set SAL_LOG to +ALL")):console.log("[Worker] ENV not available");}catch(s){console.log("[Worker] Could not set SAL_LOG:",s);}let i=y.FS;if(o){let s=i.open.bind(i);i.open=(a,d,h)=>{console.log("[FS OPEN CALL]",a);try{return s(a,d,h)}catch(m){throw m?.code==="ENOENT"&&console.log("[FS ENOENT]",a),m}};}try{i.mkdir("/tmp");}catch{}try{i.mkdir("/tmp/input");}catch{}try{i.mkdir("/tmp/output");}catch{}if($("lok-init","Initializing LibreOfficeKit..."),W=new q({verbose:o}),await W.initializeWithModule(y),c=W.getLokBindings(),!c)throw new Error("Failed to get LOK bindings from converter");c.enableSyncEvents(),console.log("[LOK Worker] Enabled synchronous event dispatch (Unipoll mode)"),w=!0,$("ready","Ready"),f({type:"ready",id:l.id});}catch(i){f({type:"error",id:l.id,error:i instanceof Error?i.message:String(i)});}}var De=["png","jpg","jpeg","svg"];function We(l){if(!w||!y||!c){f({type:"error",id:l.id,error:"Worker not initialized"});return}let{inputData:e,inputExt:t,outputFormat:r,filterOptions:n,password:o}=l;if(!e||!r){f({type:"error",id:l.id,error:"Missing input data or output format"});return}let i=De.includes(r.toLowerCase()),s=`/tmp/input/doc.${t||"docx"}`,a=`/tmp/output/doc.${r}`,d=0,h=[];try{if(L(l.id,10,"Writing input file..."),y.FS.writeFile(s,e),L(l.id,30,"Loading document..."),o?d=c.documentLoadWithOptions(s,`,Password=${o}`):d=c.documentLoad(s),d===0){let g=c.getError();throw new Error(g||"Failed to load document")}let m=c.documentGetParts(d),u=c.documentGetDocumentType(d);if(i&&m>1){L(l.id,40,`Exporting ${m} pages as ${r.toUpperCase()}...`);let g=K[r],_=n||M[r]||"",E=[],{width:p,height:O}=c.documentGetDocumentSize(d),k=O/p,I=1024,U=Math.round(I*k);for(let P=0;P<m;P++){let V=40+Math.round(P/m*40);L(l.id,V,`Exporting page ${P+1}/${m}...`);let C=`/tmp/output/page_${P+1}.${r}`;if(h.push(C),u===2||u===3){c.documentSetPart(d,P);let T=_;(r==="png"||r==="jpg"||r==="jpeg")&&(T=`PixelWidth=${I};PixelHeight=${U}`,_&&(T=`${_};${T}`)),c.documentSaveAs(d,C,g,T),console.log(`[Worker] Page ${P+1} (presentation) exported with opts: ${T}`);}else {let T=`PageRange=${P+1}-${P+1}`;(r==="png"||r==="jpg"||r==="jpeg")&&(T+=`;PixelWidth=${I};PixelHeight=${U}`),_&&(T=`${_};${T}`),c.documentSaveAs(d,C,g,T),console.log(`[Worker] Page ${P+1} (text) exported with opts: ${T}`);}let b=y.FS.readFile(C);if(console.log(`[Worker] Page ${P+1} exported: ${b.length} bytes`),b.length>0){let T=new Uint8Array(b.length);T.set(b),E.push({name:`page_${P+1}.${r}`,data:T});}else console.warn(`[Worker] Page ${P+1} export produced empty file`);}L(l.id,85,"Creating ZIP archive...");let B=Ne(E);L(l.id,100,"Complete"),f({type:"result",id:l.id,data:B});}else {L(l.id,50,"Converting...");let g=K[r],_=n||M[r]||"";L(l.id,70,"Saving..."),c.documentSaveAs(d,a,g,_),h.push(a),L(l.id,90,"Reading output...");let E=y.FS.readFile(a);if(E.length===0)throw new Error("Conversion produced empty output");let p=new Uint8Array(E.length);p.set(E),L(l.id,100,"Complete"),f({type:"result",id:l.id,data:p});}}catch(m){f({type:"error",id:l.id,error:m instanceof Error?m.message:String(m)});}finally{if(d!==0)try{c.documentDestroy(d);}catch{}try{y.FS.unlink(s);}catch{}for(let m of h)try{y.FS.unlink(m);}catch{}}}function Ne(l){let e=[],t=[],r=0;for(let m of l){let u=new TextEncoder().encode(m.name),g=new Uint8Array(30+u.length),_=new DataView(g.buffer);_.setUint32(0,67324752,true),_.setUint16(4,20,true),_.setUint16(6,0,true),_.setUint16(8,0,true),_.setUint16(10,0,true),_.setUint16(12,0,true),_.setUint32(14,fe(m.data),true),_.setUint32(18,m.data.length,true),_.setUint32(22,m.data.length,true),_.setUint16(26,u.length,true),_.setUint16(28,0,true),g.set(u,30),e.push(g),e.push(m.data);let E=new Uint8Array(46+u.length),p=new DataView(E.buffer);p.setUint32(0,33639248,true),p.setUint16(4,20,true),p.setUint16(6,20,true),p.setUint16(8,0,true),p.setUint16(10,0,true),p.setUint16(12,0,true),p.setUint16(14,0,true),p.setUint32(16,fe(m.data),true),p.setUint32(20,m.data.length,true),p.setUint32(24,m.data.length,true),p.setUint16(28,u.length,true),p.setUint16(30,0,true),p.setUint16(32,0,true),p.setUint16(34,0,true),p.setUint16(36,0,true),p.setUint32(38,0,true),p.setUint32(42,r,true),E.set(u,46),t.push(E),r+=g.length+m.data.length;}let n=r,o=0;for(let m of t)e.push(m),o+=m.length;let i=new Uint8Array(22),s=new DataView(i.buffer);s.setUint32(0,101010256,true),s.setUint16(4,0,true),s.setUint16(6,0,true),s.setUint16(8,l.length,true),s.setUint16(10,l.length,true),s.setUint32(12,o,true),s.setUint32(16,n,true),s.setUint16(20,0,true),e.push(i);let a=e.reduce((m,u)=>m+u.length,0),d=new Uint8Array(a),h=0;for(let m of e)d.set(m,h),h+=m.length;return d}function fe(l){let e=4294967295;for(let t=0;t<l.length;t++){let r=l[t];e^=r;for(let n=0;n<8;n++)e=e>>>1^(e&1?3988292384:0);}return (e^4294967295)>>>0}async function Ue(l){if(!w||!y||!c){f({type:"error",id:l.id,error:"Worker not initialized"});return}let{inputData:e,inputExt:t}=l;if(!e){f({type:"error",id:l.id,error:"Missing input data"});return}try{let{pageCount:r}=D(e,t||"docx");f({type:"pageCount",id:l.id,pageCount:r});}catch(r){f({type:"error",id:l.id,error:r instanceof Error?r.message:String(r)}),v();}}async function Ke(l){if(!w||!y||!c){f({type:"error",id:l.id,error:"Worker not initialized"});return}let{inputData:e,inputExt:t,maxWidth:r=256}=l;if(!e){f({type:"error",id:l.id,error:"Missing input data"});return}try{L(l.id,10,"Loading document for preview...");let{docPtr:n,pageCount:o}=D(e,t||"docx");L(l.id,20,`Rendering ${o} pages...`);let i=[];for(let a=0;a<o;a++){let d=20+Math.round(a/o*70);L(l.id,d,`Rendering page ${a+1}/${o}...`);let h=c.renderPage(n,a,r),m=new Uint8Array(h.data.length);m.set(h.data),i.push({page:a+1,data:m,width:h.width,height:h.height});}L(l.id,100,"Preview complete");let s=i.map(a=>a.data.buffer);self.postMessage({type:"previews",id:l.id,previews:i},s);}catch(n){f({type:"error",id:l.id,error:n instanceof Error?n.message:String(n)}),v();}}async function Me(l){if(!w||!y||!c){f({type:"error",id:l.id,error:"Worker not initialized"});return}let{inputData:e,inputExt:t,maxWidth:r=256,pageIndex:n=0}=l;if(!e){f({type:"error",id:l.id,error:"Missing input data"});return}let o=-1,i=0;try{let s=D(e,t||"docx");i=s.docPtr;let a=s.pageCount;if(n<0||n>=a)throw new Error(`Page index ${n} out of range (0-${a-1})`);let d=c.documentGetDocumentType(i);console.log(`[Worker] handleRenderSinglePage: ${["TEXT","SPREADSHEET","PRESENTATION","DRAWING"][d]||"UNKNOWN"} document - creating view for rendering`),o=c.createView(i),o>=0&&(c.setView(i,o),console.log(`[Worker] handleRenderSinglePage: Created and set view ${o}`)),console.log(`[Worker] handleRenderSinglePage: calling renderPage for page ${n} at maxWidth=${r}...`);let m=c.renderPage(i,n,r);console.log(`[Worker] handleRenderSinglePage: renderPage returned ${m.data.length} bytes (${m.width}x${m.height})`);let u=new Uint8Array(m.data.length);u.set(m.data);let g={page:n+1,data:u,width:m.width,height:m.height};if(o>=0&&i!==0){try{c.destroyView(i,o);}catch{}console.log(`[Worker] handleRenderSinglePage: Destroyed view ${o}`);}self.postMessage({type:"singlePagePreview",id:l.id,preview:g},[u.buffer]);}catch(s){if(o>=0&&i!==0){try{c.destroyView(i,o);}catch{}console.log(`[Worker] handleRenderSinglePage: Destroyed view ${o} (on error)`);}let a=s instanceof Error?String(s.message):String(s);f({type:"error",id:l.id,error:a}),v();}}async function $e(l){if(!w||!y||!c){f({type:"error",id:l.id,error:"Worker not initialized"});return}let{inputData:e,inputExt:t,maxWidth:r=256,pageIndex:n=0}=l;if(!e){f({type:"error",id:l.id,error:"Missing input data"});return}let o=`/tmp/output/page_${n}.png`;try{let{docPtr:i,pageCount:s}=D(e,t||"pdf"),a=c.documentGetDocumentType(i);if(n<0||n>=s)throw new Error(`Page index ${n} out of range (0-${s-1})`);(a===2||a===3)&&c.documentSetPart(i,n);let{width:d,height:h}=c.documentGetDocumentSize(i),m=h/d,u=Math.min(r,d),g=Math.round(u*m),_=`PixelWidth=${u};PixelHeight=${g}`;a===0&&(_+=`;PageRange=${n+1}-${n+1}`),c.documentSaveAs(i,o,"png",_);let E=y.FS.readFile(o);if(E.length===0)throw new Error("PNG export produced empty output");let p=new Uint8Array(E.length);p.set(E);let O={page:n+1,data:p,width:u,height:g,format:"png"};self.postMessage({type:"singlePagePreview",id:l.id,preview:O,isPng:!0},[p.buffer]);try{y.FS.unlink(o);}catch{}}catch(i){f({type:"error",id:l.id,error:i instanceof Error?i.message:String(i)}),v();try{y.FS.unlink(o);}catch{}}}async function Be(l){if(!w||!y||!c){f({type:"error",id:l.id,error:"Worker not initialized"});return}let{inputData:e,inputExt:t}=l;if(!e){f({type:"error",id:l.id,error:"Missing input data"});return}try{let{docPtr:r,pageCount:n}=D(e,t||"docx"),o=c.documentGetDocumentType(r),i={0:["pdf","docx","doc","odt","rtf","txt","html","png","jpg","svg"],1:["pdf","xlsx","xls","ods","csv","html","png","jpg","svg"],2:["pdf","pptx","ppt","odp","png","jpg","svg","html"],3:["pdf","png","jpg","svg","html"],4:["pdf"]},a={documentType:o,documentTypeName:{0:"Text Document",1:"Spreadsheet",2:"Presentation",3:"Drawing",4:"Other"}[o]||"Unknown",validOutputFormats:i[o]||["pdf"],pageCount:n};f({type:"documentInfo",id:l.id,documentInfo:a});}catch(r){f({type:"error",id:l.id,error:r instanceof Error?r.message:String(r)}),v();}}async function Ve(l){if(console.log("[LOK Worker] handleGetLokInfo called"),!w||!y||!c){f({type:"error",id:l.id,error:"Worker not initialized"});return}let{inputData:e,inputExt:t}=l;if(!e){f({type:"error",id:l.id,error:"Missing input data"});return}try{console.log("[LOK Worker] Getting or loading document...");let{docPtr:r}=D(e,t||"docx");console.log(`[LOK Worker] Got docPtr: ${r}`),console.log("[LOK Worker] Calling LOK methods...");let n=c.getPartPageRectangles(r);console.log(`[LOK Worker] pageRectangles: ${n}`);let o=c.documentGetDocumentSize(r);console.log(`[LOK Worker] documentSize: ${o.width}x${o.height}`);let i=c.getPartInfo(r,0);console.log(`[LOK Worker] partInfo: ${i}`);let s=c.getA11yFocusedParagraph(r);console.log(`[LOK Worker] a11yFocusedParagraph: ${s}`);let a=c.getA11yCaretPosition(r);console.log(`[LOK Worker] a11yCaretPosition: ${a}`);let d=c.getEditMode(r);console.log(`[LOK Worker] editMode (initial): ${d}`);let h=null,m=-1;m=c.getView(r),console.log(`[LOK Worker] Got existing view: ${m}`),m>=0&&(c.setView(r,m),console.log(`[LOK Worker] Set active view to ${m}`));let u=c.createView(r);console.log(`[LOK Worker] Created new view: ${u}`),u>=0&&(c.setView(r,u),console.log(`[LOK Worker] Switched to new view: ${u}`)),c.setEditMode(r,1),d=c.getEditMode(r),console.log(`[LOK Worker] editMode (after setEditMode): ${d}`),h=c.getAllText(r),console.log(`[LOK Worker] allText: ${h?.slice(0,100)||"null"}`),u>=0&&(c.destroyView(r,u),console.log(`[LOK Worker] Destroyed view: ${u}`));let g=null;if(i)try{g=JSON.parse(i);}catch{console.warn("[LOK Worker] Failed to parse partInfo JSON:",i);}let _=null;if(s)try{_=JSON.parse(s);}catch{console.warn("[LOK Worker] Failed to parse a11yFocusedParagraph JSON:",s);}let E={pageRectangles:n,documentSize:o,partInfo:g,a11yFocusedParagraph:_,a11yCaretPosition:a,editMode:d,allText:h};console.log("[LOK Worker] Posting lokInfo response"),f({type:"lokInfo",id:l.id,lokInfo:E});}catch(r){console.error("[LOK Worker] Error in handleGetLokInfo:",r),f({type:"error",id:l.id,error:r instanceof Error?r.message:String(r)}),v();}}async function ze(l){if(console.log("[LOK Worker] handleEditText called"),!w||!y||!c){f({type:"error",id:l.id,error:"Worker not initialized"});return}let{inputData:e,inputExt:t,findText:r,replaceText:n,insertText:o}=l;if(!e){f({type:"error",id:l.id,error:"Missing input data"});return}v();let i=`/tmp/input/edit_doc.${t||"docx"}`,s=`/tmp/output/edited_doc.${t||"docx"}`,a=0,d=-1;try{if(console.log("[LOK Worker] Writing input file..."),y.FS.writeFile(i,e),console.log("[LOK Worker] Loading document for editing..."),a=c.documentLoad(i),a===0){let p=c.getError();throw new Error(p||"Failed to load document")}console.log(`[LOK Worker] Document loaded, docPtr=${a}`),c.documentInitializeForRendering(a),console.log("[LOK Worker] Document initialized for rendering"),d=c.getView(a),console.log(`[LOK Worker] Got existing view: ${d}`),d>=0&&(c.setView(a,d),console.log(`[LOK Worker] Set active view to ${d}`));let h=c.createView(a);console.log(`[LOK Worker] Created new view: ${h}`),h>=0&&(c.setView(a,h),console.log(`[LOK Worker] Switched to new view: ${h}`),d=h),c.setEditMode(a,1);let m=c.getEditMode(a);console.log(`[LOK Worker] Edit mode after setEditMode(1): ${m}`);let u="";if(r&&n!==void 0){console.log(`[LOK Worker] Attempting find/replace: "${r}" -> "${n}"`);let p=JSON.stringify({"SearchItem.SearchString":{type:"string",value:r},"SearchItem.ReplaceString":{type:"string",value:n},"SearchItem.Command":{type:"unsigned short",value:"3"}});try{c.postUnoCommand(a,".uno:ExecuteSearch",p),u=`Attempted replace all "${r}" with "${n}"`,console.log(`[LOK Worker] ${u}`);}catch(O){console.error("[LOK Worker] ExecuteSearch threw:",O),u=`ExecuteSearch failed: ${String(O)}`;}}else if(o){console.log(`[LOK Worker] Attempting to insert text: "${o}"`);let p=[];try{console.log("[LOK Worker] Clicking in document to establish focus..."),c.postMouseEvent(a,0,1e3,1e3,1,1,0),c.postMouseEvent(a,1,1e3,1e3,1,1,0),console.log("[LOK Worker] Posted mouse events for focus"),p.push("mouseEvents:ok");}catch(k){console.error("[LOK Worker] postMouseEvent threw:",k),p.push("mouseEvents:err");}try{c.postUnoCommand(a,".uno:GoToEndOfDoc"),console.log("[LOK Worker] Posted GoToEndOfDoc"),p.push("GoToEndOfDoc:ok");}catch(k){console.error("[LOK Worker] GoToEndOfDoc threw:",k),p.push("GoToEndOfDoc:err");}let O=!1;try{console.log("[LOK Worker] Trying paste() with text/plain..."),O=c.paste(a,"text/plain;charset=utf-8",o),console.log(`[LOK Worker] paste() returned: ${O}`),p.push(`paste:${O}`);}catch(k){console.error("[LOK Worker] paste() threw:",k),p.push("paste:err");}try{let k=JSON.stringify({Text:{type:"string",value:o}});c.postUnoCommand(a,".uno:InsertText",k),console.log("[LOK Worker] Posted InsertText"),p.push("InsertText:ok");}catch(k){console.error("[LOK Worker] InsertText threw:",k),p.push("InsertText:err");}try{console.log("[LOK Worker] Now trying postKeyEvent for each character...");for(let k=0;k<o.length;k++){let I=o.charCodeAt(k);c.postKeyEvent(a,0,I,0),c.postKeyEvent(a,1,I,0);}console.log(`[LOK Worker] Posted ${o.length} key events`),p.push(`keyEvents:${o.length}`);}catch(k){console.error("[LOK Worker] postKeyEvent threw:",k),p.push("keyEvents:err");}u=`Insert attempts: ${p.join(", ")}`,console.log(`[LOK Worker] ${u}`);}else u="No edit operation specified (need findText+replaceText or insertText)",console.log(`[LOK Worker] ${u}`);console.log("[LOK Worker] Attempting to save modified document...");let g=t||"docx",E={docx:"docx",doc:"doc",odt:"odt",xlsx:"xlsx",xls:"xls",ods:"ods",pptx:"pptx",ppt:"ppt",odp:"odp"}[g]||g;try{c.documentSaveAs(a,s,E,""),console.log("[LOK Worker] Document saved");let p=y.FS.readFile(s);console.log(`[LOK Worker] Modified document size: ${p.length} bytes`);let O=new Uint8Array(p.length);O.set(p);let k={success:!0,editMode:m,message:u+` | Document saved (${O.length} bytes)`,modifiedDocument:O};self.postMessage({type:"editResult",id:l.id,editResult:k},[O.buffer]);}catch(p){console.error("[LOK Worker] Save error:",p);let O={success:!1,editMode:m,message:u+` | Save failed: ${String(p)}`};f({type:"editResult",id:l.id,editResult:O});}}catch(h){console.error("[LOK Worker] Error in handleEditText:",h),h instanceof Error&&(console.error("[LOK Worker] Error name:",h.name),console.error("[LOK Worker] Error message:",h.message),console.error("[LOK Worker] Error stack:",h.stack));let m=h;if(m&&typeof m=="object"){console.error("[LOK Worker] Error keys:",Object.keys(m));for(let u of Object.keys(m))try{console.error(`[LOK Worker] Error.${u}:`,m[u]);}catch{}}if(typeof h=="number"){console.error("[LOK Worker] Emscripten exception pointer:",h);let u=y;if(u&&typeof u.getExceptionMessage=="function")try{let g=u.getExceptionMessage(h);console.error("[LOK Worker] Emscripten exception message:",g);}catch{}}f({type:"error",id:l.id,error:h instanceof Error?h.message:String(h)});}finally{if(a!==0&&c){if(d>=0)try{c.destroyView(a,d);}catch{}try{c.documentDestroy(a);}catch{}}if(y){try{y.FS.unlink(i);}catch{}try{y.FS.unlink(s);}catch{}}}}async function Ge(l){if(console.log("[LOK Worker] handleRenderPageRectangles called"),!w||!y||!c){f({type:"error",id:l.id,error:"Worker not initialized"});return}let{inputData:e,inputExt:t,maxWidth:r=256}=l;if(!e){f({type:"error",id:l.id,error:"Missing input data"});return}try{let{docPtr:n}=D(e,t||"docx");c.documentInitializeForRendering(n);let o=c.getPartPageRectangles(n);if(console.log(`[LOK Worker] Page rectangles string: ${o?.slice(0,100)||"null"}...`),!o||o.length===0){f({type:"pageRectangles",id:l.id,pageRectangles:[]});return}let i=c.parsePageRectangles(o);console.log(`[LOK Worker] Parsed ${i.length} page rectangles`);let s=[],a=[];for(let d=0;d<i.length;d++){let h=i[d];console.log(`[LOK Worker] Rendering page ${d}: x=${h.x}, y=${h.y}, w=${h.width}, h=${h.height}`);let m=h.height/h.width,u=r,g=Math.round(r*m),_=c.documentPaintTile(n,u,g,h.x,h.y,h.width,h.height),E=new Uint8Array(_.length);E.set(_),s.push({index:d,x:h.x,y:h.y,width:h.width,height:h.height,imageData:E,imageWidth:u,imageHeight:g}),a.push(E.buffer),console.log(`[LOK Worker] Rendered page ${d}: ${u}x${g}, ${E.length} bytes`);}self.postMessage({type:"pageRectangles",id:l.id,pageRectangles:s},a);}catch(n){console.error("[LOK Worker] Error in handleRenderPageRectangles:",n);let o=n instanceof Error?String(n.message):String(n);f({type:"error",id:l.id,error:o}),v();}}async function He(l){if(console.log("[LOK Worker] handleTestLokOperations called"),!w||!y||!c){f({type:"error",id:l.id,error:"Worker not initialized"});return}let{inputData:e,inputExt:t}=l;if(!e){f({type:"error",id:l.id,error:"Missing input data"});return}v();let r=`/tmp/input/test_ops_doc.${t||"docx"}`,n=`/tmp/output/test_ops_doc.${t||"docx"}`,o=0,i=-1,s=[];try{if(console.log("[LOK Worker] Writing input file..."),y.FS.writeFile(r,e),console.log("[LOK Worker] Loading document for LOK operations testing..."),o=c.documentLoad(r),o===0){let u=c.getError();throw new Error(u||"Failed to load document")}console.log(`[LOK Worker] Document loaded, docPtr=${o}`),c.documentInitializeForRendering(o),console.log("[LOK Worker] Document initialized for rendering"),i=c.getView(o),console.log(`[LOK Worker] Got existing view: ${i}`),i>=0&&c.setView(o,i);let a=c.createView(o);console.log(`[LOK Worker] Created new view: ${a}`),a>=0&&(c.setView(o,a),i=a),c.setEditMode(o,1);let d=c.getEditMode(o);console.log(`[LOK Worker] Edit mode: ${d}`),c.registerCallback(o),c.clearCallbackQueue(),console.log("[LOK Worker] Callback registered for STATE_CHANGED events");try{c.postMouseEvent(o,0,1e3,1e3,1,1,0),c.postMouseEvent(o,1,1e3,1e3,1,1,0),s.push({operation:"establishFocus",success:!0,result:"Mouse click events sent"});}catch(u){s.push({operation:"establishFocus",success:!1,error:String(u)});}console.log("[LOK Worker] Testing SelectAll + getTextSelection...");try{c.postUnoCommand(o,".uno:SelectAll");let u=c.getTextSelection(o,"text/plain;charset=utf-8"),g=u?.length||0;console.log(`[LOK Worker] SelectAll result: ${g} chars, preview: "${u?.slice(0,100)}..."`),s.push({operation:"SelectAll+getTextSelection",success:g>0,result:{textLength:g,preview:u?.slice(0,200)}});}catch(u){console.error("[LOK Worker] SelectAll error:",u),s.push({operation:"SelectAll+getTextSelection",success:!1,error:String(u)});}console.log("[LOK Worker] Testing getSelectionType...");try{let u=c.getSelectionType(o);console.log(`[LOK Worker] Selection type: ${u}`),s.push({operation:"getSelectionType",success:!0,result:{selectionType:u,meaning:u===0?"NONE":u===1?"TEXT":u===2?"CELL":"UNKNOWN"}});}catch(u){console.error("[LOK Worker] getSelectionType error:",u),s.push({operation:"getSelectionType",success:!1,error:String(u)});}console.log("[LOK Worker] Testing resetSelection...");try{c.resetSelection(o);let u=c.getSelectionType(o);console.log(`[LOK Worker] Selection type after reset: ${u}`),s.push({operation:"resetSelection",success:!0,result:{selectionTypeAfterReset:u}});}catch(u){console.error("[LOK Worker] resetSelection error:",u),s.push({operation:"resetSelection",success:!1,error:String(u)});}console.log("[LOK Worker] Testing GoToStartOfDoc + selection + Delete...");try{c.postUnoCommand(o,".uno:GoToStartOfDoc"),console.log("[LOK Worker] Sent GoToStartOfDoc"),c.postUnoCommand(o,".uno:WordRightSel"),console.log("[LOK Worker] Sent WordRightSel");let u=c.getTextSelection(o,"text/plain;charset=utf-8");console.log(`[LOK Worker] Selected text before delete: "${u}"`),c.postUnoCommand(o,".uno:Delete"),console.log("[LOK Worker] Sent Delete"),s.push({operation:"SelectWord+Delete",success:!0,result:{deletedText:u}});}catch(u){console.error("[LOK Worker] SelectWord+Delete error:",u),s.push({operation:"SelectWord+Delete",success:!1,error:String(u)});}console.log("[LOK Worker] Testing Undo...");try{c.postUnoCommand(o,".uno:Undo"),console.log("[LOK Worker] Sent Undo"),c.postUnoCommand(o,".uno:SelectAll");let u=c.getTextSelection(o,"text/plain;charset=utf-8");console.log(`[LOK Worker] Text after Undo: ${u?.length} chars`),s.push({operation:"Undo",success:!0,result:{textLengthAfterUndo:u?.length||0}});}catch(u){console.error("[LOK Worker] Undo error:",u),s.push({operation:"Undo",success:!1,error:String(u)});}console.log("[LOK Worker] Testing Redo...");try{c.postUnoCommand(o,".uno:Redo"),console.log("[LOK Worker] Sent Redo"),c.postUnoCommand(o,".uno:SelectAll");let u=c.getTextSelection(o,"text/plain;charset=utf-8");console.log(`[LOK Worker] Text after Redo: ${u?.length} chars`),s.push({operation:"Redo",success:!0,result:{textLengthAfterRedo:u?.length||0}});}catch(u){console.error("[LOK Worker] Redo error:",u),s.push({operation:"Redo",success:!1,error:String(u)});}console.log("[LOK Worker] Testing Bold formatting...");try{c.postUnoCommand(o,".uno:Undo"),c.postUnoCommand(o,".uno:GoToStartOfDoc"),c.postUnoCommand(o,".uno:WordRightSel");let u=c.getTextSelection(o,"text/plain;charset=utf-8");console.log(`[LOK Worker] Selected for bold: "${u}"`),c.postUnoCommand(o,".uno:Bold"),console.log("[LOK Worker] Sent Bold");let g=c.getCommandValues(o,".uno:Bold");console.log(`[LOK Worker] Bold state: ${g}`),s.push({operation:"Bold",success:!0,result:{selectedText:u,boldState:g}});}catch(u){console.error("[LOK Worker] Bold error:",u),s.push({operation:"Bold",success:!1,error:String(u)});}console.log("[LOK Worker] Testing Italic formatting...");try{c.postUnoCommand(o,".uno:GoRight"),c.postUnoCommand(o,".uno:WordRightSel");let u=c.getTextSelection(o,"text/plain;charset=utf-8");console.log(`[LOK Worker] Selected for italic: "${u}"`),c.postUnoCommand(o,".uno:Italic"),console.log("[LOK Worker] Sent Italic");let g=c.getCommandValues(o,".uno:Italic");console.log(`[LOK Worker] Italic state: ${g}`),s.push({operation:"Italic",success:!0,result:{selectedText:u,italicState:g}});}catch(u){console.error("[LOK Worker] Italic error:",u),s.push({operation:"Italic",success:!1,error:String(u)});}console.log("[LOK Worker] Testing getCharacterFormatting via STATE_CHANGED callbacks...");try{let u=c.getCallbackEventCount();console.log(`[LOK Worker] Existing events in queue: ${u}`);let g=c.pollStateChanges();console.log(`[LOK Worker] Existing STATE_CHANGED events: ${g.size}`);for(let[C,b]of g.entries())console.log(`[LOK Worker]   ${C} = ${b}`);c.clearCallbackQueue(),c.postUnoCommand(o,".uno:GoToStartOfDoc"),c.flushCallbacks(o),c.postUnoCommand(o,".uno:WordRightSel"),c.flushCallbacks(o);let _=c.getCallbackEventCount(),E=c.hasCallbackEvents();console.log(`[LOK Worker] Event count after WordRightSel: ${_}, hasEvents: ${E}`);let p=c.pollStateChanges();console.log(`[LOK Worker] State changes after selection: ${p.size}`);for(let[C,b]of p.entries())console.log(`[LOK Worker]   ${C} = ${b}`);for(let[C,b]of g.entries())p.has(C)||p.set(C,b);let O={};for(let[C,b]of p.entries())O[C]=b;console.log(`[LOK Worker] Received ${p.size} state changes:`);for(let[C,b]of p.entries())console.log(`  ${C} = ${b}`);let k=p.get(".uno:Bold")??null,I=p.get(".uno:Italic")??null,U=p.get(".uno:Underline")??null,B=p.get(".uno:CharFontName")??null,P=p.get(".uno:FontHeight")??null,V=p.get(".uno:Color")??p.get(".uno:CharColor")??null;console.log("[LOK Worker] Character formatting from STATE_CHANGED:"),console.log(`  Bold: ${k}`),console.log(`  Italic: ${I}`),console.log(`  Underline: ${U}`),console.log(`  FontName: ${B}`),console.log(`  FontSize: ${P}`),console.log(`  Color: ${V}`),s.push({operation:"getCharacterFormatting",success:!0,result:{stateChangeCount:p.size,note:p.size===0?"Callback queue empty - C++ shims may need to be added to WASM build":void 0,bold:k,italic:I,underline:U,fontName:B,fontSize:P,color:V,allStates:O}});}catch(u){console.error("[LOK Worker] getCharacterFormatting error:",u),s.push({operation:"getCharacterFormatting",success:!1,error:String(u)});}console.log("[LOK Worker] Testing setTextSelection...");try{c.resetSelection(o),c.setTextSelection(o,0,500,500),c.setTextSelection(o,1,3e3,500);let u=c.getTextSelection(o,"text/plain;charset=utf-8");console.log(`[LOK Worker] Coordinate-selected text: "${u}"`),s.push({operation:"setTextSelection",success:!0,result:{selectedText:u}});}catch(u){console.error("[LOK Worker] setTextSelection error:",u),s.push({operation:"setTextSelection",success:!1,error:String(u)});}console.log("[LOK Worker] Testing document save...");try{let u=t||"docx",_={docx:"docx",doc:"doc",odt:"odt",xlsx:"xlsx",xls:"xls",ods:"ods",pptx:"pptx",ppt:"ppt",odp:"odp"}[u]||u;c.documentSaveAs(o,n,_,"");let E=y.FS.readFile(n);s.push({operation:"documentSave",success:E.length>0,result:{savedBytes:E.length,originalBytes:e.length}});}catch(u){console.error("[LOK Worker] Save error:",u),s.push({operation:"documentSave",success:!1,error:String(u)});}let m=`${s.filter(u=>u.success).length}/${s.length} operations succeeded`;console.log(`[LOK Worker] Test results summary: ${m}`),f({type:"testLokOperations",id:l.id,testLokOperationsResult:{operations:s,summary:m}});}catch(a){console.error("[LOK Worker] Error in handleTestLokOperations:",a),f({type:"error",id:l.id,error:a instanceof Error?a.message:String(a)});}finally{if(o!==0&&c){try{c.unregisterCallback(o);}catch{}if(i>=0)try{c.destroyView(o,i);}catch{}try{c.documentDestroy(o);}catch{}}if(y){try{y.FS.unlink(r);}catch{}try{y.FS.unlink(n);}catch{}}}}async function je(l){if(!w||!y||!c){f({type:"error",id:l.id,error:"Worker not initialized"});return}let e=l.inputData,t=l.inputExt||"docx";if(!e||e.length===0){f({type:"error",id:l.id,error:"No input data provided"});return}try{let r=`session_${++Ae}_${Date.now()}`,n=`/tmp/edit_${r}.${t}`;y.FS.writeFile(n,e);let o=c.documentLoad(n);if(o===0){let h=c.getError();y.FS.unlink(n),f({type:"error",id:l.id,error:`Failed to load document: ${String(h)}`});return}c.documentInitializeForRendering(o);let i=c.createView(o);c.setView(o,i),c.registerCallback(o),c.postUnoCommand(o,".uno:Edit");let s=he(c,o),a=s.getDocumentType(),d=c.documentGetParts(o);N.set(r,{sessionId:r,docPtr:o,filePath:n,editor:s,documentType:a}),console.log(`[LOK Worker] Opened document session: ${r}, type: ${a}, pages: ${d}`),f({type:"editorSession",id:l.id,editorSession:{sessionId:r,documentType:a,pageCount:d}});}catch(r){console.error("[LOK Worker] Error in handleOpenDocument:",r),f({type:"error",id:l.id,error:r instanceof Error?r.message:String(r)});}}async function Je(l){let{sessionId:e,editorMethod:t,editorArgs:r}=l;if(!e||!t){f({type:"error",id:l.id,error:"Missing sessionId or editorMethod"});return}let n=N.get(e);if(!n){f({type:"error",id:l.id,error:`Session not found: ${e}`});return}try{let{editor:o}=n,i=r||[],s=o[t];if(typeof s!="function"){f({type:"error",id:l.id,error:`Unknown editor method: ${t}`});return}let a=s.apply(o,i),d=a.data;a.data instanceof Map&&(d=Object.fromEntries(a.data)),f({type:"editorOperationResult",id:l.id,editorOperationResult:{success:a.success,verified:a.verified,data:d,error:a.error,suggestion:a.suggestion}});}catch(o){console.error(`[LOK Worker] Error in handleEditorOperation (${t}):`,o),f({type:"error",id:l.id,error:o instanceof Error?o.message:String(o)});}}async function Xe(l){let{sessionId:e}=l;if(!e){f({type:"error",id:l.id,error:"Missing sessionId"});return}let t=N.get(e);if(!t){f({type:"error",id:l.id,error:`Session not found: ${e}`});return}try{let{docPtr:r,filePath:n}=t,o;if(y)try{let i=n.split(".").pop()||"docx";c?.documentSaveAs(r,n,i,""),o=y.FS.readFile(n);}catch(i){console.warn("[LOK Worker] Could not save document:",i);}if(c&&r!==0){try{c.unregisterCallback(r);}catch{}try{c.documentDestroy(r);}catch{}}if(y)try{y.FS.unlink(n);}catch{}N.delete(e),console.log(`[LOK Worker] Closed document session: ${e}`),f({type:"documentClosed",id:l.id,data:o});}catch(r){console.error("[LOK Worker] Error in handleCloseDocument:",r),f({type:"error",id:l.id,error:r instanceof Error?r.message:String(r)});}}function Ye(l){console.log("handleDestroy");for(let[,e]of N)try{if(c&&e.docPtr!==0){try{c.unregisterCallback(e.docPtr);}catch{}try{c.documentDestroy(e.docPtr);}catch{}}if(y)try{y.FS.unlink(e.filePath);}catch{}}catch{}if(N.clear(),v(),W){try{W.destroy();}catch{}W=null,c=null;}else if(c){try{c.destroy();}catch{}c=null;}if(y&&y.PThread?.terminateAllThreads)try{y.PThread.terminateAllThreads();}catch{}y=null,w=false,f({type:"ready",id:l.id}),setTimeout(()=>self.close(),100);}self.onmessage=async l=>{let e=l.data;switch(e.type){case "init":await Fe(e);break;case "convert":await We(e);break;case "getPageCount":await Ue(e);break;case "renderPreviews":await Ke(e);break;case "renderSinglePage":await Me(e);break;case "renderPageViaConvert":await $e(e);break;case "getDocumentInfo":await Be(e);break;case "getLokInfo":await Ve(e);break;case "editText":await ze(e);break;case "renderPageRectangles":await Ge(e);break;case "testLokOperations":await He(e);break;case "openDocument":await je(e);break;case "editorOperation":await Je(e);break;case "closeDocument":await Xe(e);break;case "destroy":Ye(e);break}};self.postMessage({type:"loaded"});
})();//# sourceMappingURL=browser.worker.global.js.map
//# sourceMappingURL=browser.worker.global.js.map